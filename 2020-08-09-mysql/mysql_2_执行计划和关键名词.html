<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>MySql 调优(二) | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MySql 调优(二)</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MySql 调优(二)</h1><div class="post-meta">2020-08-09<span> | </span><span class="category"><a href="/categories/MySQL/">MySQL</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">1. 执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-id"><span class="toc-text">1.1 id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-select-type"><span class="toc-text">1.2 select_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-table"><span class="toc-text">1.3 table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-type"><span class="toc-text">1.4 type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-possible-keys"><span class="toc-text">1.5 possible_keys</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-key"><span class="toc-text">1.6 key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-key-len"><span class="toc-text">1.7 key_len</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-ref"><span class="toc-text">1.8 ref</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-rows"><span class="toc-text">1.9 rows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-10-extra"><span class="toc-text">1.10 extra</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-text">2. 索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%B4%A2%E5%BC%95%E4%BC%98%E7%82%B9"><span class="toc-text">2.1 索引优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%B4%A2%E5%BC%95%E7%9A%84%E7%94%A8%E5%A4%84"><span class="toc-text">2.2 索引的用处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text">2.3 索引的分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%B4%A2%E5%BC%95%E9%87%87%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">2.4 索引采用的数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="toc-text">1. 哈希表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-B-%E6%A0%91"><span class="toc-text">2. B+ 树</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3%E5%90%8D%E8%AF%8D"><span class="toc-text">2.5 索引相关名词</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9B%9E%E8%A1%A8"><span class="toc-text">1. 回表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-text">2. 覆盖索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99"><span class="toc-text">3. 最左匹配原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8-index-condition-pushdown"><span class="toc-text">4. 索引下推( index condition pushdown  )</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%97%AE%E9%A2%98"><span class="toc-text">3. 问题</span></a></li></ol></div></div><div class="post-content"><ul>
<li>执行计划</li>
<li>索引的数据结构和基本概念</li>
</ul>
<a id="more"></a>

<h2 id="1-执行计划"><a href="#1-执行计划" class="headerlink" title="1. 执行计划"></a>1. 执行计划</h2><p>官网地址： <a href="https://dev.mysql.com/doc/refman/5.6/en/explain-output.html">https://dev.mysql.com/doc/refman/5.6/en/explain-output.html</a> </p>
<table>
<thead>
<tr>
<th align="center">Column</th>
<th align="center">Meaning</th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td align="center">The <code>SELECT</code> identifier</td>
</tr>
<tr>
<td align="center">select_type</td>
<td align="center">The <code>SELECT</code> type</td>
</tr>
<tr>
<td align="center">table</td>
<td align="center">The table for the output row</td>
</tr>
<tr>
<td align="center">partitions</td>
<td align="center">The matching partitions</td>
</tr>
<tr>
<td align="center">type</td>
<td align="center">The join type</td>
</tr>
<tr>
<td align="center">possible_keys</td>
<td align="center">The possible indexes to choose</td>
</tr>
<tr>
<td align="center">key</td>
<td align="center">The index actually chosen</td>
</tr>
<tr>
<td align="center">key_len</td>
<td align="center">The length of the chosen key</td>
</tr>
<tr>
<td align="center">ref</td>
<td align="center">The columns compared to the index</td>
</tr>
<tr>
<td align="center">rows</td>
<td align="center">Estimate of rows to be examined</td>
</tr>
<tr>
<td align="center">filtered</td>
<td align="center">Percentage of rows filtered by table condition</td>
</tr>
<tr>
<td align="center">extra</td>
<td align="center">Additional information</td>
</tr>
</tbody></table>
<h3 id="1-1-id"><a href="#1-1-id" class="headerlink" title="1.1 id"></a>1.1 id</h3><p>1、id 相同，从上到下，依次执行</p>
<p>2、id 不同，id 越大优先级越高</p>
<p>​    <code>explain select * from ip_test where id in (select max(id) from ip_test);</code></p>
<h3 id="1-2-select-type"><a href="#1-2-select-type" class="headerlink" title="1.2 select_type"></a>1.2 select_type</h3><ul>
<li>SIMPLE：简单查询</li>
<li>primary：最外层查询</li>
<li>union</li>
<li>dependent union</li>
<li>union result</li>
<li>subquery</li>
<li>dependent subquery</li>
<li>derived</li>
<li>uncachable subquery</li>
</ul>
<h3 id="1-3-table"><a href="#1-3-table" class="headerlink" title="1.3 table"></a>1.3 table</h3><p>对应行正在访问哪一个表，表名或者别名。</p>
<h3 id="1-4-type"><a href="#1-4-type" class="headerlink" title="1.4 type"></a>1.4 type</h3><p><strong>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</strong> </p>
<p>一般情况下，<strong>得保证查询至少达到range级别，最好能达到ref</strong></p>
<ul>
<li><p>all：全表扫描</p>
</li>
<li><p>index：全索引扫描。查询时覆盖索引；使用了索引进行排序。其实也是全表扫描，只是可能用到覆盖索引。</p>
</li>
<li><p>range：利用索引查询的时候限制了范围，避免了 index 的全索引扫描。<code>=,&lt;&gt;,&gt;,&gt;=,&lt;,&lt;=, is null,between,like,in()</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_column = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_column <span class="keyword">BETWEEN</span> <span class="number">10</span> <span class="keyword">and</span> <span class="number">20</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_column <span class="keyword">IN</span> (<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>);</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> key_part1 = <span class="number">10</span> <span class="keyword">AND</span> key_part2 <span class="keyword">IN</span> (<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>index_subquery：利用索引来关联子查询，不再扫描全表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value IN (<span class="keyword">SELECT</span> key_column <span class="keyword">FROM</span> single_table <span class="keyword">WHERE</span> some_expr)</span><br></pre></td></tr></table></figure>
</li>
<li><p>unique_subquery：和 index_subquery 类似，使用的是唯一索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value IN (<span class="keyword">SELECT</span> primary_key <span class="keyword">FROM</span> single_table <span class="keyword">WHERE</span> some_expr)</span><br></pre></td></tr></table></figure>
</li>
<li><p>index_merge：多个索引组合使用</p>
</li>
<li><p>ref_or_null：既需要关联条件，也需要 null</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ref_table</span><br><span class="line"><span class="keyword">WHERE</span> key_column=expr <span class="keyword">OR</span> key_column <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ref：使用了<strong>非唯一索引</strong>进行数据的查找</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name <span class="keyword">WHERE</span> primary_key=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> primary_key_part1=<span class="number">1</span> <span class="keyword">AND</span> primary_key_part2=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>eq_ref：使用唯一索引进行数据查找（primary kye 或者 unique not null index）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ref_table,other_table</span><br><span class="line"><span class="keyword">WHERE</span> ref_table.key_column=other_table.column;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ref_table,other_table</span><br><span class="line"><span class="keyword">WHERE</span> ref_table.key_column_part1=other_table.column</span><br><span class="line"><span class="keyword">AND</span> ref_table.key_column_part2=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>const：这个表至多有一个匹配行（主键索引或者唯一索引加了等于条件）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name <span class="keyword">WHERE</span> primary_key=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name</span><br><span class="line"><span class="keyword">WHERE</span> primary_key_part1=<span class="number">1</span> <span class="keyword">AND</span> primary_key_part2=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>system：表只有一行记录</p>
</li>
</ul>
<p>all -&gt; index -&gt; range -&gt; ref -&gt;const</p>
<h3 id="1-5-possible-keys"><a href="#1-5-possible-keys" class="headerlink" title="1.5 possible_keys"></a>1.5 possible_keys</h3><p>显示可能应用在这张表中的索引，一个或多个；查询涉及到的字段上若存在索引，则该索引将被列出，但是不一定被查询实际使用。</p>
<h3 id="1-6-key"><a href="#1-6-key" class="headerlink" title="1.6 key"></a>1.6 key</h3><p>实际使用的索引，如果为 null，则没有使用索引。</p>
<h3 id="1-7-key-len"><a href="#1-7-key-len" class="headerlink" title="1.7 key_len"></a>1.7 key_len</h3><p>索引中使用的字节数，在不损失精度的情况下，<strong>长度越短越好</strong></p>
<h3 id="1-8-ref"><a href="#1-8-ref" class="headerlink" title="1.8 ref"></a>1.8 ref</h3><p>显示索引的哪一列被使用了？</p>
<h3 id="1-9-rows"><a href="#1-9-rows" class="headerlink" title="1.9 rows"></a>1.9 rows</h3><p>大致估算找出所需记录需要读取的行数。不影响结果的情况下，越少越好。</p>
<h3 id="1-10-extra"><a href="#1-10-extra" class="headerlink" title="1.10 extra"></a>1.10 extra</h3><ul>
<li>using filesort：无法利用索引进行排序，只能利用排序算法进行排序，会消耗额外的位置</li>
<li>using temporary：建立临时表来保存中间结果，查询完成之后把临时表删除</li>
<li>using index：当前查询走<strong>覆盖索引</strong>，不用回表。</li>
<li>using where：使用 where 进行条件过滤</li>
</ul>
<h2 id="2-索引优化"><a href="#2-索引优化" class="headerlink" title="2. 索引优化"></a>2. 索引优化</h2><h3 id="2-1-索引优点"><a href="#2-1-索引优点" class="headerlink" title="2.1 索引优点"></a>2.1 索引优点</h3><ol>
<li>大大减少服务器需要扫描的数据量</li>
<li>帮助服务器避免排序和临时表</li>
<li>将随机 IO 变成顺序 IO？</li>
</ol>
<h3 id="2-2-索引的用处"><a href="#2-2-索引的用处" class="headerlink" title="2.2 索引的用处"></a>2.2 索引的用处</h3><ol>
<li>快速查找匹配 where 子句的行</li>
<li>如果可以在多个索引中进行选择，会自动选择扫描最少行的索引</li>
<li>如果表具有多列索引，则优化器可以使用索引的任何最左前缀来查找行</li>
<li>当有表连接的时候，从其他表检索行数据？</li>
<li>查找特定索引列的 min 或 max 值</li>
<li>如果排序或分组时在可用索引的最左前缀上完成的，则对表进行排序和分组？</li>
<li>在某些情况下，可以优化查询以检索值而无需查询数据行。覆盖索引。</li>
</ol>
<h3 id="2-3-索引的分类"><a href="#2-3-索引的分类" class="headerlink" title="2.3 索引的分类"></a>2.3 索引的分类</h3><ol>
<li><p>主键索引</p>
<p>如果没有特殊需求，尽量选择自增主键(自增锁实现)。因为自增主键，插入数据维护索引时，一直往后添加元素就行，但是如果不是自增，可能会在中间插入元素，如果要插入的位置所在的页刚好满了，就会产生<strong>页分裂</strong>问题，一来可能浪费空间，二来会产生不必要的磁盘 I/O。</p>
</li>
<li><p>唯一索引：索引列的所有值都只能出现一次，即必须唯一，值可以为空。不需要回表？</p>
</li>
<li><p>普通索引：不走覆盖索引(两遍遍历B+树优化为一次)的话会回表。</p>
</li>
<li><p>全文索引：倒排索引。索引类型为 fulltext。全文索引可以在 varchar、char、text 类型的列上创建。</p>
</li>
<li><p>组合索引（不是一种类型）：最左匹配</p>
<p>注意索引的顺序会影响查询，同时需要考虑如何更好的满足排序和分组。</p>
<p>使用范围查询，可以走索引，但是范围查询后面的字段索引失效。</p>
<p>name,age、age 和 age,name、name 好。结合工作来说明。</p>
</li>
</ol>
<h3 id="2-4-索引采用的数据结构"><a href="#2-4-索引采用的数据结构" class="headerlink" title="2.4 索引采用的数据结构"></a>2.4 索引采用的数据结构</h3><h4 id="1-哈希表"><a href="#1-哈希表" class="headerlink" title="1. 哈希表"></a>1. 哈希表</h4><ul>
<li>基于哈希表实现的索引，只有精确匹配索引所有列的查询才有效果</li>
<li>在 MySQL 中，只有 memory 的存储引擎显示支持哈希索引</li>
<li>哈希索引自身只需存储对应的 hash 值，所以所有结构十分紧凑，所以查找速度非常快</li>
</ul>
<p>哈希索引的限制：</p>
<ol>
<li><strong>无法覆盖索引：</strong>哈希索引中只包含哈希值和行指针，不存储字段值，索引肯定会回表，无法覆盖索引。</li>
<li><strong>无法排序：</strong>哈希索引数据不是按照索引值顺序存储的，无法进行排序</li>
<li><strong>无法部分列匹配查找：</strong>哈希索引不支持部分列匹配查找，哈希索引使用索引列的全部内容来计算哈希值</li>
<li><strong>无法范围查询：</strong>哈希索引支持等值比较查询。不支持任何范围查询</li>
<li><strong>哈希冲突问题：</strong>访问哈希索引的数据非常快，除非有很多哈希冲突。当出现哈希冲突的时候，存储引擎必须遍历链表中所有行指针，逐行进行比较，直到找到所有符合条件的行</li>
<li><strong>哈希冲突问题：</strong>哈希冲突比较多的话，维护的成本也会很高，因为链表很长。</li>
</ol>
<p><strong>如何避免 hash 冲突？</strong></p>
<ul>
<li>扰动函数</li>
<li>不要直接用 %（取模）</li>
</ul>
<h4 id="2-B-树"><a href="#2-B-树" class="headerlink" title="2. B+ 树"></a>2. B+ 树</h4><p>二叉树</p>
<ul>
<li>不平衡</li>
<li>节点深</li>
</ul>
<p>二叉搜索树</p>
<p>平衡二叉树(AVL)</p>
<ul>
<li><p>真正意义上的平衡树，最高子树和最低子树高度之差不能超过 1</p>
</li>
<li><p>所以插入时会进行一次至多次旋转，严重影响性能</p>
</li>
<li><p>查询速度块，修改、删除慢</p>
</li>
</ul>
<p>红黑树</p>
<ul>
<li><p>基于 AVL 树的一个升级，损失了部分查询的性能，来提升插入的性能</p>
</li>
<li><p>最低子树跟最高子树只差小于 2 倍即可</p>
</li>
<li><p>在插入时旋转次数变少而且加入了变色的特性，来满足插入和查询性能的平衡</p>
</li>
<li><p>平衡修改、删除效率</p>
</li>
</ul>
<p>这些二叉树，最终都会由<strong>于节点过深导致 IO 次数过多</strong>，影响数据读取的效率，所以不合适。</p>
<p>B 树（多叉树）：</p>
<ol>
<li><p>所有键值分布在整棵树中</p>
</li>
<li><p>搜索有可能在非叶子节点结束</p>
</li>
<li><p>每个节点最多拥有 m 个子树</p>
</li>
<li><p>根节点至少有 2 个子树   </p>
</li>
<li><p>分支节点至少拥有 m/2 棵子树(除掉根节点和叶子节点都是分支节点)</p>
</li>
<li><p>所有<strong>叶子节点都在同一层</strong>，每个节点最多可以有 m-1 个 key，并且以<strong>升序</strong>排列</p>
<p>每个节点都有 key，同时和包含 data，而每个页存储的空间是有限的，如果 data 比较大的话，会导致每个节点存储的 key 数量变小。大量空间用来存 data 了，三层的 B 数只能存 4096 kb 数据。</p>
<p><img src="../../images/mysql/2/B%E6%A0%91.png"></p>
</li>
</ol>
<p><strong>B+ 树</strong>：</p>
<p>对 B 树进行优化</p>
<ol>
<li>每个节点可以包含更多的元素，这样可以降低树的高度；将数据的范围变为多个区间，区间越多，数据检索越快</li>
<li>非叶子节点存储 key，叶子节点存储 key 和数据</li>
<li>叶子节点两两指针互相连接（符合磁盘的预读特性），顺序查询性能更高</li>
</ol>
<p><img src="../../images/mysql/2/B+%E6%A0%91.png"></p>
<p>B+ 树上有两个头指针，一个指向根节点，另一个指向关键字最小的叶子节点，而且所有叶子节点之间是一种链式环结构。因此可以对 B+ 树进行两种查询运算：</p>
<ol>
<li>对于主键的范围查找和分页查找；</li>
<li>从根节点开始，进行随机查找。</li>
</ol>
<p>InnoDB 是通过 B+ 树结构对主键创建索引，然后叶子节点中存储记录，如果没有主键，那么会选择唯一键，如果没有唯一键，那么会生成一个 6 位的 row_id 来作为主键。</p>
<p><img src="../../images/mysql/2/InnoDB%E5%8F%B6%E5%AD%90%E8%8A%82%E7%82%B9%E7%9B%B4%E6%8E%A5%E6%94%BE%E7%BD%AE%E6%95%B0%E6%8D%AE.png"></p>
<p><strong>如果创建索引的键是其他字段，那么在叶子节点中存储的是该记录的主键，然后通过主键索引找到对应的记录，叫做回表。</strong></p>
<p><img src="../../images/mysql/2/%E6%99%AE%E9%80%9A%E5%AD%97%E6%AE%B5%E7%B4%A2%E5%BC%95.png"></p>
<p>MyISAM 索引文件和数据文件分开存放（非聚簇索引）。</p>
<h3 id="2-5-索引相关名词"><a href="#2-5-索引相关名词" class="headerlink" title="2.5 索引相关名词"></a>2.5 索引相关名词</h3><h4 id="1-回表"><a href="#1-回表" class="headerlink" title="1. 回表"></a>1. 回表</h4><p>普通索引叶子节点没有存行记录，存储的是主键。所以需要回去再找<strong>主键索引树</strong>，这就是回表。</p>
<h4 id="2-覆盖索引"><a href="#2-覆盖索引" class="headerlink" title="2. 覆盖索引"></a>2. 覆盖索引</h4><p>基本介绍：</p>
<ol>
<li><p>当查询的列在叶子节点已经有了，就不需要再查询一遍主键索引树了，这就是覆盖索引。</p>
</li>
<li><p>不是所有类型的索引都可以称为覆盖索引，覆盖索引必须要存储索引列的值。</p>
</li>
<li><p>不同的存储引擎实现覆盖索引的方式不同，Innodb 是叶子节点存了行数据，MyISam 叶子节点存的是内存地址。</p>
</li>
<li><p>不是所有的搜索引擎都支持覆盖索引，memory 不支持覆盖索引。</p>
</li>
</ol>
<p>优势：</p>
<ol>
<li>索引条目通常远小于数据行大小，覆盖索引只需要读取索引，所以可以极大减少数据的访问量，极大的减少 IO 访问。</li>
<li>一些存储引擎比如 MYISAM 在内存中只缓存索引，数组依赖操作系统来缓存，如果不走覆盖索引，访问数据需要调用系统调用，可能会导致严重性能问题。</li>
<li>InnoDB 为聚簇索引，覆盖索引对 InnoDB 的支持特别有用</li>
</ol>
<p>实际操作：</p>
<ol>
<li>explain 的 extra 的值为 <code>using index</code> 时表示使用了覆盖索引。</li>
</ol>
<h4 id="3-最左匹配原则"><a href="#3-最左匹配原则" class="headerlink" title="3. 最左匹配原则"></a>3. 最左匹配原则</h4><p>根据 name、age 建立组合索引。<code>where name = ? and age = ?</code> 可以匹配索引，但是 <code>where age = ？</code> 不会走索引。可以在建立组合索引时，name、age 互换。如果单独建立 name、age 两个索引，会涉及到索引合并优化。</p>
<h4 id="4-索引下推-index-condition-pushdown"><a href="#4-索引下推-index-condition-pushdown" class="headerlink" title="4. 索引下推( index condition pushdown  )"></a>4. 索引下推( index condition pushdown  )</h4><p>过滤二级索引的同时，<strong>判断是否可以先进行 where 条件过滤再进行索引回表查询，如果条件中包含了组合索引中的列，就可以索引下推</strong>，也就是说提前执行 where 的部分过滤操作，在某些场景下，可以大大减少回表次数，从而提升整体性能。 和 sql 查询的<strong>谓词下推</strong>类似， <strong>始终将过滤表达式尽可能移至靠近数据源的位置。</strong></p>
<p>执行计划 extra 提示 Using index condition</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭索引下推</span></span><br><span class="line"><span class="keyword">SET</span> optimizer_switch = <span class="string">&#x27;index_condition_pushdown=off&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> icp_test(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>),</span><br><span class="line">  age <span class="built_in">int</span>(<span class="number">2</span>),</span><br><span class="line">  address <span class="built_in">varchar</span>(<span class="number">40</span>)  </span><br><span class="line">) <span class="keyword">engine</span> <span class="keyword">innodb</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_name_age(<span class="keyword">name</span>, age);</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> icp_test <span class="keyword">where</span>  <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">&#x27;陈%&#x27;</span> <span class="keyword">and</span> age=<span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p> 1、innodb 引擎的表，索引下推只能用于二级索引（除了聚簇索引之外的索引都是二级索引(辅助索引)，每一个二级的记录中除了索引列的值之外，还包含主健值。通过二级索引查询首先查到是主键值，然后InnoDB再根据查到的主键值通过主键/聚簇索引找到相应的数据块。）。innodb的主键索引(聚簇索引)树叶子结点上保存的是全行数据，所以这个时候索引下推并不会起到减少查询全行数据的效果。<br>2、索引下推一般可用于所求查询字段（select列）不全是联合索引的字段，查询条件为多条件查询且查询条件子句（where/order by）字段全是联合索引。 </p>
<h2 id="3-问题"><a href="#3-问题" class="headerlink" title="3. 问题"></a>3. 问题</h2><p>1、一、二、三四范式？</p>
<p>2、另一个从父表冗余数据到子表的理由是<strong>排序</strong>的需要？索引排序？</p>
<p>3、通用的主键策略？：减少需要编写的源码数量？减少系统的总体拥有成本？</p>
<p>4、索引将随机 IO 变成顺序 IO？</p>
<p>5、当有表连接的时候，从其他表检索行数据？</p>
<p>6、如果排序或分组时在可用索引的最左前缀上完成的，则对表进行排序和分组？</p>
<p>7、InnoDB 为聚簇索引，覆盖索引对 InnoDB 的支持特别有用？</p>
<p>8、B+树、哈希表</p>
</div><div class="tags"><a href="/tags/MySQL/"><i class="fa fa-tag"></i>MySQL</a></div><div class="post-nav"><a class="pre" href="/2020-08-10-mysql/mysql_3_%E7%B4%A2%E5%BC%95%E5%8C%B9%E9%85%8D%E5%92%8C%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E7%9B%91%E6%8E%A7.html">MySql 调优(三)</a><a class="next" href="/2020-08-05-mysql/mysql_1_%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%92%8C%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BC%98%E5%8C%96.html">MySql 调优(一)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%8A%80%E6%9C%AF/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%89%E4%BB%96/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%83%E6%83%85/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A0%E5%85%B3%E6%8A%80%E6%9C%AF/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%96%AF%E7%8B%82-Java-%E8%AE%B2%E4%B9%89/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/%E5%BF%83%E6%83%85/" style="font-size: 15px;">心情</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/%E5%90%89%E4%BB%96/" style="font-size: 15px;">吉他</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">多线程</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a> <a href="/tags/%E6%97%A0%E5%85%B3%E6%8A%80%E6%9C%AF/" style="font-size: 15px;">无关技术</a> <a href="/tags/%E7%96%AF%E7%8B%82-Java-%E8%AE%B2%E4%B9%89/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">网络</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">前端</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>