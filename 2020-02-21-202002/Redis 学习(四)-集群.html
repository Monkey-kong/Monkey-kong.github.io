<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>Redis 学习(四)-主从复制、高可用、集群 | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis 学习(四)-主从复制、高可用、集群</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Redis 学习(四)-主从复制、高可用、集群</h1><div class="post-meta">Feb 21, 2020<span> | </span><span class="category"><a href="/categories/数据库/">数据库</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-为什么要主从复制、高可用和集群？"><span class="toc-number">1.</span> <span class="toc-text">1. 为什么要主从复制、高可用和集群？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-单机、单节点、单实例问题"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 单机、单节点、单实例问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-尝试解决单节点问题-一变多"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 尝试解决单节点问题-一变多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-尝试解决数据一致性问题"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 尝试解决数据一致性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-强一致性-同步阻塞"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.3.1 强一致性-同步阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-弱一致性-异步非阻塞"><span class="toc-number">1.3.2.</span> <span class="toc-text">1.3.2 弱一致性-异步非阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-最终一致性"><span class="toc-number">1.3.3.</span> <span class="toc-text">1.3.3 最终一致性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-尝试解决故障转移问题"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 尝试解决故障转移问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Redis-主从复制"><span class="toc-number">2.</span> <span class="toc-text">2. Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Redis-主从复制原理"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Redis 主从复制原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Redis-主从复制如何处理过期"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 Redis 主从复制如何处理过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Redis-高可用"><span class="toc-number">2.3.</span> <span class="toc-text">3. Redis 高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-主从集群和哨兵"><span class="toc-number">3.</span> <span class="toc-text">1. 主从集群和哨兵</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-twemproxy"><span class="toc-number">4.</span> <span class="toc-text">2. twemproxy</span></a></li></ol></div></div><div class="post-content"><p>Redis 主从复制、高可用和集群学习笔记。<br><a id="more"></a></p>
<h2 id="1-为什么要主从复制、高可用和集群？"><a href="#1-为什么要主从复制、高可用和集群？" class="headerlink" title="1. 为什么要主从复制、高可用和集群？"></a>1. 为什么要主从复制、高可用和集群？</h2><h3 id="1-1-单机、单节点、单实例问题"><a href="#1-1-单机、单节点、单实例问题" class="headerlink" title="1.1 单机、单节点、单实例问题"></a>1.1 单机、单节点、单实例问题</h3><ol>
<li>单点故障问题（可用性），就是说一台机器挂了，整个系统就挂了</li>
<li>单据内存容量有限，就是说一个 Redis 存不了很多数据</li>
<li>压力大，包括 socket io 压力，cpu 操作等</li>
</ol>
<h3 id="1-2-尝试解决单节点问题-一变多"><a href="#1-2-尝试解决单节点问题-一变多" class="headerlink" title="1.2 尝试解决单节点问题-一变多"></a>1.2 尝试解决单节点问题-一变多</h3><ol>
<li>为了解决单点故障问题，可以把 Redis 一个实例复制为多个实例，当一个实例挂了时，另外的实例可以顶上，这叫做主从复制。</li>
<li>为了解决容量问题，可以把数据根据业务或者根据某种规则，把数据尽量均匀的存在多个 Redis 实例上，这叫做数据分区。</li>
</ol>
<p><img src="../../images/redis4/解决单节点问题.png" alt=""></p>
<p>但是一变多带来了另外的问题</p>
<ol>
<li>各个库之间如何保证数据的一致呢？这就是数据一致性问题。</li>
<li>当主库挂了如何让从库顶上去呢？这就是故障转移问题。</li>
</ol>
<h3 id="1-3-尝试解决数据一致性问题"><a href="#1-3-尝试解决数据一致性问题" class="headerlink" title="1.3 尝试解决数据一致性问题"></a>1.3 尝试解决数据一致性问题</h3><h4 id="1-3-1-强一致性-同步阻塞"><a href="#1-3-1-强一致性-同步阻塞" class="headerlink" title="1.3.1 强一致性-同步阻塞"></a>1.3.1 强一致性-同步阻塞</h4><p><img src="../../images/redis4/强一致性.png" alt=""></p>
<h4 id="1-3-2-弱一致性-异步非阻塞"><a href="#1-3-2-弱一致性-异步非阻塞" class="headerlink" title="1.3.2 弱一致性-异步非阻塞"></a>1.3.2 弱一致性-异步非阻塞</h4><p><img src="../../images/redis4/弱一致性.png" alt=""></p>
<h4 id="1-3-3-最终一致性"><a href="#1-3-3-最终一致性" class="headerlink" title="1.3.3 最终一致性"></a>1.3.3 最终一致性</h4><p><img src="../../images/redis4/最终一致性.png" alt=""></p>
<h3 id="1-4-尝试解决故障转移问题"><a href="#1-4-尝试解决故障转移问题" class="headerlink" title="1.4 尝试解决故障转移问题"></a>1.4 尝试解决故障转移问题</h3><p>现在 Redis 有一个主库和多个从库，我们希望当主库出现问题时，有某个从库自动承担起主库的职责来继续提供服务。那么有两个问题：</p>
<ol>
<li>如何知道主库是否出现问题了？</li>
<li>让让哪个从库来代替主库呢？</li>
</ol>
<p>为了解决上面两个问题，我们可以弄一套监控程序来监控主库，时刻监控主库是否出现问题了。一旦发现主库出问题了，就让从库来代替主库。</p>
<p>那么问题又来了，首先这套监控程序肯定不能是一个，因为一个人说了不算，谁知道是你自己出问题了还是主库出问题了，所以这个监控程序需要集群。</p>
<p>集群之后还是有问题，假设我们有两个监控程序，当一个说主库挂了，另外一个说主库正常，这就是常说的<strong>脑裂问题</strong>。</p>
<p>为了解决脑裂问题，出现了势力值的概念，就是说只有达到势力值了，才能听你的，比如有三个监控程序，势力值是 2，就是说只要两个监控程序说你挂了，那就认定你挂了，所以这个势力值一般是 n/2 + 1，也就是<strong>过半原则</strong>。</p>
<p>同时一般监控程序的个数配置奇数个比较好，奇数台风险更小，成本也更小。？？？</p>
<h2 id="2-Redis-主从复制"><a href="#2-Redis-主从复制" class="headerlink" title="2. Redis 主从复制"></a>2. Redis 主从复制</h2><p>就是 1.2 图中的 X 轴，为了解决单点故障问题。</p>
<p>Redis 主从复制带来的数据一致性问题的解决方案采用的第二种，就是异步非阻塞模式。</p>
<h3 id="2-1-Redis-主从复制原理"><a href="#2-1-Redis-主从复制原理" class="headerlink" title="2.1 Redis 主从复制原理"></a>2.1 Redis 主从复制原理</h3><ol>
<li><p>slave 发送 offset（偏移量）给 master</p>
</li>
<li><p>master 验证增量队列是否还没有满，验证 offset 是否正常，如果都正常则执行增量复制。</p>
<p>否则执行全量复制。增量队列的大小通过  <strong>repl-backlog-size 1mb</strong>  配置。</p>
</li>
<li><p>如果全量复制，有两种方式，一种是走磁盘，即 master 先在 磁盘建一个 RDB 文件，然后读到内存发给 slave；或者 master 直接发送 RDB 到 slave。通过  <strong>repl-diskless-sync no</strong> 配置。最后 master 把 RDB 之后新产生的缓存指令以指令流形式发给 slave。</p>
</li>
</ol>
<p><img src="../../images/redis4/主从复制原理.png" alt=""></p>
<h3 id="2-2-Redis-主从复制如何处理过期"><a href="#2-2-Redis-主从复制如何处理过期" class="headerlink" title="2.2 Redis 主从复制如何处理过期"></a>2.2 Redis 主从复制如何处理过期</h3><p>slave 不会让 key 过期，而是等待 master 让 key 过期。 当一个 master 让一个 key 到期（或由于 LRU 算法将之驱逐）时，它会合成一个 DEL 命令并传输到所有的 slave。 </p>
<h3 id="3-Redis-高可用"><a href="#3-Redis-高可用" class="headerlink" title="3. Redis 高可用"></a>3. Redis 高可用</h3><h2 id="1-主从集群和哨兵"><a href="#1-主从集群和哨兵" class="headerlink" title="1. 主从集群和哨兵"></a>1. 主从集群和哨兵</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">// 1. 准备：启动 3 个 redis 实例</div><div class="line"><span class="built_in">cd</span> ~</div><div class="line">mkdir redistest</div><div class="line"><span class="built_in">cd</span> redistest</div><div class="line">cp /etc/redis/* ../../</div><div class="line">-- 修改配置文件：1. 关闭后台线程执行 2. 关闭日志文件 3. 关闭 AOF</div><div class="line">vim 6379|6380|6380.conf</div><div class="line">// 删除持久化目录内容</div><div class="line"><span class="built_in">cd</span> /var/lib/redis/6379|6380|6381</div><div class="line">rm -rf ../../*</div><div class="line">redis-server ../../6379.conf</div><div class="line">redis-cli</div><div class="line"><span class="built_in">set</span> k1 1</div><div class="line"></div><div class="line">redis-server ../../6380.conf --replicaof 127.0.0.1 6379</div><div class="line"></div><div class="line">// 2. 主从复制</div><div class="line">// 2.1 主库数据自动同步到从库</div><div class="line">redis-cli -p 6380</div><div class="line">-- 有 k1，说明同步了 6379</div><div class="line">keys *</div><div class="line">-- 报错，默认从库只读，可以配置</div><div class="line"><span class="built_in">set</span> k1 1</div><div class="line"></div><div class="line">// 2.2 从库数据被删除</div><div class="line">redis-server ../../6381.conf</div><div class="line">reids-cli -p 6381</div><div class="line"><span class="built_in">set</span> k2 2</div><div class="line">replicaof 127.0.0.1 6379</div><div class="line">-- 获取不到，从库数据被删除</div><div class="line">get k2 </div><div class="line"></div><div class="line">// 2.3 从库挂了，重新连接，可以取到主库新数据，没有重新 RDB</div><div class="line">-- 关闭 6380</div><div class="line">-- 主库存数据</div><div class="line"><span class="built_in">set</span> k2 2</div><div class="line"><span class="built_in">set</span> k3 3</div><div class="line">-- 启动 6380</div><div class="line">get k2 k3</div><div class="line"></div><div class="line">// 2.4 AOF 开启。从库挂了，重新连接，每次都会重新 RDB</div><div class="line">-- 关闭 6380</div><div class="line">-- 主库存数据</div><div class="line"><span class="built_in">set</span> k4 2</div><div class="line"><span class="built_in">set</span> k5 3</div><div class="line">-- 开启 AOF</div><div class="line">appendonly yes</div><div class="line">-- 启动 6380</div><div class="line">-- 从启动日志可以看到执行了 BGSAVE</div><div class="line">get k3 k4</div><div class="line"></div><div class="line">// 2.5 主库挂了，需要人工重新指定主库和从库</div><div class="line">-- 关闭 6379</div><div class="line">-- 6380 取消追随</div><div class="line">replicaof no one</div><div class="line">-- 6381 追随 6380</div><div class="line">replicaof 127.0.0.1 6380</div><div class="line"></div><div class="line">// 2.6 哨兵</div><div class="line">-- 关闭所有实例和客户端</div><div class="line">vim 26379|26380|26380.conf/</div><div class="line">	port 26379</div><div class="line">	sentinel monitor mymaster 127.0.0.1 6379 2</div><div class="line">-- 启动 3 个 server</div><div class="line">-- 启动 3 个哨兵</div><div class="line">redis-server ../../26379.conf --sentinel</div><div class="line">-- 停止 6379，过一段时间(因为有一个延时，防止网络问题)发现哨兵自动做了故障转移</div><div class="line">-- 从日志看出，哨兵选举的主库是 6380；6379 自动变为从库</div><div class="line">redis-cli -p 6380</div><div class="line"><span class="built_in">set</span> k1 aaa</div><div class="line">redis-cli -p 6381</div><div class="line">get k1</div><div class="line">-- 哨兵会自动修改自己的配置文件</div><div class="line"><span class="built_in">cd</span> ~/redistest</div><div class="line">vim 26379.conf</div></pre></td></tr></table></figure>
<p><strong>问题：</strong>主知道从，是因为从追随主时就知道了；但是一个哨兵是如何知道其他哨兵的？</p>
<p><strong>答案：</strong>通过 Redis 自带的发布订阅实现。PSUBSCRIBE *，可以看到哨兵的交互信息。</p>
<h2 id="2-twemproxy"><a href="#2-twemproxy" class="headerlink" title="2. twemproxy"></a>2. twemproxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">autoreconf 版本太低</div><div class="line">yum search autoconf</div><div class="line">// 常识，yum 装的软件来自仓库，可能你现在系统自带的仓库偏低</div><div class="line">millior.aliyun.com</div><div class="line">epel</div><div class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</div><div class="line">wget -0 /etc/...</div><div class="line">yum clean all</div><div class="line">yum search autoconf</div><div class="line">yum install autoconf268</div></pre></td></tr></table></figure>
<p>&lt;% for (var link in site.data.menu) { %&gt;<br>  <a href="<%= site.data.menu[link] %>"> &lt;%= link %&gt; </a><br>&lt;% } %&gt;</p>
</div><div class="tags"><a href="/tags/Redis/">Redis</a></div><div class="post-nav"><a class="pre" href="/2020-02-22-202002/NIO原理.html">NIO 原理</a><a class="next" href="/2020-02-20-202002/Redis 学习(三)-持久化.html">Redis 学习(三)-持久化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/加解密技术/">加解密技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/心情/">心情</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息队列/">消息队列</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020-02-22-202002/NIO原理.html">NIO 原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020-02-21-202002/Redis 学习(四)-集群.html">Redis 学习(四)-主从复制、高可用、集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2020-02-20-202002/Redis 学习(三)-持久化.html">Redis 学习(三)-持久化</a></li><li class="post-list-item"><a class="post-list-link" href="/2020-02-19-202002/Redis 学习(二)-基本功能.html">Redis 学习(二)-管道、发布/订阅、事务、modules、过期</a></li><li class="post-list-item"><a class="post-list-link" href="/2020-02-18-202002/Redis 学习(一)-基本指令.html">Redis 学习(一)-概述、安装、类型、指令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-09-201911/2019-11-09_mqtt 学习笔记.html">mqtt 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-09-201911/2019-11-09_Kafka 学习笔记（一）.html">Kafka 学习笔记（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-07-201911/2019-11-07_云服务器的使用.html">云服务器的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-03-09-201609/2016-09-17_使用Hexo搭建个人技术博客.html">使用Hexo搭建个人技术博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-03-25-201803/2018-03-25_Oracle 基础（一）.html">Oracle 基础</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>