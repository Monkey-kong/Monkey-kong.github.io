<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>Redis 学习(四)-主从复制、高可用、集群 | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis 学习(四)-主从复制、高可用、集群</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Redis 学习(四)-主从复制、高可用、集群</h1><div class="post-meta">Feb 21, 2020<span> | </span><span class="category"><a href="/categories/数据库/">数据库</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-为什么要主从复制、高可用和集群？"><span class="toc-text">1. 为什么要主从复制、高可用和集群？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-单机、单节点、单实例问题"><span class="toc-text">1.1 单机、单节点、单实例问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-尝试解决单节点问题-一变多"><span class="toc-text">1.2 尝试解决单节点问题-一变多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-尝试解决数据一致性问题"><span class="toc-text">1.3 尝试解决数据一致性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-强一致性-同步阻塞"><span class="toc-text">1.3.1 强一致性-同步阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-弱一致性-异步非阻塞"><span class="toc-text">1.3.2 弱一致性-异步非阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-最终一致性"><span class="toc-text">1.3.3 最终一致性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-尝试解决故障转移问题"><span class="toc-text">1.4 尝试解决故障转移问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Redis-主从复制"><span class="toc-text">2. Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Redis-主从复制原理"><span class="toc-text">2.1 Redis 主从复制原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Redis-主从复制如何处理过期"><span class="toc-text">2.2 Redis 主从复制如何处理过期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Redis-高可用"><span class="toc-text">3. Redis 高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-启动-Sentinel"><span class="toc-text">3.1 启动 Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-配置-Sentinel"><span class="toc-text">3.1 配置 Sentinel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-主从复制和高可用练习"><span class="toc-text">4. 主从复制和高可用练习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Redis-集群"><span class="toc-text">5. Redis 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Redis-分区"><span class="toc-text">5.1 Redis 分区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分区基本概念"><span class="toc-text">分区基本概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分区实现方案"><span class="toc-text">分区实现方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分区缺点"><span class="toc-text">分区缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#持久化数据还是缓存"><span class="toc-text">持久化数据还是缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#预分片"><span class="toc-text">预分片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-分区实现"><span class="toc-text">Redis 分区实现</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>Redis 主从复制、高可用和集群学习笔记。<br><a id="more"></a></p>
<h2 id="1-为什么要主从复制、高可用和集群？"><a href="#1-为什么要主从复制、高可用和集群？" class="headerlink" title="1. 为什么要主从复制、高可用和集群？"></a>1. 为什么要主从复制、高可用和集群？</h2><h3 id="1-1-单机、单节点、单实例问题"><a href="#1-1-单机、单节点、单实例问题" class="headerlink" title="1.1 单机、单节点、单实例问题"></a>1.1 单机、单节点、单实例问题</h3><ol>
<li>单点故障问题（可用性），就是说一台机器挂了，整个系统就挂了</li>
<li>单据内存容量有限，就是说一个 Redis 存不了很多数据</li>
<li>压力大，包括 socket io 压力，cpu 操作等</li>
</ol>
<h3 id="1-2-尝试解决单节点问题-一变多"><a href="#1-2-尝试解决单节点问题-一变多" class="headerlink" title="1.2 尝试解决单节点问题-一变多"></a>1.2 尝试解决单节点问题-一变多</h3><ol>
<li>为了解决单点故障问题，可以把 Redis 一个实例复制为多个实例，当一个实例挂了时，另外的实例可以顶上，这叫做<strong>主从复制</strong>。</li>
<li>为了解决容量问题，可以把数据根据业务或者根据某种规则，把数据尽量均匀的存在多个 Redis 实例上，这叫做<strong>数据分区</strong>。</li>
</ol>
<p><img src="../../images/redis4/解决单节点问题.png" alt=""></p>
<p>但是主从复制的一变多带来了另外的问题</p>
<ol>
<li>各个库之间如何保证数据的一致呢？这就是<strong>数据一致性问题</strong>。</li>
<li>当主库挂了如何让从库顶上去呢？这就是<strong>故障转移问题</strong>。</li>
</ol>
<h3 id="1-3-尝试解决数据一致性问题"><a href="#1-3-尝试解决数据一致性问题" class="headerlink" title="1.3 尝试解决数据一致性问题"></a>1.3 尝试解决数据一致性问题</h3><h4 id="1-3-1-强一致性-同步阻塞"><a href="#1-3-1-强一致性-同步阻塞" class="headerlink" title="1.3.1 强一致性-同步阻塞"></a>1.3.1 强一致性-同步阻塞</h4><p><img src="../../images/redis4/强一致性.png" alt=""></p>
<h4 id="1-3-2-弱一致性-异步非阻塞"><a href="#1-3-2-弱一致性-异步非阻塞" class="headerlink" title="1.3.2 弱一致性-异步非阻塞"></a>1.3.2 弱一致性-异步非阻塞</h4><p><img src="../../images/redis4/弱一致性.png" alt=""></p>
<h4 id="1-3-3-最终一致性"><a href="#1-3-3-最终一致性" class="headerlink" title="1.3.3 最终一致性"></a>1.3.3 最终一致性</h4><p><img src="../../images/redis4/最终一致性.png" alt=""></p>
<h3 id="1-4-尝试解决故障转移问题"><a href="#1-4-尝试解决故障转移问题" class="headerlink" title="1.4 尝试解决故障转移问题"></a>1.4 尝试解决故障转移问题</h3><p>现在 Redis 有一个主库和多个从库，我们希望当主库出现问题时，有某个从库自动承担起主库的职责来继续提供服务。那么有两个问题：</p>
<ol>
<li>如何知道主库是否出现问题了？</li>
<li>让哪个从库来代替主库呢？</li>
</ol>
<p>为了解决上面两个问题，我们可以弄一套监控程序来监控主库，时刻监控主库是否出现问题了。一旦发现主库出问题了，就让从库来代替主库。</p>
<p>那么问题又来了，首先这套监控程序肯定不能是一个，因为一个人说了不算，谁知道是你自己出问题了还是主库出问题了，所以这个监控程序需要集群。</p>
<p>集群之后还是有问题，假设我们有两个监控程序，当一个说主库挂了，另外一个说主库正常，这就是常说的<strong>脑裂问题</strong>。</p>
<p>为了解决脑裂问题，出现了<strong>势力值</strong>的概念，就是说只有达到势力值了，才能听你的，比如有三个监控程序，势力值是 2，就是说只要两个监控程序说你挂了，那就认定你挂了，所以这个势力值一般是 n/2 + 1，也就是<strong>过半原则</strong>。</p>
<p>同时一般监控程序的个数配置奇数个比较好，因为奇数台风险更小，比如三台和四台，都只允许 1 台出现故障，因为再多一台出现故障就达不到势力值了，但是四台中有一台出现故障的概率更大。同时少一台成本也更小。</p>
<h2 id="2-Redis-主从复制"><a href="#2-Redis-主从复制" class="headerlink" title="2. Redis 主从复制"></a>2. Redis 主从复制</h2><p>就是 1.2 图中的 X 轴，为了解决单点故障问题。</p>
<p>Redis 主从复制带来的数据一致性问题的解决方案采用的第二种，就是<strong>异步非阻塞模式</strong>。所以 Redis 并不能保证数据的<strong>强一致性</strong>. 这意味这在实际中集群在特定的条件下可能会丢失写操作</p>
<p>还有网络分区也可能导致数据丢失：比如客户端和 Master 在一个区，另外的哨兵和 Slave 在另外一个分区，如果分区时间长了，足够把 Slave 推举为 Master，那么分区期间，客户端向原来 Master 写入的数据就丢失了。</p>
<h3 id="2-1-Redis-主从复制原理"><a href="#2-1-Redis-主从复制原理" class="headerlink" title="2.1 Redis 主从复制原理"></a>2.1 Redis 主从复制原理</h3><ol>
<li><p>slave 发送 offset（偏移量）给 master</p>
</li>
<li><p>master 验证增量队列是否还没有满，验证 offset 是否正常，如果都正常则执行增量复制。</p>
<p>否则执行全量复制。增量队列的大小通过  <strong>repl-backlog-size 1mb</strong>  配置。</p>
</li>
<li><p>如果全量复制，有两种方式，一种是走磁盘，即 master 先在磁盘建一个 RDB 文件，然后读到内存发给 slave；或者 master 直接发送 RDB 到 slave。通过  <strong>repl-diskless-sync no</strong> 配置。最后 master 把 RDB 之后新产生的缓存指令以指令流形式发给 slave。</p>
</li>
</ol>
<p><img src="../../images/redis4/主从复制原理.png" alt=""></p>
<h3 id="2-2-Redis-主从复制如何处理过期"><a href="#2-2-Redis-主从复制如何处理过期" class="headerlink" title="2.2 Redis 主从复制如何处理过期"></a>2.2 Redis 主从复制如何处理过期</h3><p>slave 不会让 key 过期，而是等待 master 让 key 过期。 当一个 master 让一个 key 到期（或由于 LRU 算法将之驱逐）时，它会合成一个 DEL 命令并传输到所有的 slave。 </p>
<h2 id="3-Redis-高可用"><a href="#3-Redis-高可用" class="headerlink" title="3. Redis 高可用"></a>3. Redis 高可用</h2><p>Redis Sentinel 是 Redis 官方的高可用性解决方案。原理就是前面提到的监控程序。</p>
<p>Sentinel 的任务：<strong>监控、提醒、自动故障迁移</strong>。</p>
<p>Sentinel 使用留言协议（gossip protocols）来接收主服务器是否下线信息；使用投票协议（agreement protocols）决定是否故障迁移和推选主服务器。</p>
<h3 id="3-1-启动-Sentinel"><a href="#3-1-启动-Sentinel" class="headerlink" title="3.1 启动 Sentinel"></a>3.1 启动 Sentinel</h3><p><code>redis-server /path/to/sentinel.conf --sentine</code></p>
<h3 id="3-1-配置-Sentinel"><a href="#3-1-配置-Sentinel" class="headerlink" title="3.1 配置 Sentinel"></a>3.1 配置 Sentinel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">port 26379</div><div class="line">sentinel monitor mymaster 127.0.0.1 6379 2</div></pre></td></tr></table></figure>
<h2 id="4-主从复制和高可用练习"><a href="#4-主从复制和高可用练习" class="headerlink" title="4. 主从复制和高可用练习"></a>4. 主从复制和高可用练习</h2><p>启动三个 Redis 实例，一个作为主库，两个作为从库复制主库；启动三个 sentinel，对主库做高可用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">// 1. 准备：启动 3 个 redis 实例</div><div class="line"><span class="built_in">cd</span> ~</div><div class="line">mkdir redistest</div><div class="line"><span class="built_in">cd</span> redistest</div><div class="line">cp /etc/redis/* ../../</div><div class="line">-- 修改配置文件：1. 关闭后台线程执行 2. 关闭日志文件 3. 关闭 AOF</div><div class="line">vim 6379|6380|6380.conf</div><div class="line">// 删除持久化目录内容</div><div class="line"><span class="built_in">cd</span> /var/lib/redis/6379|6380|6381</div><div class="line">rm -rf ../../*</div><div class="line">redis-server ../../6379.conf</div><div class="line">redis-cli</div><div class="line"><span class="built_in">set</span> k1 1</div><div class="line"></div><div class="line">redis-server ../../6380.conf --replicaof 127.0.0.1 6379</div><div class="line"></div><div class="line">// 2. 主从复制</div><div class="line">// 2.1 主库数据自动同步到从库</div><div class="line">redis-cli -p 6380</div><div class="line">-- 有 k1，说明同步了 6379</div><div class="line">keys *</div><div class="line">-- 报错，默认从库只读，可以配置</div><div class="line"><span class="built_in">set</span> k1 1</div><div class="line"></div><div class="line">// 2.2 从库数据被删除</div><div class="line">redis-server ../../6381.conf</div><div class="line">reids-cli -p 6381</div><div class="line"><span class="built_in">set</span> k2 2</div><div class="line">replicaof 127.0.0.1 6379</div><div class="line">-- 获取不到，从库数据被删除</div><div class="line">get k2 </div><div class="line"></div><div class="line">// 2.3 从库挂了，重新连接，可以取到主库新数据，没有重新 RDB</div><div class="line">-- 关闭 6380</div><div class="line">-- 主库存数据</div><div class="line"><span class="built_in">set</span> k2 2</div><div class="line"><span class="built_in">set</span> k3 3</div><div class="line">-- 启动 6380</div><div class="line">get k2 k3</div><div class="line"></div><div class="line">// 2.4 AOF 开启。从库挂了，重新连接，每次都会重新 RDB</div><div class="line">-- 关闭 6380</div><div class="line">-- 主库存数据</div><div class="line"><span class="built_in">set</span> k4 2</div><div class="line"><span class="built_in">set</span> k5 3</div><div class="line">-- 开启 AOF</div><div class="line">appendonly yes</div><div class="line">-- 启动 6380</div><div class="line">-- 从启动日志可以看到执行了 BGSAVE</div><div class="line">get k3 k4</div><div class="line"></div><div class="line">// 2.5 主库挂了，需要人工重新指定主库和从库</div><div class="line">-- 关闭 6379</div><div class="line">-- 6380 取消追随</div><div class="line">replicaof no one</div><div class="line">-- 6381 追随 6380</div><div class="line">replicaof 127.0.0.1 6380</div><div class="line"></div><div class="line">// 2.6 哨兵</div><div class="line">-- 关闭所有实例和客户端</div><div class="line">vim 26379|26380|26380.conf/</div><div class="line">	port 26379</div><div class="line">	sentinel monitor mymaster 127.0.0.1 6379 2</div><div class="line">-- 启动 3 个 server</div><div class="line">-- 启动 3 个哨兵</div><div class="line">redis-server ../../26379.conf --sentinel</div><div class="line">-- 停止 6379，过一段时间(因为有一个延时，防止网络问题)发现哨兵自动做了故障转移</div><div class="line">-- 从日志看出，哨兵选举的主库是 6380；6379 自动变为从库</div><div class="line">redis-cli -p 6380</div><div class="line"><span class="built_in">set</span> k1 aaa</div><div class="line">redis-cli -p 6381</div><div class="line">get k1</div><div class="line">-- 哨兵会自动修改自己的配置文件</div><div class="line"><span class="built_in">cd</span> ~/redistest</div><div class="line">vim 26379.conf</div></pre></td></tr></table></figure>
<p><strong>问题：</strong>主知道从，是因为从追随主时就知道了；但是一个哨兵是如何知道其他哨兵的？</p>
<p><strong>答案：</strong>通过 Redis 自带的<strong>发布订阅</strong>实现。PSUBSCRIBE *，可以看到哨兵的交互信息。</p>
<h2 id="5-Redis-集群"><a href="#5-Redis-集群" class="headerlink" title="5. Redis 集群"></a>5. Redis 集群</h2><h3 id="5-1-Redis-分区"><a href="#5-1-Redis-分区" class="headerlink" title="5.1 Redis 分区"></a>5.1 Redis 分区</h3><h4 id="分区基本概念"><a href="#分区基本概念" class="headerlink" title="分区基本概念"></a>分区基本概念</h4><ol>
<li>范围分区</li>
</ol>
<p><img src="../../images/redis4/范围分区.png" alt=""></p>
<p>弊端：需要建一张表存储数据到 redis 实例的映射关系，并且要非常谨慎的维护这张表；有些数据无法根据类型来拆分，或者说本身数据很大，即使分类了，一个 Redis 实例还是搞不定一个分类下的数据。</p>
<ol>
<li>散列分区（hash 后取模）</li>
</ol>
<p><img src="../../images/redis4/散列分区.png" alt=""></p>
<p>弊端：取模的数必须固定，就是 Redis 实例的数量。影响分布式下的扩展性。后期业务发展了，主机可能变多，模值就要变化。比如 key1 一开始存在实例1，后台增加主机后，key1 取模后可能是实例2，导致再也取不到原来实例1上的 key1 了。</p>
<ol>
<li>随机分区</li>
</ol>
<p><img src="../../images/redis4/随机分区.png" alt=""></p>
<p>弊端：随机放入一个 Redis 实例，但是自己取不出来了，因为客户端自己也不知道哪个 key 在哪个实例。一般用于消息队列的特殊场景。和 kafka 类似，ooxx 就相当于 topic，一个 redis 实例就相当于一个 partition。</p>
<ol>
<li>一致性哈希</li>
</ol>
<p><img src="../../images/redis4/一致性哈希分区.png" alt=""></p>
<p>弊端：新增节点造成一小部分数据不能命中，就是新增节点和前一个节点之间的数据；新增节点和接二点后一个节点之间的数据没有影响。可能造成缓存击穿，请求压到 mysql。可以通过每次取离我最近的2个物理节点来解决（<strong>根据实际场景去取舍</strong>）</p>
<p>优点：你加节点，的确可以分担其他节点的压力，不会造成全局洗牌。如果是取模的方法，需要把所有数据重新取模算一遍。</p>
<h4 id="分区实现方案"><a href="#分区实现方案" class="headerlink" title="分区实现方案"></a>分区实现方案</h4><ol>
<li>客户端分区</li>
</ol>
<p>每个客户端都要跟每个 Redis 实例建立连接，因为不同的 key 可能存到不同的实例。Redis 的连接成本很高对 server 端造成的压力较大。</p>
<ol>
<li>代理分区(twemproxy)</li>
</ol>
<p><img src="../../images/redis4/代理分区.png" alt=""></p>
<p>安装 twemproxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// 下载 twemproxy</div><div class="line">git <span class="built_in">clone</span> git@github.com:twitter/twemproxy.git</div><div class="line">-- git <span class="built_in">clone</span> 可能报错</div><div class="line">yum update nss</div><div class="line">-- autoreconf 版本可能太低</div><div class="line">yum search autoconf</div><div class="line">// 常识，yum 装的软件来自仓库，可能你现在系统自带的仓库偏低 epel</div><div class="line">mirrors.aliyun.com</div><div class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</div><div class="line">wget -0 /etc/...</div><div class="line">yum clean all</div><div class="line">yum search autoconf</div><div class="line">yum install autoconf268</div><div class="line"></div><div class="line">// 安装 twemproxy 为服务</div><div class="line"><span class="built_in">cd</span> scripts/</div><div class="line">vi nutcracker.init</div><div class="line">-- 拷贝配置文件</div><div class="line">cp ./* /opt/alvin/twemproxy/</div><div class="line">-- 拷贝可执行程序</div><div class="line">cp nutcracker /usr/bin/</div><div class="line">-- 修改配置</div><div class="line">vim nutcracker.yml</div></pre></td></tr></table></figure>
<p>安装 predixy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">// 下载 predixy</div><div class="line"><span class="built_in">cd</span> ~/soft/</div><div class="line">mkdir predixy</div><div class="line">wget https://github.com/joyieldInc/predixy/releases/download/1.0.5/predixy-1.0.5-bin-amd64-linux.tar.gz</div><div class="line">tar -xf predixy-1.0.5-bin-amd64-linux.tar.gz</div><div class="line"></div><div class="line">// 修改配置</div><div class="line"><span class="built_in">cd</span> predixy-1.0.5/conf</div><div class="line">vi predixy.conf</div><div class="line">	Bind 127.0.0.1:7617</div><div class="line">	Include sentinel.conf</div><div class="line">vi sentinel.conf</div><div class="line">    SentinelServerPool &#123;</div><div class="line">        Databases 16</div><div class="line">        Hash crc16</div><div class="line">        HashTag <span class="string">"&#123;&#125;"</span></div><div class="line">        Distribution modula</div><div class="line">        MasterReadPriority 60</div><div class="line">        StaticSlaveReadPriority 50</div><div class="line">        DynamicSlaveReadPriority 50</div><div class="line">        RefreshInterval 1</div><div class="line">        ServerTimeout 1</div><div class="line">        ServerFailureLimit 10</div><div class="line">        ServerRetryTimeout 1</div><div class="line">        KeepAlive 120</div><div class="line">        Sentinels &#123;</div><div class="line">            + 127.0.0.1:26379</div><div class="line">            + 127.0.0.1:26380</div><div class="line">            + 127.0.0.1:26381</div><div class="line">        &#125;</div><div class="line">        Group ooxx &#123;</div><div class="line">        &#125;</div><div class="line">        Group xxoo &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">// 配置 sentinel</div><div class="line"><span class="built_in">cd</span> ~/redistest</div><div class="line">vi 26379.conf/vi 26380.conf/vi 26381.conf</div><div class="line">port 26381</div><div class="line">sentinel monitor ooxx 127.0.0.1 36379 2</div><div class="line">sentinel monitor xxoo 127.0.0.1 46379 2</div><div class="line">// 启动哨兵</div><div class="line">redis-server 26379.conf --sentinel</div><div class="line">redis-server 26380.conf --sentinel</div><div class="line">redis-server 26381.conf --sentinel</div><div class="line">// 启动两套主从复制集群</div><div class="line">mkdir 36379/36380/46379/46380</div><div class="line">-- 启动主库</div><div class="line"><span class="built_in">cd</span> 36379</div><div class="line">redis-server --port 36379</div><div class="line"><span class="built_in">cd</span> 46379</div><div class="line">redis-server --port 46379</div><div class="line">-- 启动从库</div><div class="line"><span class="built_in">cd</span> 36380</div><div class="line">redis-server --port 36380 --replicaof 127.0.0.1 36379</div><div class="line"><span class="built_in">cd</span> 46380</div><div class="line">redis-server --port 46380 --replicaof 127.0.0.1 46379</div><div class="line"></div><div class="line">// 启动 predixy 代理</div><div class="line"><span class="built_in">cd</span> ~/soft/predixy/predixy-1.0.5/bin</div><div class="line">./predixy ../conf/predixy.conf</div><div class="line"></div><div class="line">// 客户端登录验证</div><div class="line">redis-cli -p 7617</div><div class="line"></div><div class="line">-- 存在不同实例</div><div class="line"><span class="built_in">set</span> k1 aaa</div><div class="line"><span class="built_in">set</span> k2 bbb</div><div class="line"></div><div class="line">-- 存在同一个实例</div><div class="line"><span class="built_in">set</span> &#123;oo&#125;k1 aaa</div><div class="line"><span class="built_in">set</span> &#123;oo&#125;k2 bbb</div><div class="line">-- 报错</div><div class="line">keys *</div><div class="line">WATCH k1</div><div class="line"></div><div class="line">// 修改配置，删除 xxoo 组</div><div class="line">-- 存在同一个实例</div><div class="line"><span class="built_in">set</span> k1 aaa</div><div class="line"><span class="built_in">set</span> k2 bbb</div><div class="line">-- 支持事务</div><div class="line">WATCH k1</div><div class="line">multi</div><div class="line">get k1</div><div class="line"><span class="built_in">set</span> k2 222</div><div class="line"><span class="built_in">exec</span></div><div class="line"></div><div class="line">// 验证哨兵高可用</div><div class="line">-- 关闭 363679，访问正常</div></pre></td></tr></table></figure>
<ol>
<li>查询路由分区（Redis cluster）</li>
</ol>
<p>modula、random、kemata 三个模式均无法作为<strong>分布式数据库</strong>来使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ~/soft/redis-5.0.5/utils/create-cluster/</div><div class="line">-- 创建实例</div><div class="line">./create-cluster start</div><div class="line">-- 创建集群，分槽位</div><div class="line">./create-cluster create</div><div class="line">-- 连接客户端测试</div><div class="line">redis-cli -p 30001</div><div class="line"><span class="built_in">set</span> k1 aaa</div><div class="line">-- 提示：MOVED 12706 127.0.0.1:30003</div><div class="line">-- 用 cluster 客户端</div><div class="line">redis-cli -c -p 30001</div><div class="line">-- 自动跳转</div><div class="line"><span class="built_in">set</span> k1 aaa</div><div class="line">./create-cluster stop</div><div class="line">./create-cluster clean</div><div class="line"></div><div class="line">// 手动启动</div><div class="line">./create-cluster start</div><div class="line">redis-cli --cluster <span class="built_in">help</span></div><div class="line">redis-cli --cluster create 127.0.0.1:30001/6 --cluster-replicas 1</div><div class="line"></div><div class="line">// 重新分片</div><div class="line">redis-cli --cluster reshard 127.0.0.1:30001</div><div class="line">redis-cli --cluster info 127.0.0.1:30001</div><div class="line">redis-cli --cluster check 127.0.0.1:30001</div><div class="line"></div><div class="line">// 新增节点</div><div class="line">redis-server --port 36379 --cluster-enabled yes --cluster-config-file nodes-36379.conf --cluster-node-timeout 2000 --appendonly yes --appendfilename appendonly-36379.aof --dbfilename dump-36379.rdb --logfile 36379.log --daemonize yes</div><div class="line">redis-cli --cluster add-node 127.0.0.1:36379 127.0.0.1:30001</div></pre></td></tr></table></figure>
<p>Redis Cluster 实现了一种混合形式的查询路由，他并不是直接将请求从一个 redis 节点转发到另一个 redis 节点，而是在客户端的帮助下直接 <em>redirected</em> 到正确的 redis 节点。Redis 集群是 <em>query routing</em> 和 client side partitioning  的一种混合实现。</p>
<h4 id="分区缺点"><a href="#分区缺点" class="headerlink" title="分区缺点"></a>分区缺点</h4><ol>
<li>涉及多个 key 的操作通常不会被支持，因为可能存在不同的 redis 实例</li>
<li>同时操作多个 key，则不能使用 Redis 事务</li>
<li>使用分区时，数据处理会非常复杂，例如备份</li>
<li>分区时动态扩容和缩容可能非常复杂。Redis 集群在运行时增加或者删除 Redis 节点，能做到最大程度对用户透明地数据再平衡，但其他一些客户端分区或者代理分区方法则不支持这种特性。然而，有一种<em>预分片</em>的技术也可以较好的解决这个问题。</li>
</ol>
<h4 id="持久化数据还是缓存"><a href="#持久化数据还是缓存" class="headerlink" title="持久化数据还是缓存"></a>持久化数据还是缓存</h4><ol>
<li>如果 Redis 被当做缓存使用，使用一致性哈希实现<strong>动态扩容缩容</strong>。</li>
<li>如果 Redis 被当做一个持久化存储使用，<strong>必须使用固定的keys-to-nodes映射关系，节点的数量一旦确定不能变化</strong>。否则的话(即 Redis 节点需要动态变化的情况），必须使用可以在<strong>运行时进行数据再平衡</strong>的一套系统，而当前只有 Redis 集群可以做到这样</li>
</ol>
<h4 id="预分片"><a href="#预分片" class="headerlink" title="预分片"></a>预分片</h4><p>从上面获知，除非我们把 Redis 当做缓存使用，否则（在生产环境动态）增加和删除节点将非常麻烦，但是使用固定的 keys-instances 则比较简单。</p>
<p>既然 Redis 是如此的轻量（单实例只使用 1M 内存）,为防止以后的扩容，最好的办法就是一开始就启动较多实例。即便你只有一台服务器，你也可以一开始就让 Redis 以分布式的方式运行，使用分区，在同一台服务器上启动多个实例。</p>
<h4 id="Redis-分区实现"><a href="#Redis-分区实现" class="headerlink" title="Redis 分区实现"></a>Redis 分区实现</h4><ol>
<li>Redis 集群</li>
<li><p>Twemproxy</p>
</li>
<li><p>支持一致性哈希的客户端（Redis-rb，Predis）</p>
</li>
</ol>
</div><div class="tags"><a href="/tags/Redis/">Redis</a></div><div class="post-nav"><a class="pre" href="/2020-02-22-202002/NIO原理.html">NIO 原理</a><a class="next" href="/2020-02-20-202002/Redis 学习(三)-持久化.html">Redis 学习(三)-持久化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/加解密技术/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/吉他/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心情/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/无关技术/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息队列/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/疯狂-Java-讲义/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计划/">计划</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/计划/" style="font-size: 15px;">计划</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/吉他/" style="font-size: 15px;">吉他</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/无关技术/" style="font-size: 15px;">无关技术</a> <a href="/tags/疯狂-Java-讲义/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>