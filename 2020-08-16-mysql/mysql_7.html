<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>MySql 调优(七) | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MySql 调优(七)</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MySql 调优(七)</h1><div class="post-meta">Aug 16, 2020<span> | </span><span class="category"><a href="/categories/MySQL/">MySQL</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MySQL-系统参数"><span class="toc-text">1. MySQL 系统参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-参数说明"><span class="toc-text">1.1 参数说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-查看查询缓存状态"><span class="toc-text">1.2 查看查询缓存状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-查看线程缓存状态"><span class="toc-text">1.3 查看线程缓存状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-mysql-日志"><span class="toc-text">2. mysql 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-日志的作用"><span class="toc-text">2.1 日志的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-WAL-机制"><span class="toc-text">2.2 WAL 机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-核心日志模块"><span class="toc-text">2.3 核心日志模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#重做日志-redo-log"><span class="toc-text">重做日志 redo log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#回滚日志-undo-log"><span class="toc-text">回滚日志 undo log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#归档日志-binlog"><span class="toc-text">归档日志 binlog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#binlog-和-redo-log-的区别"><span class="toc-text">binlog 和 redo log 的区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-三个日志都必须开启吗？"><span class="toc-text">2.4 三个日志都必须开启吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-两阶段提交"><span class="toc-text">2.5 两阶段提交</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-组提交"><span class="toc-text">2.6 组提交</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一阶段（prepare-阶段）"><span class="toc-text">第一阶段（prepare 阶段）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二阶段（commit-阶段）"><span class="toc-text">第二阶段（commit 阶段）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优势"><span class="toc-text">优势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-数据恢复流程"><span class="toc-text">2.7 数据恢复流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-两个参数"><span class="toc-text">2.7 两个参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sync-binlog，控制-binlog-刷盘，默认1"><span class="toc-text">sync_binlog，控制 binlog 刷盘，默认1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#innodb-flush-log-at-trx-commit，控制-redo-log-刷盘，默认-1"><span class="toc-text">innodb_flush_log_at_trx_commit，控制 redo log 刷盘，默认 1</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>服务器参数设置。</p>
<a id="more"></a>
<h2 id="1-MySQL-系统参数"><a href="#1-MySQL-系统参数" class="headerlink" title="1. MySQL 系统参数"></a>1. MySQL 系统参数</h2><h3 id="1-1-参数说明"><a href="#1-1-参数说明" class="headerlink" title="1.1 参数说明"></a>1.1 参数说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">vim /etc/my.cnf</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">## general 参数</div><div class="line"># mysql 安装目录</div><div class="line">basedir=/usr/local/mysql</div><div class="line"># 数据文件目录</div><div class="line">datadir=/usr/local/mysql/data</div><div class="line"># mysql.socket表示server和client在同一台服务器，并且使用localhost进行连接，就会使用socket进行连接</div><div class="line"># socket=/usr/local/mysql/mysql.sock</div><div class="line"># pid 文件目录</div><div class="line">#pid_file=/usr/local/mysql/mysql.pid</div><div class="line"># 端口</div><div class="line">port=3306</div><div class="line"># 默认存储引擎</div><div class="line">default_storage_engine=InnoDB</div><div class="line"># 跳过密码登录</div><div class="line">#skip-grant-tables=ON</div><div class="line"># 用户?</div><div class="line">user=mysql</div><div class="line"></div><div class="line">## 字符集相关参数</div><div class="line"># server 端字符集</div><div class="line">character_set_server=utf8</div><div class="line"># client 端字符集</div><div class="line"># character_set_client=utf8</div><div class="line"># 数据库默认字符集</div><div class="line"># character_set_database=utf8</div><div class="line"># mysql 发送给客户端的结果集所用的字符集</div><div class="line"># character_set_results=utf8</div><div class="line"># mysql处理客户端发来的信息时，会把这些数据转换成连接的字符集格式</div><div class="line"># character_set_connection=utf8</div><div class="line"># character_set_system=utf8</div><div class="line"></div><div class="line"></div><div class="line">## connection 相关参数</div><div class="line"># mysql 的最大连接数,如果数据库的并发连接请求比较大,应该调高该值</div><div class="line">max_connections=200</div><div class="line"># 限制每个用户的连接个数</div><div class="line">max_user_connections=10</div><div class="line"># mysql 能够暂存的连接数,当mysql的线程在一个很短时间内得到非常多的连接请求时就会起作用</div><div class="line"># 如果mysql的连接数量达到max_connections时,新的请求会放入一个堆栈中,以等待某一个连接的释放</div><div class="line"># 如果等待连接的数量超过back_log,则不再接收连接资源</div><div class="line">back_log=50</div><div class="line"># mysql在关闭一个非交互的连接之前需要等待的时长。短连接。比如jdbc</div><div class="line">wait_timeout=43200</div><div class="line"># mysql在关闭一个交互连接之前需要等待的时长。长连接。比如连接池、命令行。</div><div class="line"># 但是连接池中的连接有时长限制，连接池会定时关闭长期没用到的连接。</div><div class="line"># 所以这个定时关闭连接的间隔最好小于 wait_timeout</div><div class="line">interactive_timeout=43200</div><div class="line"></div><div class="line"></div><div class="line">## log相关参数</div><div class="line"># 指定错误日志文件名称，用于记录当mysqld启动和停止时</div><div class="line"># 以及服务器在运行中发生任何严重错误的相关信息</div><div class="line">log_error=/usr/local/mysql/logs/log_error.log</div><div class="line"></div><div class="line">### binlog 设置</div><div class="line"># 指定 binlog 路径和名称</div><div class="line">log-bin=/usr/local/mysql/logs/log_bin.log</div><div class="line"># 指定log-bin参数后，无需指定log_bin，log-bin相当于一个快速设置方式。log_bin表示是否启动bin log</div><div class="line"># 神坑，必须要 server_id</div><div class="line"># If you specify the --log-bin option without also specifying the server_id system variable, the server</div><div class="line"># is not allowed to start. (Bug #11763963, Bug #56739) </div><div class="line">server_id=1</div><div class="line"># 指定哪些数据库需要将更新记录到二进制日志中。</div><div class="line"># 其他所有没有显示指定的数据库将忽略，不记录日志</div><div class="line"># SHOW MASTER STATUS 可以查看binlog源的状态信息</div><div class="line">binlog_do_db=sakila</div><div class="line"># 指定哪些数据库不需要记录日志</div><div class="line"># binlog_ignore_db=</div><div class="line"># binlog 刷盘机制</div><div class="line"># 0-不控制,让OS控制刷盘</div><div class="line"># 1-每次提交事务,刷盘</div><div class="line"># N-指定多少次提交事务后同步磁盘</div><div class="line">sync_binlog=2</div><div class="line"></div><div class="line">### redo log 设置</div><div class="line"># redo log 日志文件大小(64M)</div><div class="line">innodb_log_file_size=67108864</div><div class="line"># redo log 日志个数</div><div class="line">innodb_log_files_in_group=3</div><div class="line"># redo log 日志路径</div><div class="line">innodb_log_group_home_dir=/usr/local/mysql/logs/</div><div class="line"># redo log 刷盘机制,刷盘系统调用:fsync</div><div class="line"># 0-事务提交数据写入InnoDB LogBuffer,然后每秒写入OS cache page并刷盘</div><div class="line"># 1-事务提交立即刷盘</div><div class="line"># 2-事务提交数据写入OS cache page,每秒刷盘</div><div class="line">innodb_flush_log_at_trx_commit=1</div><div class="line"></div><div class="line">### undo log 设置</div><div class="line"># 回滚日志位置一般设置到不同的存储设备</div><div class="line">innodb_undo_directory=/usr/local/mysql/logs/</div><div class="line"># 回滚段的数量</div><div class="line">innodb_rollback_segments=256</div><div class="line"># undo tablespaces 的数量,初始化后不可修改,否则会导致服务无法启动</div><div class="line"># innodb_undo_tablespaces=2</div><div class="line"></div><div class="line">### general log 设置</div><div class="line"># 是否开启查询日志记录</div><div class="line">general_log=ON</div><div class="line">general_log_file=/usr/local/mysql/logs/general_log.log</div><div class="line"></div><div class="line">### slow log 设置</div><div class="line"># 是否开启慢日志</div><div class="line">slow_query_log=ON</div><div class="line">slow_query_log_file=/usr/local/mysql/logs/slow_query_log.log</div><div class="line">long_query_time=2</div><div class="line">log_slow_admin_statements=ON</div><div class="line"></div><div class="line">## 缓存相关参数</div><div class="line"># 索引缓冲区的大小(只对 MyISAM 表起作用),默认(8M=&gt;16M)</div><div class="line">key_buffer_size=16777216</div><div class="line"></div><div class="line">### 查询缓存 5.7.20 被弃用,8 被移除</div><div class="line"># 查询缓存的大小,默认(1M=&gt;4M)</div><div class="line">query_cache_size=4194304</div><div class="line"># 缓存类型</div><div class="line"># 0-禁用</div><div class="line"># 1-缓存所有查询结果,除非显示指定 sql_no_cache</div><div class="line"># 2-只缓存 sql_cache 指定的查询</div><div class="line">query_cache_type=2</div><div class="line"># 缓存块最小大小(默认 4K=&gt;0.25K)</div><div class="line">query_cache_min_res_unit=256</div><div class="line"># 超过此大小的查询不缓存(默认 1M=&gt;2M)</div><div class="line">query_cache_limit=2097152</div><div class="line"></div><div class="line"># 每个需要排序的线程分派缓冲区的大小(默认 256K=&gt;1M)</div><div class="line"># 可根据引擎设置:innodb_sort_buffer_size、myisam_sort_buffer_size</div><div class="line">sort_buffer_size=1048576</div><div class="line"># MySQL server 接收的最大数据包大小(4M=&gt;32M)</div><div class="line">max_allowed_packet=33554432</div><div class="line"># 设置关联缓冲的大小(256K=&gt;2M)</div><div class="line">join_buffer_size=2097152</div><div class="line"># 服务器线程缓存数量，当断开连接时，客户端的线程被放到缓存中以响应下一个客户而不是销毁</div><div class="line"># 如果线程重新被请求，那么请求将从缓存中读取</div><div class="line"># 如果缓存中是空的或者是新的请求，这个线程将被重新请求和创建</div><div class="line"># 如果有很多新的线程，增加这个值即可（10=&gt;5）</div><div class="line">thread_cache_size=5</div><div class="line"></div><div class="line">## InnoDB 相关参数</div><div class="line"># 缓存数据和索引的内存大小，最大可设置物理内存的 80%（128M=&gt;64M）</div><div class="line">innodb_buffer_pool_size=67108864</div><div class="line"># 设置 InnoDB 线程的并发数，0 表示不限制</div><div class="line"># 如果设置一般为服务器的核心数或者核心数的两倍(0=&gt;8)</div><div class="line">innodb_thread_concurrency=8</div><div class="line"># (16M=&gt;64M)</div><div class="line">innodb_log_buffer_size=67108864</div><div class="line"># 读入缓冲区大小(128K=&gt;256K)</div><div class="line"># 对表进行顺序扫描的请求将分配到一个读入缓冲区</div><div class="line">read_buffer_size=262144</div><div class="line"># MySQL 随机读缓冲区大小（256K=&gt;512K）</div><div class="line">read_rnd_buffer_size=524288</div><div class="line"># 是否为每张表分配一个新的文件</div><div class="line">innodb_file_per_table=ON</div><div class="line"></div><div class="line">[mysqld_safe]</div><div class="line">#log_error=/usr/local/mysql/logs/log_error.log</div><div class="line">#pid-file=/var/run/mysqld/mysqld.pid</div><div class="line"></div><div class="line">[client]</div><div class="line">default-character-set=utf8</div><div class="line"># client 端字符集</div><div class="line">#character_set_client=utf8</div></pre></td></tr></table></figure>
<h3 id="1-2-查看查询缓存状态"><a href="#1-2-查看查询缓存状态" class="headerlink" title="1.2 查看查询缓存状态"></a>1.2 查看查询缓存状态</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'%Qcache%'</span>;</div></pre></td></tr></table></figure>
<ul>
<li>Qcache_free_blocks：缓存中相邻内存块的个数，如果值比较大说明查询缓存中碎片比较多</li>
<li>Qcache_free_memory：查询缓存中剩余的内存大小</li>
<li>Qcache_hits：表示有多少查询命中缓存</li>
<li>Qcache_inserts：多少次未命中而插入</li>
<li>Qcache_lowmem_prunes：多少条查询因为内存不足而被移除 cache</li>
<li>Qcache_queries_in_cache：当前 cache 中缓存的查询条数</li>
<li>Qcache_total_blocks：当前 cache 中 block 的数量</li>
</ul>
<h3 id="1-3-查看线程缓存状态"><a href="#1-3-查看线程缓存状态" class="headerlink" title="1.3 查看线程缓存状态"></a>1.3 查看线程缓存状态</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'%Threads%'</span>;</div></pre></td></tr></table></figure>
<ul>
<li>Threads_cached：当前线程缓存中有多少空闲线程</li>
<li>Threads_connected：当前已建立连接的数量</li>
<li>Threads_created：最近一次启动服务，已创建线程的数量</li>
<li>Threads_running：当前激活的线程数</li>
</ul>
<h2 id="2-mysql-日志"><a href="#2-mysql-日志" class="headerlink" title="2. mysql 日志"></a>2. mysql 日志</h2><h3 id="2-1-日志的作用"><a href="#2-1-日志的作用" class="headerlink" title="2.1 日志的作用"></a>2.1 日志的作用</h3><p>保证数据不丢失，主要体现在两个方面</p>
<ol>
<li>能够恢复到任何时间点的状态。通过 binlog 实现</li>
<li>任何时候 MySQL 突然崩溃,重启之后之前已经提交的记录不会丢失。redolog undolog 实现。<ul>
<li>已提交的数据不会丢失</li>
<li>未提交完整的数据自动回滚</li>
</ul>
</li>
</ol>
<h3 id="2-2-WAL-机制"><a href="#2-2-WAL-机制" class="headerlink" title="2.2 WAL 机制"></a>2.2 WAL 机制</h3><p>为什么不直接更改磁盘中的数据，而要在内存中更改，然后还需要写日志，最后再落盘这么复杂？</p>
<p>主要是性能问题。直接写磁盘是<strong>随机写</strong>，开销很大，没办法满足 MySQL 性能要求。所以设计成先在内存中对数据进行更改，再异步落盘。但是内存总是不可靠，万一断电重启，还没来得及落盘的内存数据就会丢失，所以还需要加上写日志这个步骤。虽然写日志也是写磁盘，但是写日志是<strong>顺序写</strong>。</p>
<h3 id="2-3-核心日志模块"><a href="#2-3-核心日志模块" class="headerlink" title="2.3 核心日志模块"></a>2.3 核心日志模块</h3><h4 id="重做日志-redo-log"><a href="#重做日志-redo-log" class="headerlink" title="重做日志 redo log"></a>重做日志 redo log</h4><p>InnoDB 存储引擎产生，记录数据库中每个页的修改，而不是某一行或者某几行修改成怎样，可以用来恢复提交后的物理数据页（所以只能恢复到最后一次提交的位置）。</p>
<p>redo log 就是 WAL 的典型应用，MySQL 在有事务提交时，只会在内存中修改对应的数据页和记录 redo log 日志，完成后即表示事务提交成功，至于磁盘数据文件的更新则由后台线程异步处理。</p>
<p>redo log 保证了 MySQL 数据<strong>一致性和持久性</strong>（MySQL 崩溃了，重启后仍然可以通过 redo log 里的记录进行重放，重新刷盘）。</p>
<p>redo log 大小固定，循环写入，相当于一个环形，所以是顺序写。当 redo log 满了，就需要对旧的记录进行擦除，擦除之前必须确保被擦除的记录在内存中的数据页都已刷到磁盘中了。在 redo log 满了到擦除旧记录之前，是不能再接收新的更新请求的，所以有可能导致 MySQL 卡顿。所以针对并发量大的系统，<strong>适当设置 redo log 的文件大小</strong>非常重要。</p>
<h4 id="回滚日志-undo-log"><a href="#回滚日志-undo-log" class="headerlink" title="回滚日志 undo log"></a>回滚日志 undo log</h4><p>主要提供回滚的作用，另外一个作用就是多个行版本控制（MVCC），保证事务的<strong>原子性</strong>。在数据修改的流程中，会记录一条与当前操作相反的逻辑日志到 undo log 中。</p>
<h4 id="归档日志-binlog"><a href="#归档日志-binlog" class="headerlink" title="归档日志 binlog"></a>归档日志 binlog</h4><p>binlog 在 MySQL 的 server 产生，不属于任何引擎，主要记录用户对数据库操作的 SQL 语句（除了查询语句）。之所以叫做归档日志，因为 binlog 不会像 redo log 一样擦除旧日志，而是追加，操作 <code>max_binlog_size</code>  就新起一个文件。</p>
<p>日志可能是基于事务来记录的（如 InnoDB），而事务是绝对不可能也不应该跨文件记录的，所以 <code>max_binlog_size</code> 和实际的 binlog 日志大小不一定相等。</p>
<h4 id="binlog-和-redo-log-的区别"><a href="#binlog-和-redo-log-的区别" class="headerlink" title="binlog 和 redo log 的区别"></a>binlog 和 redo log 的区别</h4><ul>
<li>redolog 是 innodb 独有的，binlog 是所有 engine 都可以使用的</li>
<li>redolog 是物理日志，记录的是在某个数据页上做了什么修改；binlog 是逻辑日志，记录的是这个语句的原始逻辑。物理日志：记录内存地址上存的啥；逻辑日志：记录 sql 语句。</li>
<li>redolog 是循环写的，空间会用完（存在内存的缓冲区中，肯定小）；binlog 是可以追加的，不会覆盖之前的日志信息。</li>
</ul>
<h3 id="2-4-三个日志都必须开启吗？"><a href="#2-4-三个日志都必须开启吗？" class="headerlink" title="2.4 三个日志都必须开启吗？"></a>2.4 三个日志都必须开启吗？</h3><ul>
<li>redo log 保证数据的持久性，必不可少。如果没有 MySQL 肯定不能认为修改了内存数据就表示操作成功。</li>
<li>undo log 保证事务原子性，必不可少。为啥必不可少？如果我知道哪个事务有问题，我把这个事务的 redo log 做一遍相反的操作不也可以实现吗？</li>
<li>binlog <ul>
<li>主从模式必不可少，因为从库的数据同步依赖的就是 binlog</li>
<li>单机模式如果不考虑数据库基于某个时间点还原，那么 binlog 就不是必须的。redo log 就可以保证 crash-safe 了。</li>
</ul>
</li>
</ul>
<h3 id="2-5-两阶段提交"><a href="#2-5-两阶段提交" class="headerlink" title="2.5 两阶段提交"></a>2.5 两阶段提交</h3><p>问题：为什么 redo log 要分两步写，中间再穿插写 binlog 呢？</p>
<p>redo log 影响主库数据，binlog 影响从库数据，所以 redo log 和 binlog 必须保持一致才能保证主从数据一致，这个是需要两阶段提交的前提。</p>
<p>redo log 和 binlog 其实就是很典型的分布式事务场景，因为两者本身就是两个独立的个体，要想保持一致，就必须使用分布式事务解决方案来处理。而将 redo log 分成两步，其实就是使用了两阶段提交协议（2PC）。</p>
<p><img src="../../images/mysql/7/两阶段提交.png" alt=""></p>
<p>所以将 redo log 分成两步写，中间插入 binlog 才能保证 redo log 和 binlog 内容一致，从而保证主从数据一致。</p>
<h3 id="2-6-组提交"><a href="#2-6-组提交" class="headerlink" title="2.6 组提交"></a>2.6 组提交</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">T1 (--prepare--binlog---------------------commit)</div><div class="line">T2 (-----prepare-----binlog----commit)</div><div class="line">T3 (--------prepare-------binlog------commit)</div><div class="line"> </div><div class="line">解析：</div><div class="line">    redo log prepare的顺序：T1 --》T2 --》T3</div><div class="line">    binlog的写入顺序：T1 --》 T2 --》T3</div><div class="line">    redo log commit的顺序：T2 --》 T3 --》T1</div><div class="line"> </div><div class="line">结论：由于binlog写入的顺序和redo log提交结束的顺序不一致，导致binlog和redo log所记录的事务提交结束的顺序不一样，最终导致的结果就是主从数据不一致。binlog 记录的是：i=1;i=2;i=3;redo log 记录的是：i=2;i=3;i=1</div></pre></td></tr></table></figure>
<ul>
<li>两阶段提交没法保证多个事务的提交顺序，所以还需要再加一个锁来保证提交的原子性，从而保证多事务情况下，两个日志的提交顺序一致。 prepare_commit_mutex 锁保证一个事务获取到锁后才能进入 prepare，一直到 commit 结束才能释放锁。并发量大时，会导致锁争用，性能不好。</li>
<li>两阶段提交还有一个问题就是每个事务提交都会进行两次 fsync（写磁盘）</li>
</ul>
<p>MySQL 5.6 引入了 binlog 组提交，即 BLGC。基本思想是引入队列机制保证 InnoDB commit 顺序 binlog 落盘顺序一致，并将事务分组，组内的 binlog 刷盘动作交给一个事务进行，实现组提交的目的。</p>
<p>组提交图</p>
<h4 id="第一阶段（prepare-阶段）"><a href="#第一阶段（prepare-阶段）" class="headerlink" title="第一阶段（prepare 阶段）"></a>第一阶段（prepare 阶段）</h4><p>持有 prepare_commit_mutex，并且 write/fsync redo log 到磁盘，设置为 prepared 状态，完成后就释放 prepare_commit_mutex，binlog 不做任何操作。</p>
<h4 id="第二阶段（commit-阶段）"><a href="#第二阶段（commit-阶段）" class="headerlink" title="第二阶段（commit 阶段）"></a>第二阶段（commit 阶段）</h4><ol>
<li>Flush Stage（写入 binlog 缓存）<ul>
<li>持有 Lock_log mutex（leader 持有，follower 等待）</li>
<li>获取队列中的一组 binlog（队列中的所有事务）</li>
<li>写入 binlog 缓存</li>
</ul>
</li>
<li>Sync Stage（将 binlog 落盘）<ul>
<li>释放 Lock_log mutex，持有 Lock_sync mutex（leader 持有，follower 等待）</li>
<li>将一组 binlog 落盘（fsync 动作，最耗时，假设 sync_binlog 为 1</li>
</ul>
</li>
<li>Commit Stage（InnoDB commit，清除 undo 信息）<ul>
<li>释放 Lock_sync mutex，持有 Lock_commit mutex（leader 持有，follower 等待）</li>
<li>遍历队列中的事务，逐一进行 InnoDB commit</li>
<li>释放 Lock_commit mutex</li>
</ul>
</li>
</ol>
<p>每个队列各自有 mutex 保护，同一个组队列之间是顺序的（flush-&gt;sync-&gt;commit）</p>
<p>组之间队列可以并发执行，即当一组事务在进行 commit 阶段时，其他新事务可以进行 flush 阶段，实现真正意义上的组提交，大幅度降低磁盘的 IOPS 消耗。（没太懂。。。）</p>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><ul>
<li>锁粒度更小，2PC 锁 prepare 到 commit 整个事务流程，组提交拆分为四个小阶段上锁</li>
<li>组提交是批量刷盘，相比之前的单条记录都要刷盘，能大幅降低磁盘的 IO 消耗</li>
</ul>
<h3 id="2-7-数据恢复流程"><a href="#2-7-数据恢复流程" class="headerlink" title="2.7 数据恢复流程"></a>2.7 数据恢复流程</h3><p>MySQL 重启后，提供服务前会先做的事 – 数据恢复流程：</p>
<p><img src="../../images/mysql/7/Mysql数据恢复流程.png" alt=""></p>
<h3 id="2-7-两个参数"><a href="#2-7-两个参数" class="headerlink" title="2.7 两个参数"></a>2.7 两个参数</h3><h4 id="sync-binlog，控制-binlog-刷盘，默认1"><a href="#sync-binlog，控制-binlog-刷盘，默认1" class="headerlink" title="sync_binlog，控制 binlog 刷盘，默认1"></a>sync_binlog，控制 binlog 刷盘，默认1</h4><ul>
<li>0：MySQL 不控制，让操作系统控制。性能最好，但是最可能丢失 binlog</li>
<li>1：每次事务提交前，刷盘。性能最差，只有 prepared 状态的事务会丢失，这可以借助 undo log 自动回滚，所以不会丢失任何事务</li>
<li>N：提交 N 次事务组后，刷盘。该值越高，性能越好，风险也越大。</li>
</ul>
<h4 id="innodb-flush-log-at-trx-commit，控制-redo-log-刷盘，默认-1"><a href="#innodb-flush-log-at-trx-commit，控制-redo-log-刷盘，默认-1" class="headerlink" title="innodb_flush_log_at_trx_commit，控制 redo log 刷盘，默认 1"></a>innodb_flush_log_at_trx_commit，控制 redo log 刷盘，默认 1</h4><p>ACID 特性和性能之前的一个权衡。</p>
<ul>
<li>0：每秒写入 OS cache page，然后刷盘</li>
<li>1：每次事务提交，日志刷盘</li>
<li>2：每次事务提交写入 OS cache page，然后每秒刷盘</li>
</ul>
<p><img src="../../images/mysql/7/redolog.png" alt=""></p>
<p>reference： <a href="https://blog.csdn.net/wenyiCodeDog/article/details/106581741" target="_blank" rel="external">https://blog.csdn.net/wenyiCodeDog/article/details/106581741</a> </p>
</div><div class="tags"><a href="/tags/MySQL/">MySQL</a></div><div class="post-nav"><a class="pre" href="/2020-08-18-mysql/mysql安装.html">MySql 安装</a><a class="next" href="/2020-08-13-mysql/mysql_5.html">MySql 调优(五)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/加解密技术/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/吉他/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心情/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/无关技术/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息队列/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/疯狂-Java-讲义/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计划/">计划</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/计划/" style="font-size: 15px;">计划</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/吉他/" style="font-size: 15px;">吉他</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/无关技术/" style="font-size: 15px;">无关技术</a> <a href="/tags/疯狂-Java-讲义/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>