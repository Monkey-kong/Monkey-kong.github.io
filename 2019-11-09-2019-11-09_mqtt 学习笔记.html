<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>mqtt 学习笔记 | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mqtt 学习笔记</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mqtt 学习笔记</h1><div class="post-meta">Nov 9, 2019<span> | </span><span class="category"><a href="/categories/mqtt/">mqtt</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-mosquitto-搭建-MQTT-服务器"><span class="toc-number">1.</span> <span class="toc-text">使用 mosquitto 搭建 MQTT 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-mosquitto"><span class="toc-number">1.1.</span> <span class="toc-text">安装 mosquitto</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.2.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置用户名和密码"><span class="toc-number">1.3.</span> <span class="toc-text">设置用户名和密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文章"><span class="toc-number">1.4.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-ActiveMQ-搭建-MQTT-服务器"><span class="toc-number">2.</span> <span class="toc-text">使用 ActiveMQ 搭建 MQTT 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载-ActiveMQ"><span class="toc-number">2.1.</span> <span class="toc-text">下载 ActiveMQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-ActiveMQ"><span class="toc-number">2.2.</span> <span class="toc-text">启动 ActiveMQ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#客户端工具"><span class="toc-number">3.</span> <span class="toc-text">客户端工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-EMQX-搭建-MQTT-服务器"><span class="toc-number">4.</span> <span class="toc-text">使用 EMQX 搭建 MQTT 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#权限控制"><span class="toc-number">4.1.</span> <span class="toc-text">权限控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关键概念理解"><span class="toc-number">5.</span> <span class="toc-text">关键概念理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码实现"><span class="toc-number">6.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eclipse-paho"><span class="toc-number">6.1.</span> <span class="toc-text">eclipse.paho</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Springboot-MQTT"><span class="toc-number">6.2.</span> <span class="toc-text">Springboot MQTT</span></a></li></ol></li></ol></div></div><div class="post-content"><p>最近项目 iot 平台中需要用到 mqtt 来传输消息。所以从网上查询相关资料进行了一些入门的学习。<br><a id="more"></a></p>
<h2 id="使用-mosquitto-搭建-MQTT-服务器"><a href="#使用-mosquitto-搭建-MQTT-服务器" class="headerlink" title="使用 mosquitto 搭建 MQTT 服务器"></a>使用 mosquitto 搭建 MQTT 服务器</h2><h3 id="安装-mosquitto"><a href="#安装-mosquitto" class="headerlink" title="安装 mosquitto"></a>安装 mosquitto</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 下载 mosquitto</span></div><div class="line">wget http://mosquitto.org/files/source/mosquitto-1.6.7.tar.gz</div><div class="line"><span class="meta">#</span><span class="bash"> 解压</span></div><div class="line">tar zxfv mosquitto-1.6.7.tar.gz</div><div class="line"><span class="meta">#</span><span class="bash"> 进入目录</span></div><div class="line">cd mosquitto-1.6.7</div><div class="line"><span class="meta">#</span><span class="bash"> 编译</span></div><div class="line">make</div><div class="line"><span class="meta">#</span><span class="bash"> 安装</span></div><div class="line">make install</div><div class="line"><span class="meta">#</span><span class="bash"> 查看版本</span></div><div class="line">mosquitto -v</div><div class="line"><span class="meta">#</span><span class="bash"> 设置配置文件</span></div><div class="line">cp mosquitto.conf.example mosquitto.conf</div><div class="line"><span class="meta">#</span><span class="bash"> 启动mosquitto服务</span></div><div class="line">mosquitto -c /etc/mosquitto/mosquitto.conf</div><div class="line"><span class="meta">#</span><span class="bash"> 查看端口</span></div><div class="line">ss -tanl</div><div class="line"><span class="meta">#</span><span class="bash"> 关闭 mosquitto 服务</span></div><div class="line">ps -A | grep mosquitto</div><div class="line">kill -9 pid</div></pre></td></tr></table></figure>
<p>按照上述步骤，会出现<code>Error: Invalid user &#39;mosquitto&#39;.</code>的错误。需要配置用户信息。在 mosquitto.conf 中增加 <strong>user root</strong>，然后在控制台执行<code>adduser mosquitto</code>命令。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>报错：/mosquitto_sub: error while loading shared libraries: libmosquitto.so.1: cannot open shared object file: No such file or directory<br>解决：执行以下命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo ln -s /usr/local/lib/libmosquitto.so.1 /usr/lib/libmosquitto.so.1</div><div class="line">ldconfig</div></pre></td></tr></table></figure></p>
<p>测试步骤：</p>
<ol>
<li>开启 mosquitto 服务：<code>mosquitto -c /etc/mosquitto/mosquitto.conf -v</code></li>
<li>开启一个客户端，模拟订阅：<code>mosquitto_sub -v -t topic01</code></li>
<li>再开启一个客户端，模拟发布：<code>mosquitto_pub -t topic -m hello</code></li>
</ol>
<h3 id="设置用户名和密码"><a href="#设置用户名和密码" class="headerlink" title="设置用户名和密码"></a>设置用户名和密码</h3><ol>
<li><p>修改配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">allow_anonymous false</div><div class="line">password_file /etc/mosquitto/pwfile.example</div></pre></td></tr></table></figure>
</li>
<li><p>创建用户名和密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 提示连续两次输入密码，创建成功</span></div><div class="line">mosquitto_passwd -c /etc/mosquitto/pwfile.example admin</div><div class="line"><span class="comment"># 注意第二次创建用户时不用加 -c 如果加 -c 会把第一次创建的用户覆盖。</span></div><div class="line">mosquitto_passwd /etc/mosquitto/pwfile.example mosquitto</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul>
<li><a href="https://www.cnblogs.com/chen1-kerr/p/7258487.html" target="_blank" rel="external">https://www.cnblogs.com/chen1-kerr/p/7258487.html</a></li>
<li><a href="https://www.cnblogs.com/zkwarrior/p/10950294.html" target="_blank" rel="external">https://www.cnblogs.com/zkwarrior/p/10950294.html</a></li>
</ul>
<h2 id="使用-ActiveMQ-搭建-MQTT-服务器"><a href="#使用-ActiveMQ-搭建-MQTT-服务器" class="headerlink" title="使用 ActiveMQ 搭建 MQTT 服务器"></a>使用 ActiveMQ 搭建 MQTT 服务器</h2><h3 id="下载-ActiveMQ"><a href="#下载-ActiveMQ" class="headerlink" title="下载 ActiveMQ"></a>下载 ActiveMQ</h3><p>下载地址：<a href="http://activemq.apache.org/download.html" target="_blank" rel="external">http://activemq.apache.org/download.html</a></p>
<h3 id="启动-ActiveMQ"><a href="#启动-ActiveMQ" class="headerlink" title="启动 ActiveMQ"></a>启动 ActiveMQ</h3><ul>
<li>创建 ActiveMQ 服务：进入解压目录：<code>activemq create D:\activemq\myactivemq</code></li>
<li>然后进入刚刚创建的 myactivemq 服务 bin 目录：<code>myactivemq start</code></li>
<li>进入主页：<a href="http://127.0.0.1:8161/admin/" target="_blank" rel="external">http://127.0.0.1:8161/admin/</a></li>
<li>用户名和密码在<code>\myactivemq\conf\users.properties</code>文件中<br><img src="../images/20199909/ActiveMQ.png" alt="ActiveMQ 主页"></li>
</ul>
<h2 id="客户端工具"><a href="#客户端工具" class="headerlink" title="客户端工具"></a>客户端工具</h2><ol>
<li><p>Eclipse Paho MQTT Utility(官方)<br><code>https://repo.eclipse.org/content/repositories/paho-releases/org/eclipse/paho/org.eclipse.paho.ui.app/1.1.1/</code></p>
</li>
<li><p>MQTT.fx<br><a href="http://www.mqttfx.org/" target="_blank" rel="external">http://www.mqttfx.org/</a></p>
</li>
</ol>
<h2 id="使用-EMQX-搭建-MQTT-服务器"><a href="#使用-EMQX-搭建-MQTT-服务器" class="headerlink" title="使用 EMQX 搭建 MQTT 服务器"></a>使用 EMQX 搭建 MQTT 服务器</h2><p>直接官网下载解压启动即可。要是早发现，何必这么折腾。。。</p>
<h3 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h3><p><a href="https://docs.emqx.io/tutorial/v3/cn/backend/mysql.html" target="_blank" rel="external">https://docs.emqx.io/tutorial/v3/cn/backend/mysql.html</a></p>
<h2 id="关键概念理解"><a href="#关键概念理解" class="headerlink" title="关键概念理解"></a>关键概念理解</h2><ol>
<li><p>客户端 Qos 理解（主要针对发送者）</p>
<ul>
<li>0：发送者只发一次，代理也只发一次，不管接收者是否接受到消息</li>
<li>1：保证接收者至少接收一遍消息，但是可能收到重复的消息</li>
<li>2：保证接收者有且只接收一次消息</li>
</ul>
</li>
<li><p>CleanSession 属性（长连接。主要针对接收者）<br>主要用于接收者订阅某个 topic 后，由于异常断线，重新上线后可以收到断线期间发送者发生的消息。<br>可以理解为：如果客户端该该属性设置为 ture，就相当于告诉代理，即使我这个客户端断线，你也要保存我的消息，等我下次上线时，把消息推送给我。<br>例如：</p>
<ul>
<li>发布者 qos=2，订阅者 CleanSession=ture。当订阅者断线重新上线后，可以收到断线期间的消息。</li>
<li>发布者 qos=2，订阅者 CleanSession=false。当订阅者断线重新上线后，不可以收到断线期间的消息。</li>
</ul>
</li>
<li><p>Retained 属性（主要针对发送者）<br>设置为 true 后，代理会保存该 topic 最新的一个消息。有新的订阅者时，该 retain 消息会发给订阅者。<br>可以理解为：如果客户端该属性设置为 ture，就相当于告诉代理，我这个客户端发布消息时，代理需要保存我发布的最后一条消息，并且当有新的订阅者订阅该主题时，代理需要把最后一条消息推送给订阅者。</p>
</li>
<li><p>Will 设置<br>设置遗嘱。当客户端非法断开连接时，可以发送遗嘱指定 topic 的消息。<br>通常 will 和 retain 机制一起使用。比如记录各个设备的连接信息。设备上线后，发送指定 topic 的上线消息；设备断线后，发送指定 topic 的离线信息。从而，只需订阅该 topic 就可以知道各个设备的状态信息。</p>
</li>
</ol>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="eclipse-paho"><a href="#eclipse-paho" class="headerlink" title="eclipse.paho"></a>eclipse.paho</h3><ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.paho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.eclipse.paho.client.mqttv3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>创建生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttClient;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttConnectOptions;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttDeliveryToken;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttException;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttMessage;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttPersistenceException;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttTopic;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 服务器向多个客户端推送主题，即不同客户端可向服务端订阅相同的主题</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerMQTT</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">//tcp://MQTT安装的服务器地址:MQTT定义的端口号</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"tcp://127.0.0.1:1883"</span>;</div><div class="line">    <span class="comment">//定义一个主题</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC = <span class="string">"topic02"</span>;</div><div class="line">    <span class="comment">//定义MQTT的ID，可以在MQTT服务配置中指定</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String clientid = <span class="string">"server02"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MqttClient client;</div><div class="line">    <span class="keyword">private</span> MqttTopic topic02;</div><div class="line">    <span class="keyword">private</span> String userName = <span class="string">"admin"</span>;</div><div class="line">    <span class="keyword">private</span> String passWord = <span class="string">"admin2"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MqttMessage message;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 构造函数</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> MqttException</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerMQTT</span><span class="params">()</span> <span class="keyword">throws</span> MqttException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// MemoryPersistence设置clientid的保存形式，默认为以内存保存</span></div><div class="line">        client = <span class="keyword">new</span> MqttClient(HOST, clientid, <span class="keyword">new</span> MemoryPersistence());</div><div class="line">        connect();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  用来连接服务器</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        MqttConnectOptions options = <span class="keyword">new</span> MqttConnectOptions();</div><div class="line">        <span class="comment">// 发布者设置该值好像没啥用处</span></div><div class="line">        <span class="comment">// options.setCleanSession(false);</span></div><div class="line">        options.setUserName(userName);</div><div class="line">        options.setPassword(passWord.toCharArray());</div><div class="line">        <span class="comment">// 设置超时时间</span></div><div class="line">        options.setConnectionTimeout(<span class="number">10</span>);</div><div class="line">        <span class="comment">// 设置会话心跳时间</span></div><div class="line">        options.setKeepAliveInterval(<span class="number">20</span>);</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            client.setCallback(<span class="keyword">new</span> PushCallback());</div><div class="line">            client.connect(options);</div><div class="line"></div><div class="line">            topic02 = client.getTopic(TOPIC);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (Exception e)</div><div class="line">        &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> MqttPersistenceException</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> MqttException</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(MqttTopic topic , MqttMessage message)</span> <span class="keyword">throws</span> MqttPersistenceException,</span></div><div class="line"><span class="function">            MqttException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        MqttDeliveryToken token = topic.publish(message);</div><div class="line">        token.waitForCompletion();</div><div class="line">        System.out.println(<span class="string">"message is published completely! "</span> + token.isComplete());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *  启动入口</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> MqttException</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MqttException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        ServerMQTT server = <span class="keyword">new</span> ServerMQTT();</div><div class="line">        server.message = <span class="keyword">new</span> MqttMessage();</div><div class="line">        server.message.setQos(<span class="number">2</span>);</div><div class="line">        <span class="comment">// 设置为true表示让mqtt代理保存topic最后一次消息。当有新的订阅者订阅该topic时，可以收到该消息。</span></div><div class="line">        <span class="comment">// 最常用的是记录发布者的在线和离线信息信息。也就是每个订阅者订阅topic时，知道发布者目前在线还是离线。</span></div><div class="line">        server.message.setRetained(<span class="keyword">false</span>);</div><div class="line">        server.message.setPayload(<span class="string">"hello,topic02 02"</span>.getBytes());</div><div class="line">        server.publish(server.topic02 , server.message);</div><div class="line">        System.out.println(server.message.isRetained() + <span class="string">"------ratained状态"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttClient;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttConnectOptions;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttException;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttTopic;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientMQTT</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"tcp://127.0.0.1:1883"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC = <span class="string">"topic02"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String clientid = <span class="string">"client02"</span>;</div><div class="line">    <span class="keyword">private</span> MqttClient client;</div><div class="line">    <span class="keyword">private</span> MqttConnectOptions options;</div><div class="line">    <span class="keyword">private</span> String userName = <span class="string">"admin"</span>;</div><div class="line">    <span class="keyword">private</span> String passWord = <span class="string">"admin1"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ScheduledExecutorService scheduler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// host为主机名，clientid即连接MQTT的客户端ID，一般以唯一标识符表示，MemoryPersistence设置clientid的保存形式，默认为以内存保存</span></div><div class="line">            client = <span class="keyword">new</span> MqttClient(HOST, clientid, <span class="keyword">new</span> MemoryPersistence());</div><div class="line">            <span class="comment">// MQTT的连接设置</span></div><div class="line">            options = <span class="keyword">new</span> MqttConnectOptions();</div><div class="line">            <span class="comment">// 设置是否清空session,这里如果设置为false表示服务器会保留客户端的连接记录</span></div><div class="line">            <span class="comment">// 如果设置为true表示每次连接到服务器都以新的身份连接</span></div><div class="line">            <span class="comment">// 发布者qos设置为2，我们是希望每个消息都接受到一次，需要保存订阅信息，否则重新连接后接收不到发布的消息。</span></div><div class="line">            options.setCleanSession(<span class="keyword">false</span>);</div><div class="line">            <span class="comment">// 设置连接的用户名</span></div><div class="line">            options.setUserName(userName);</div><div class="line">            <span class="comment">// 设置连接的密码</span></div><div class="line">            options.setPassword(passWord.toCharArray());</div><div class="line">            <span class="comment">// 设置超时时间 单位为秒</span></div><div class="line">            options.setConnectionTimeout(<span class="number">10</span>);</div><div class="line">            <span class="comment">// 设置会话心跳时间 单位为秒 服务器会每隔1.5*20秒的时间向客户端发送个消息判断客户端是否在线，但这个方法并没有重连的机制</span></div><div class="line">            options.setKeepAliveInterval(<span class="number">20</span>);</div><div class="line">            <span class="comment">// 设置回调</span></div><div class="line">            client.setCallback(<span class="keyword">new</span> PushCallback());</div><div class="line">            MqttTopic topic = client.getTopic(<span class="string">"status"</span>);</div><div class="line">            <span class="comment">//setWill方法，如果项目中需要知道客户端是否掉线可以调用该方法。设置最终端口的通知消息</span></div><div class="line">            options.setWill(topic, <span class="string">"offline"</span>.getBytes(), <span class="number">2</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">            client.connect(options);</div><div class="line">            <span class="comment">//订阅消息</span></div><div class="line">            <span class="comment">// int[] Qos  = &#123;2&#125;;</span></div><div class="line">            String[] topic02 = &#123;TOPIC&#125;;</div><div class="line">            client.subscribe(topic02);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (Exception e)</div><div class="line">        &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MqttException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        ClientMQTT client = <span class="keyword">new</span> ClientMQTT();</div><div class="line">        client.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建回调类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttCallback;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.IMqttDeliveryToken;</div><div class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttMessage;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 发布消息的回调类 </span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 必须实现MqttCallback的接口并实现对应的相关接口方法CallBack 类将实现 MqttCallBack。 </span></div><div class="line"><span class="comment"> * 每个客户机标识都需要一个回调实例。在此示例中，构造函数传递客户机标识以另存为实例数据。 </span></div><div class="line"><span class="comment"> * 在回调中，将它用来标识已经启动了该回调的哪个实例。</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PushCallback</span> <span class="keyword">implements</span> <span class="title">MqttCallback</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectionLost</span><span class="params">(Throwable cause)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// 连接丢失后，一般在这里面进行重连</span></div><div class="line">        System.out.println(<span class="string">"连接断开，可以做重连"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deliveryComplete</span><span class="params">(IMqttDeliveryToken token)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        System.out.println(<span class="string">"deliveryComplete---------"</span> + token.isComplete());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageArrived</span><span class="params">(String topic, MqttMessage message)</span> <span class="keyword">throws</span> Exception</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// subscribe后得到的消息会执行到这里面</span></div><div class="line">        System.out.println(<span class="string">"接收消息主题 : "</span> + topic);</div><div class="line">        System.out.println(<span class="string">"接收消息Qos : "</span> + message.getQos());</div><div class="line">        System.out.println(<span class="string">"接收消息内容 : "</span> + <span class="keyword">new</span> String(message.getPayload()));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Springboot-MQTT"><a href="#Springboot-MQTT" class="headerlink" title="Springboot MQTT"></a>Springboot MQTT</h3><ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-integration<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.integration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-integration-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.integration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-integration-mqtt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>配置相关参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">##################</div><div class="line">#  MQTT 配置</div><div class="line">##################</div><div class="line"># 用户名</div><div class="line">mqtt.username=admin</div><div class="line"># 密码</div><div class="line">mqtt.password=admin</div><div class="line"># 推送信息的连接地址，如果有多个，用逗号隔开，如：tcp://127.0.0.1:61613,tcp://192.168.1.61:61613</div><div class="line">mqtt.url=tcp://39.108.78.254:1883</div><div class="line"></div><div class="line">##################</div><div class="line">#  MQTT 生产者</div><div class="line">##################</div><div class="line"># 连接服务器默认客户端ID</div><div class="line">mqtt.producer.clientId=mqttProducer</div><div class="line"># 默认的推送主题，实际可在调用接口时指定</div><div class="line">mqtt.producer.defaultTopic=topic01</div><div class="line"></div><div class="line">##################</div><div class="line">#  MQTT 消费者</div><div class="line">##################</div><div class="line"># 连接服务器默认客户端ID</div><div class="line">mqtt.consumer.clientId=mqttConsumer</div><div class="line"># 默认的接收主题，可以订阅多个Topic，逗号分隔</div><div class="line">mqtt.consumer.defaultTopic=topic01</div></pre></td></tr></table></figure>
</li>
<li><p>配置相关 bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * MQTT配置</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqttConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MqttConfig.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] WILL_DATA;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        WILL_DATA = <span class="string">"offline"</span>.getBytes();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 订阅的bean名称</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANNEL_NAME_IN = <span class="string">"mqttInboundChannel"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 发布的bean名称</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANNEL_NAME_OUT = <span class="string">"mqttOutboundChannel"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.username&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String username;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.password&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String password;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.url&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String url;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.producer.clientId&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String producerClientId;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.producer.defaultTopic&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String producerDefaultTopic;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.consumer.clientId&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String consumerClientId;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mqtt.consumer.defaultTopic&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String consumerDefaultTopic;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT连接器选项</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MqttConnectOptions <span class="title">getMqttConnectOptions</span><span class="params">()</span> </span>&#123;</div><div class="line">        MqttConnectOptions options = <span class="keyword">new</span> MqttConnectOptions();</div><div class="line">        <span class="comment">// 设置是否清空session,这里如果设置为false表示服务器会保留客户端的连接记录，</span></div><div class="line">        <span class="comment">// 这里设置为true表示每次连接到服务器都以新的身份连接</span></div><div class="line">        options.setCleanSession(<span class="keyword">true</span>);</div><div class="line">        <span class="comment">// 设置连接的用户名</span></div><div class="line">        options.setUserName(username);</div><div class="line">        <span class="comment">// 设置连接的密码</span></div><div class="line">        options.setPassword(password.toCharArray());</div><div class="line">        options.setServerURIs(url.split(<span class="string">","</span>));</div><div class="line">        <span class="comment">//options.setAutomaticReconnect(true);</span></div><div class="line">        <span class="comment">//options.isCleanSession(false);</span></div><div class="line">        <span class="comment">//options.setMaxInflight(200);</span></div><div class="line">        <span class="comment">// 设置超时时间 单位为秒</span></div><div class="line">        options.setConnectionTimeout(<span class="number">10</span>);</div><div class="line">        <span class="comment">// 设置会话心跳时间 单位为秒 服务器会每隔1.5*20秒的时间向客户端发送心跳判断客户端是否在线，但这个方法并没有重连的机制</span></div><div class="line">        options.setKeepAliveInterval(<span class="number">20</span>);</div><div class="line">        <span class="comment">// 设置“遗嘱”消息的话题，若客户端与服务器之间的连接意外中断，服务器将发布客户端的“遗嘱”消息。</span></div><div class="line">        options.setWill(<span class="string">"status"</span>, WILL_DATA, <span class="number">2</span>, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span> options;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT客户端</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MqttPahoClientFactory <span class="title">mqttClientFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        DefaultMqttPahoClientFactory factory = <span class="keyword">new</span> DefaultMqttPahoClientFactory();</div><div class="line">        factory.setConnectionOptions(getMqttConnectOptions());</div><div class="line">        <span class="keyword">return</span> factory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT信息通道（生产者）</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span>(name = CHANNEL_NAME_OUT)</div><div class="line">    <span class="function"><span class="keyword">public</span> MessageChannel <span class="title">mqttOutboundChannel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT消息处理器（生产者）</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="meta">@ServiceActivator</span>(inputChannel = CHANNEL_NAME_OUT)</div><div class="line">    <span class="function"><span class="keyword">public</span> MessageHandler <span class="title">mqttOutbound</span><span class="params">()</span> </span>&#123;</div><div class="line">        MqttPahoMessageHandler messageHandler = <span class="keyword">new</span> MqttPahoMessageHandler(</div><div class="line">                producerClientId,</div><div class="line">                mqttClientFactory());</div><div class="line">        messageHandler.setAsync(<span class="keyword">true</span>);</div><div class="line">        messageHandler.setDefaultTopic(producerDefaultTopic);</div><div class="line">        <span class="keyword">return</span> messageHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT消息订阅绑定（消费者）</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MessageProducer <span class="title">inbound</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 可以同时消费（订阅）多个Topic</span></div><div class="line">        MqttPahoMessageDrivenChannelAdapter adapter =</div><div class="line">                <span class="keyword">new</span> MqttPahoMessageDrivenChannelAdapter(</div><div class="line">                        consumerClientId, mqttClientFactory(),</div><div class="line">                        consumerDefaultTopic.split(<span class="string">","</span>));</div><div class="line">        adapter.setCompletionTimeout(<span class="number">5000</span>);</div><div class="line">        adapter.setConverter(<span class="keyword">new</span> DefaultPahoMessageConverter());</div><div class="line">        adapter.setQos(<span class="number">2</span>);</div><div class="line">        <span class="comment">// 设置订阅通道</span></div><div class="line">        adapter.setOutputChannel(mqttInboundChannel());</div><div class="line">        <span class="keyword">return</span> adapter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT信息通道（消费者）</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span>(name = CHANNEL_NAME_IN)</div><div class="line">    <span class="function"><span class="keyword">public</span> MessageChannel <span class="title">mqttInboundChannel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectChannel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * MQTT消息处理器（消费者）</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="meta">@ServiceActivator</span>(inputChannel = CHANNEL_NAME_IN)</div><div class="line">    <span class="function"><span class="keyword">public</span> MessageHandler <span class="title">handler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MessageHandler() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message&lt;?&gt; message)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</div><div class="line">                LOGGER.error(<span class="string">"====================&#123;&#125;============"</span>, message.getPayload());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建生产者接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * MQTT生产者消息发送接口</span></div><div class="line"><span class="comment"> * &lt;p&gt;MessagingGateway要指定生产者的通道名称&lt;/p&gt;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@MessagingGateway</span>(defaultRequestChannel = MqttConfig.CHANNEL_NAME_OUT)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMqttSender</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 发送信息到MQTT服务器</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> data 发送的文本</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendToMqtt</span><span class="params">(String data)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 发送信息到MQTT服务器</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> topic 主题</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> payload 消息主体</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendToMqtt</span><span class="params">(@Header(MqttHeaders.TOPIC)</span> String topic,</span></div><div class="line"><span class="function">                    String payload)</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 发送信息到MQTT服务器</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> topic 主题</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> qos </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> payload 消息主体</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendToMqtt</span><span class="params">(@Header(MqttHeaders.TOPIC)</span> String topic,</span></div><div class="line"><span class="function">                    @<span class="title">Header</span><span class="params">(MqttHeaders.QOS)</span> <span class="keyword">int</span> qos,</span></div><div class="line"><span class="function">                    String payload)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>测试<br>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * SpringBoot 入口类</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@SpringBootApplication</span>(exclude = &#123;DataSourceAutoConfiguration.class,</div><div class="line">        HibernateJpaAutoConfiguration.class&#125;)</div><div class="line"><span class="meta">@PropertySource</span>(encoding = <span class="string">"UTF-8"</span>, value = &#123;<span class="string">"classpath:mqtt.properties"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>测试 controller 类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * MQTT消息发送</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqttController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 注入发送MQTT的Bean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> IMqttSender iMqttSender;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 发送MQTT消息</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息内容</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 返回</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/mqtt"</span>, produces =<span class="string">"text/html"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">sendMqtt</span><span class="params">(@RequestParam(value = <span class="string">"msg"</span>)</span> String message) </span>&#123;</div><div class="line">        iMqttSender.sendToMqtt(message);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="string">"OK"</span>, HttpStatus.OK);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/mqtt/">mqtt</a></div><div class="post-nav"><a href="/2019-11-09-2019-11-09_Kafka 学习笔记（一）.html" class="next">Kafka 学习笔记（一）</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Oracle/">Oracle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PGP/">PGP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SFTP/">SFTP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mqtt/">mqtt</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019-11-09-2019-11-09_mqtt 学习笔记.html">mqtt 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-09-2019-11-09_Kafka 学习笔记（一）.html">Kafka 学习笔记（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-08-2019-11-08_Chevereto 搭建个人图床.html">Chevereto 搭建个人图床</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-07-2019-11-07_云服务器的使用.html">云服务器的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-08-08-2019-08-08_MongDB 学习笔记.html">MongoDB 简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-05-16-2019-05-16_NoSQL 实践.html">NoSQL 实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-03-25-2018-03-25_Linux 基础.html">Linux 基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-03-25-2018-03-25_Oracle 基础（一）.html">Oracle 基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-03-25-2018-03-25_Samba 入门.html">Samba 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-03-05-2018-03-05_使用 jsch-0.1.54 实现 SFTP 的上传和下载.html">使用 jsch-0.1.54 实现 SFTP 的上传和下载</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>