<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>SpringCloud学习(七) | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SpringCloud学习(七)</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SpringCloud学习(七)</h1><div class="post-meta">Oct 3, 2020<span> | </span><span class="category"><a href="/categories/SpringCloud/">SpringCloud</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、网关概念"><span class="toc-text">1、网关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、启用网关"><span class="toc-text">2、启用网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-服务搭建"><span class="toc-text">2.1 服务搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-配置负载均衡"><span class="toc-text">2.2 配置负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-路由端点"><span class="toc-text">2.3 路由端点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-微服务路由-routes"><span class="toc-text">2.4 微服务路由(routes)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-忽略微服务-ignored-services"><span class="toc-text">2.5 忽略微服务(ignored-services)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-前缀"><span class="toc-text">2.6 前缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-查看路由日志"><span class="toc-text">2.7 查看路由日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-敏感-Header"><span class="toc-text">2.8 敏感 Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-过滤器"><span class="toc-text">2.9 过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-接口容错"><span class="toc-text">2.10 接口容错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-限流"><span class="toc-text">2.11 限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-高可用"><span class="toc-text">2.12 高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、网关原理和源码"><span class="toc-text">3、网关原理和源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、链路追踪"><span class="toc-text">3、链路追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-分布式计算八大误区"><span class="toc-text">3.1 分布式计算八大误区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-链路追踪的必要性"><span class="toc-text">3.2 链路追踪的必要性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-链路追踪要考虑的几个问题"><span class="toc-text">3.3 链路追踪要考虑的几个问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Sleuth-简介"><span class="toc-text">3.4 Sleuth 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Sleuth-单独使用"><span class="toc-text">3.5 Sleuth 单独使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-zipkin"><span class="toc-text">3.6 zipkin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、SpringCloud-Admin-健康检查"><span class="toc-text">4、SpringCloud Admin 健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Admin-服务搭建"><span class="toc-text">4.1 Admin 服务搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-微服务端"><span class="toc-text">4.2 微服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-邮件通知"><span class="toc-text">4.3 邮件通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-钉钉群通知"><span class="toc-text">4.4 钉钉群通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动类ding"><span class="toc-text">启动类ding</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通知类"><span class="toc-text">通知类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#发送工具类"><span class="toc-text">发送工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消息类"><span class="toc-text">消息类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#微信通知"><span class="toc-text">微信通知</span></a></li></ol></li></ol></div></div><div class="post-content"><ul>
<li>网关</li>
<li>链路追踪</li>
<li>SpringCloud Admin</li>
</ul>
<a id="more"></a>
<h2 id="1、网关概念"><a href="#1、网关概念" class="headerlink" title="1、网关概念"></a>1、网关概念</h2><p>服务治理，服务注册发现，服务调用，熔断。已经学完。</p>
<p>微服务基本模块已经有了，也可以做微服务了。但完成一个复杂的业务，可能需要多个微服务合作来完成，比如下单，需要用户服务，支付服务，地图服务，订单服务。一般是我们对外服务的窗口，进行服务内外隔离。一般微服务都在内网，不做安全验证。</p>
<p>就好像：很多明星，可以独立开演唱会（独立提供服务）。也可以去春晚（微服务群提供服务）。但一台春晚就不能让 观众一个一个调用了。观众要调用，需要检票啥的，检票就类似于网关，进来之后，界面随便看，不会说你 看个小品，还需要再检票。</p>
<p>微服务没有网关，会有下面的问题：</p>
<ol>
<li><p>客户端请求多个微服务，增加了客户端复杂性，每个微服务都要做用户认证，限流等，避免和多个微服务打交道的复杂性。</p>
</li>
<li><p>有跨域问题，不在同一个域。</p>
</li>
<li><p>认证复杂，每个服务都要独立认证，服务要求的权限不一致。</p>
</li>
<li><p>难以重构。因为微服务被客户端调用着，重构难以实施。</p>
</li>
</ol>
<p>网关是介于客户端（外部调用方比如app，h5）和微服务的中间层。</p>
<p>Zuul 是 Netflix 开源的微服务网关，核心是一系列<strong>过滤器</strong>。这些过滤器可以完成以下功能。</p>
<ol>
<li>是所有微服务入口，进行分发。</li>
<li>身份认证与安全。识别合法的请求，拦截不合法的请求。</li>
<li>监控。在入口处监控，更全面。</li>
<li>动态路由。动态将请求分发到不同的后端集群。</li>
<li>压力测试。可以逐渐增加对后端服务的流量，进行测试。</li>
<li>负载均衡。也是用ribbon。</li>
<li>限流（望京超市）。比如我每秒只要1000次，10001次就不让访问了。</li>
<li>服务熔断</li>
</ol>
<p>网关和服务的关系：演员和剧场检票人员的关系。</p>
<p>zuul默认集成了：ribbon 和 hystrix。</p>
<p>前后端分离的服务器端渲染。如果客户端渲染打开页面可能非常慢，因为浏览器还需要不停解析各种东西，而且还要请求不同的接口。一是解析时间，而是二次网络请求时间。</p>
<p>基于隧道模式的网关就是业务网关。Nginx 也是隧道模式。</p>
<p>可优化的点：使用单点登录实现无状态；通过异步优化线程。</p>
<p>瓶颈在吞吐量。</p>
<p>路由模式（DR）：LVS</p>
<p>流量网关：</p>
<p>业务网关：</p>
<p>所有拒绝策略尽量前置。</p>
<h2 id="2、启用网关"><a href="#2、启用网关" class="headerlink" title="2、启用网关"></a>2、启用网关</h2><h3 id="2-1-服务搭建"><a href="#2-1-服务搭建" class="headerlink" title="2.1 服务搭建"></a>2.1 服务搭建</h3><p>新建项目引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.port=80</div><div class="line">spring.application.name=zuul-server</div><div class="line">eureka.client.service-url.defaultZone=http://alvin:pass9876@localhost:8761/eureka/</div></pre></td></tr></table></figure>
<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@EnableZuulProxy</span></div></pre></td></tr></table></figure>
<p>测试访问。网关会将服务名转换成具体服务的ip和端口，实际进行访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 通过 网关ip:网关端口/服务名/资源名 访问资源</span></div><div class="line">http://localhost/ribbon-consumer/test/user/1</div><div class="line">http://localhost/hello-service/user/2</div></pre></td></tr></table></figure>
<h3 id="2-2-配置负载均衡"><a href="#2-2-配置负载均衡" class="headerlink" title="2.2 配置负载均衡"></a>2.2 配置负载均衡</h3><p>启动两个Consumer</p>
<p>轮询访问上面地址，会看到返回结果中，端口一直轮询在变。说明负载均衡生效了，默认是轮询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">consumer.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule</div></pre></td></tr></table></figure>
<p>访问测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/ribbon-consumer/zuul/1</div></pre></td></tr></table></figure>
<h3 id="2-3-路由端点"><a href="#2-3-路由端点" class="headerlink" title="2.3 路由端点"></a>2.3 路由端点</h3><p>调试的时候，看网关请求的地址，以及映射是否正确。网关请求有误时，可以通过此处排查错误。</p>
<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">management.endpoints.web.exposure.include=*</div><div class="line"># 默认是never</div><div class="line">management.endpoint.health.show-details=always</div><div class="line">management.endpoint.health.enabled=true</div><div class="line">management.endpoint.routes.enabled=true</div></pre></td></tr></table></figure>
<p>通过端点查看路由映射：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 访问地址：http://localhost/actuator/routes</span></div><div class="line">&#123;</div><div class="line">  "/xxoo/**": "ribbon-consumer",</div><div class="line">  "/xx/**": "http://mashibing.com",</div><div class="line">  "/oo/**": "hello-service",</div><div class="line">  "/ribbon-consumer/**": "ribbon-consumer"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-4-微服务路由-routes"><a href="#2-4-微服务路由-routes" class="headerlink" title="2.4 微服务路由(routes)"></a>2.4 微服务路由(routes)</h3><ol>
<li>通过服务名配置（虚拟主机名）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 方法一</div><div class="line">zuul.routes.ribbon-consumer=/xxoo/**</div><div class="line"># 方法二</div><div class="line">zuul.routes.ooxx.path=/ooxx/**</div><div class="line">zuul.routes.ooxx.service-id=ribbon-consumer</div><div class="line"></div><div class="line"># 正常访问</div><div class="line">http://localhost/xxoo/zuul/1</div><div class="line">http://localhost/ooxx/zuul/1</div><div class="line">http://localhost/ribbon-consumer/zuul/1</div></pre></td></tr></table></figure>
<ol>
<li>自定义命名配置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">zuul.routes.xx.path=/xx/**</div><div class="line">zuul.routes.xx.url=http://mashibing.com</div><div class="line"></div><div class="line"># 成功跳转到 http://mashibing.com/vip.html</div><div class="line">http://localhost/xx/vip.html</div></pre></td></tr></table></figure>
<ol>
<li>自定义下的负载均衡</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 自定义负载均衡</div><div class="line">cuid.ribbon.listOfServers=localhost:82,localhost:83</div><div class="line">ribbon.eureka.enabled=false</div></pre></td></tr></table></figure>
<h3 id="2-5-忽略微服务-ignored-services"><a href="#2-5-忽略微服务-ignored-services" class="headerlink" title="2.5 忽略微服务(ignored-services)"></a>2.5 忽略微服务(ignored-services)</h3><p><strong>根据服务名忽略</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 设置忽略的微服务</div><div class="line"># 就是把默认的 &quot;/ribbon-consumer/**&quot;: &quot;ribbon-consumer&quot; 条目去掉</div><div class="line">zuul.ignored-services=ribbon-consumer</div><div class="line"></div><div class="line"># 访问失败</div><div class="line">http://localhost/ribbon-consumer/zuul/1</div><div class="line"># 访问成功</div><div class="line">http://localhost/ooxx/zuul/1</div></pre></td></tr></table></figure>
<p><strong>正则匹配忽略</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 忽略正则，不能通过 zuul-api-driver 和 api-driver访问。</div><div class="line">zuul.ignored-patterns=/*-driver/**</div></pre></td></tr></table></figure>
<h3 id="2-6-前缀"><a href="#2-6-前缀" class="headerlink" title="2.6 前缀"></a>2.6 前缀</h3><p>接口一般命名：/api/v1/xxxx。</p>
<p>可以在网关配置前缀，访问时带上前缀，实际请求会将前缀去掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">zuul.prefix=/api/v1</div><div class="line"># 是否脱去前缀</div><div class="line">zuul.strip-prefix=true</div><div class="line"></div><div class="line"># 访问失败 404</div><div class="line">http://localhost/ooxx/zuul/1</div><div class="line"># 访问成功</div><div class="line">http://localhost/api/v1/ooxx/zuul/1</div><div class="line"></div><div class="line"># 指定服务配置</div><div class="line">zuul.routes.ribbon-consumer.strip-prefix=true</div></pre></td></tr></table></figure>
<h3 id="2-7-查看路由日志"><a href="#2-7-查看路由日志" class="headerlink" title="2.7 查看路由日志"></a>2.7 查看路由日志</h3><p>修改日志级别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">logging.level.com.netflix=debug</div><div class="line">logging.level.org.springframework=debug</div></pre></td></tr></table></figure>
<p>访问接口，然后查看后台日志</p>
<p><img src="../../images/springcloud/5/查看网关日志.png" alt=""></p>
<h3 id="2-8-敏感-Header"><a href="#2-8-敏感-Header" class="headerlink" title="2.8 敏感 Header"></a>2.8 敏感 Header</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"zuulTestFilter"</span>, urlPatterns = <span class="string">"/**"</span>)</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulSensitiveHeaderTestFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"></div><div class="line">        HttpServletRequest req = (HttpServletRequest)servletRequest;</div><div class="line">        String token = req.getHeader(<span class="string">"token"</span>);</div><div class="line">        System.out.println(<span class="string">"====&gt;token:"</span>+token);</div><div class="line">        filterChain.doFilter(servletRequest, servletResponse);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"zuulTestFilter init...."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 敏感 header，不向下游传递。header 中为 token 的条目不向下传递</div><div class="line">zuul.sensitive-headers=token</div><div class="line"></div><div class="line"># 测试 postman 增加 header token</div><div class="line">http://localhost/ooxx/zuul/1</div></pre></td></tr></table></figure>
<h3 id="2-9-过滤器"><a href="#2-9-过滤器" class="headerlink" title="2.9 过滤器"></a>2.9 过滤器</h3><p>Zuul 的大部分功能都是有过滤器实现的。</p>
<p><strong>4 种过滤器</strong></p>
<ul>
<li>PRE：在请求被路由之前调用，可利用这种过滤器<strong>实现身份验证</strong>。选择微服务，记录日志。</li>
<li>ROUTING：在将请求路由到微服务调用，用于构建发送给微服务的请求，并用 http clinet（或者ribbon）请求微服务。</li>
<li>POST：在调用微服务执行后。可用于<strong>添加 header，记录日志</strong>，将响应发给客户端。</li>
<li>ERROR：在其他阶段发生错误时，走此过滤器。</li>
</ul>
<p><strong>自定义过滤器</strong></p>
<p>继承 <strong>ZuulFilter</strong> 即可。4 个注意点。</p>
<ul>
<li>filterType：pre，routing,post,error</li>
<li>filterOrder：执行顺序，在谁前，在谁后，可以+1，-1</li>
<li>shouldFilter：此过滤器是否执行，true  false，可以写过滤器是否执行的判断条件。</li>
<li>run：具体执行逻辑。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 当前过滤器是否生效</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//获取上下文（重要，贯穿 所有filter，包含所有参数）</span></div><div class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</div><div class="line">        HttpServletRequest request = requestContext.getRequest();</div><div class="line"></div><div class="line">        String uri = request.getRequestURI();</div><div class="line">        System.out.println(<span class="string">"pre来源uri："</span>+uri);</div><div class="line">        <span class="comment">// 实际中应该根据具体业务，判断返回 true 还是 false</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"pre拦截"</span>);</div><div class="line">        <span class="comment">//获取上下文</span></div><div class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</div><div class="line">        HttpServletRequest request = requestContext.getRequest();</div><div class="line"></div><div class="line">        String token = request.getHeader(<span class="string">"token"</span>);</div><div class="line">        System.out.println(<span class="string">"pre 业务逻辑 token:"</span>+token);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> FilterConstants.PRE_TYPE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 相同类型，值越小越先执行</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http://localhost/ooxx/zuul/1</div><div class="line"></div><div class="line">pre来源uri：/ooxx/zuul/1</div><div class="line">pre拦截</div><div class="line">pre 业务逻辑 token:test sensitive headers</div></pre></td></tr></table></figure>
<p><strong>利用 filter 实现鉴权</strong></p>
<p>为啥<code>setSendZuulResponse(false)</code>后，还是会走后边的 filter？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"auth 拦截"</span>);</div><div class="line">        <span class="comment">//获取上下文（重要，贯穿 所有filter，包含所有参数）</span></div><div class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</div><div class="line">        HttpServletRequest request = requestContext.getRequest();</div><div class="line">        String token = request.getHeader(<span class="string">"token"</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String parseToken = JwtUtil.parseToken(token);</div><div class="line">            <span class="keyword">if</span>(StringUtils.isNotBlank(parseToken)) &#123;</div><div class="line">                System.out.println(<span class="string">"auth filter:校验通过"</span>);</div><div class="line">                request.getSession().setAttribute(<span class="string">"t1"</span>, <span class="string">"t1attr"</span>);</div><div class="line">                requestContext.setSendZuulResponse(<span class="keyword">true</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 不往下的过滤器继续了</span></div><div class="line">                requestContext.setSendZuulResponse(<span class="keyword">false</span>);</div><div class="line">                requestContext.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</div><div class="line">                requestContext.setResponseBody(<span class="string">"认证失败"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            System.out.println(<span class="string">"auth filter:token校验失败"</span>);</div><div class="line">            <span class="comment">// 不往下的过滤器继续了</span></div><div class="line">            requestContext.setSendZuulResponse(<span class="keyword">false</span>);</div><div class="line">            requestContext.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</div><div class="line">            requestContext.setResponseBody(<span class="string">"认证失败"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//获取上下文</span></div><div class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</div><div class="line">        HttpServletRequest request = requestContext.getRequest();</div><div class="line">        String uri = request.getRequestURI();</div><div class="line">        String token = request.getHeader(<span class="string">"token"</span>);</div><div class="line">        System.out.println(<span class="string">"auth 来源uri："</span>+uri + <span class="string">"；token："</span>+token);</div><div class="line">        <span class="comment">// 自己测试用，实际应该根据业务来处理</span></div><div class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> FilterConstants.PRE_TYPE;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-10-接口容错"><a href="#2-10-接口容错" class="headerlink" title="2.10 接口容错"></a>2.10 接口容错</h3><p><strong>Fallback组件</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulFallback</span> <span class="keyword">implements</span> <span class="title">FallbackProvider</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 表明为哪个微服务提供回退</span></div><div class="line"><span class="comment">     * 服务Id ，若需要所有服务调用都支持回退，返回null 或者 * 即可</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"*"</span>;</div><div class="line">        <span class="comment">// 下面是单独的微服务</span></div><div class="line">        <span class="comment">// return "api-passenger";</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">(String route, Throwable cause)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> HystrixTimeoutException) &#123;</div><div class="line">            <span class="keyword">return</span> response(HttpStatus.GATEWAY_TIMEOUT);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> response(HttpStatus.INTERNAL_SERVER_ERROR);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> ClientHttpResponse <span class="title">response</span><span class="params">(<span class="keyword">final</span> HttpStatus status)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClientHttpResponse() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> HttpStatus <span class="title">getStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                <span class="comment">//return status;</span></div><div class="line">                <span class="keyword">return</span> HttpStatus.BAD_REQUEST;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                <span class="comment">//return status.value();</span></div><div class="line">                <span class="keyword">return</span> HttpStatus.BAD_REQUEST.value();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                <span class="comment">//return status.getReasonPhrase();</span></div><div class="line">                <span class="comment">//return HttpStatus.BAD_REQUEST.name();</span></div><div class="line">                <span class="keyword">return</span> HttpStatus.BAD_REQUEST.getReasonPhrase();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> InputStream <span class="title">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                String msg = <span class="string">"&#123;\"msg\":\"服务故障\"&#125;"</span>;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(msg.getBytes());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> HttpHeaders <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</div><div class="line">                HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</div><div class="line">                headers.setContentType(MediaType.APPLICATION_JSON);</div><div class="line">                <span class="keyword">return</span> headers;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>停止 user-consumer 服务。访问 <code>http://localhost/ooxx/zuul/1</code>，成功进入 fallback。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"msg"</span>: <span class="string">"服务故障"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-11-限流"><a href="#2-11-限流" class="headerlink" title="2.11 限流"></a>2.11 限流</h3><p><img src="../../images/springcloud/5/网关流程.png" alt=""></p>
<p>保护自己，用 ratelimit。</p>
<p>令牌桶</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">假设进入高速公路的车辆需要在入口处领取到通行卡才能进入高速公路。为了节约人力成本，入口处放置自动出卡机。按照国家高速公路交通安全法的规定，在高速公路上行驶的车辆，车速超过 100km/h 时，应与同车道前车保持 100 米以上距离。为了保持最小安全行车距离 100 米，按车速 100km/h 计算，需要间隔至少 3.6 秒才能放行一辆车，因此出卡机每隔 3.6 秒出一张通行卡。在自动出卡机下放置一个盒子，自动出卡机按照 3.6 秒的间隔向盒子中投放通行卡。每辆进入高速公路的车辆，从盒子中领取通行卡之后才可以进入高速公路。</div><div class="line"></div><div class="line">令牌桶可以看作是一个存放一定数量令牌的容器。系统按设定的速度向桶中放置令牌。当桶中令牌满时，多出的令牌溢出，桶中令牌不再增加。在使用令牌桶对流量规格进行评估时，是以令牌桶中的令牌数量是否足够满足报文的转发为依据的。每个需要被转发的报文，都要从令牌桶中领取一定数量的令牌（具体数量视报文大小而定），才可以被正常转发。如果桶中存在足够的令牌可以用来转发报文，称流量遵守或符合约定值，否则称为不符合或超标。</div></pre></td></tr></table></figure>
<p><strong>使用令牌限流 filter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 如果是1，表示每秒1个令牌，实际通过压测获得</span></div><div class="line"><span class="comment">     * 1、创建一个稳定输出令牌的RateLimiter，保证了平均每秒不超过permitsPerSecond个请求</span></div><div class="line"><span class="comment">     * 2、当请求到来的速度超过了permitsPerSecond，保证每秒只处理permitsPerSecond个请求</span></div><div class="line"><span class="comment">     * 3、当这个RateLimiter使用不足(即请求到来速度小于permitsPerSecond)，会囤积最多permitsPerSecond个请求</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RateLimiter RATE_LIMITER  = RateLimiter.create(<span class="number">5</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 此处可以写判断地址</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</div><div class="line">        <span class="comment">//获取上下文</span></div><div class="line">        RequestContext requestContext = RequestContext.getCurrentContext();</div><div class="line">        HttpServletRequest request = requestContext.getRequest();</div><div class="line"></div><div class="line">        requestContext.set(<span class="string">"f"</span>, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 拿不到令牌马上返回。尝试获取桶里的令牌，如果有，则返回true，</span></div><div class="line"><span class="comment">         *并且，总的令牌数减1。没有则返回false。</span></div><div class="line"><span class="comment">         */</span></div><div class="line">		<span class="keyword">if</span>(!RATE_LIMITER.tryAcquire()) &#123;</div><div class="line">            System.out.println(<span class="string">"rate filter 拿不到令牌，被限流了"</span>+count++);</div><div class="line">            requestContext.setSendZuulResponse(<span class="keyword">false</span>);</div><div class="line">            requestContext.setResponseStatusCode(HttpStatus.TOO_MANY_REQUESTS.value());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.println(<span class="string">"rate filter OK"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> FilterConstants.PRE_TYPE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 限流要最早</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> -<span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>启动jmeter，双击：jmeter.bat</p>
</li>
<li><p>右击TestPlan,add ,Threads,Thread Group</p>
</li>
<li><p>右击测试令牌桶线程组，add，sampler, http request。</p>
</li>
<li><p>在线程组：</p>
<p>1、Number of Threads（users）：用户个数</p>
<p>2、Ramp-up Period（in seconds）：在多长时间内，加载指定的用户个数，单位为s。</p>
<p>假如需加载 100 个用户，在5s中之内加载完成，那么平均每秒钟加载20个用户。</p>
<p>3、Loop Count（循环次数）：用户执行操作的循环次数，如果选择forever，则永远循环下去。</p>
</li>
</ol>
<p><strong>测试点：</strong></p>
<p>   令牌桶设置成 5，jemter 设置 40 个用户 10 秒完成。全部正常。</p>
<p>   令牌桶设置成 5，jemter 设置 60 个用户 10 秒完成。部分请求被限流</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rate filter OK</div><div class="line">rate filter OK</div><div class="line">rate filter 拿不到令牌，被限流了21</div></pre></td></tr></table></figure>
<h3 id="2-12-高可用"><a href="#2-12-高可用" class="headerlink" title="2.12 高可用"></a>2.12 高可用</h3><p>一般做法</p>
<p>前面架上nginx。</p>
<p>zuul 作为普通的服务。对外访问。前面加一层（nginx+keepalived）</p>
<h2 id="3、网关原理和源码"><a href="#3、网关原理和源码" class="headerlink" title="3、网关原理和源码"></a>3、网关原理和源码</h2><p>让我们做，如何实现？</p>
<p>方案：请求过来-&gt;pre（一组，鉴权，限流之类的。）-&gt;route（一组，路由到别的服务，具体微服务。）-&gt;post（一组，处理响应）。</p>
<p>zuul 本质就是 filter。</p>
<p>通过 filter 解析 url 来决定我们去访问哪个微服务。</p>
<p>发请求访问微服务，也是通过 filter 实现。</p>
<p>响应数据，也是通过 filter 实现。</p>
<h2 id="3、链路追踪"><a href="#3、链路追踪" class="headerlink" title="3、链路追踪"></a>3、链路追踪</h2><h3 id="3-1-分布式计算八大误区"><a href="#3-1-分布式计算八大误区" class="headerlink" title="3.1 分布式计算八大误区"></a>3.1 分布式计算八大误区</h3><ul>
<li><p>网络可靠。</p>
</li>
<li><p>延迟为零。</p>
</li>
<li><p>带宽无限。</p>
</li>
<li><p>网络绝对安全。</p>
</li>
<li><p>网络拓扑不会改变。</p>
</li>
<li><p>必须有一名管理员。</p>
</li>
<li><p>传输成本为零。</p>
</li>
<li><p>网络同质化。（操作系统，协议）</p>
</li>
</ul>
<h3 id="3-2-链路追踪的必要性"><a href="#3-2-链路追踪的必要性" class="headerlink" title="3.2 链路追踪的必要性"></a>3.2 链路追踪的必要性</h3><p>如果能跟踪每个请求，中间请求<strong>经过哪些微服务，请求耗时，网络延迟，业务逻辑耗时</strong>等。我们就能更好地分析系统瓶颈、解决系统问题。因此链路跟踪很重要。</p>
<p>我们自己思考解决方案：在调用前后加时间戳。捕获异常。</p>
<p>链路追踪目的：解决错综复杂的服务调用中<strong>链路的查看</strong>。<strong>排查慢服务</strong>。</p>
<p>市面上链路追踪产品，大部分基于 google 的 Dapper 论文。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">zipkin,twitter 开源的。是严格按照谷歌的 Dapper 论文来的。</div><div class="line">pinpoint 韩国的 Naver 公司的。</div><div class="line">Cat 美团点评的</div><div class="line">EagleEye 淘宝的</div></pre></td></tr></table></figure>
<h3 id="3-3-链路追踪要考虑的几个问题"><a href="#3-3-链路追踪要考虑的几个问题" class="headerlink" title="3.3 链路追踪要考虑的几个问题"></a>3.3 链路追踪要考虑的几个问题</h3><ol>
<li>探针的性能消耗。尽量不影响服务本尊。</li>
<li>易用。开发可以很快接入，别浪费太多精力。</li>
<li>数据分析。要实时分析。维度足够。</li>
</ol>
<h3 id="3-4-Sleuth-简介"><a href="#3-4-Sleuth-简介" class="headerlink" title="3.4 Sleuth 简介"></a>3.4 Sleuth 简介</h3><p>Sleuth 是 Spring cloud 的分布式跟踪解决方案。</p>
<ol>
<li><p>span(跨度)，基本工作单元。一次链路调用，创建一个 span，</p>
<p>span 用一个 64 位 id 唯一标识。包括：id，描述，时间戳事件，spanId,span 父 id。</p>
<p>span 被启动和停止时，记录了时间信息，初始化 span 叫：root span，它的 span id 和 trace id 相等。</p>
</li>
<li><p>trace(跟踪)，一组共享“root span”的span组成的树状结构 称为 trace，trace 也有一个 64 位 ID，trace 中所有 span 共享一个 trace id。类似于一颗 span 树。</p>
</li>
<li><p>annotation（标签），annotation用来记录事件的存在，其中，核心 annotation 用来定义请求的开始和结束。</p>
<ul>
<li>CS(Client Send客户端发起请求)。客户端发起请求描述了span开始。</li>
<li>SR(Server Received服务端接到请求)。服务端获得请求并准备处理它。SR-CS=网络延迟。</li>
<li>SS（Server Send服务器端处理完成，并将结果发送给客户端）。表示服务器完成请求处理，响应客户端时。SS-SR=服务器处理请求的时间。</li>
<li>CR（Client Received 客户端接受服务端信息）。span结束的标识。客户端接收到服务器的响应。CR-CS=客户端发出请求到服务器响应的总时间。</li>
</ul>
</li>
</ol>
<p>其实数据结构是一颗树，从root span 开始。</p>
<h3 id="3-5-Sleuth-单独使用"><a href="#3-5-Sleuth-单独使用" class="headerlink" title="3.5 Sleuth 单独使用"></a>3.5 Sleuth 单独使用</h3><p>每个需要监控的系统引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 引入sleuth依赖 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试点：</p>
<ol>
<li>启动 userserver-8001，userserverconsumer-9001，zuul-server-80</li>
<li>访问一次。看日志结果。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[api-driver,1a409c98e7a3cdbf,1a409c98e7a3cdbf,<span class="literal">true</span>] </div><div class="line"> </div><div class="line">[服务名称，traceId（一条请求调用链中 唯一ID），spanID（基本的工作单元，获取数据等），是否让zipkin收集和展示此信息]</div><div class="line"></div><div class="line">看下游</div><div class="line">[service-sms,1a409c98e7a3cdbf,b3d93470b5cf8434,<span class="literal">true</span>]</div><div class="line"></div><div class="line">traceId，是一样的。</div><div class="line">服务名必须得写。</div></pre></td></tr></table></figure>
<h3 id="3-6-zipkin"><a href="#3-6-zipkin" class="headerlink" title="3.6 zipkin"></a>3.6 zipkin</h3><p>上面拍错看日志，很原始。刀耕火种，加入利器 zipkin。zipkin 是twitter 开源的分布式跟踪系统。</p>
<p>原理是收集系统的时序数据，从而追踪微服务架构中系统延时等问题。还有一个友好的界面。</p>
<p><strong>组成</strong>：Collector、Storage、Restful API、Web UI组成。采集器，存储器，接口，UI。</p>
<p><strong>原理</strong>：sleuth 收集跟踪信息通过 http 请求发送给 zipkin server，zipkin 将跟踪信息存储，以及提供 RESTful API 接口，zipkin ui 通过调用 api 进行数据展示。默认内存存储，可以用 mysql，ES 等存储。</p>
<p><strong>操作步骤</strong>：</p>
<ol>
<li>每个需要监听的服务的pom中添加。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- zipkin --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>每个需要监听的服务yml中</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line">  <span class="comment">#zipkin</span></div><div class="line">  zipkin:</div><div class="line">    base-url: http://localhost:9411/</div><div class="line">    <span class="comment">#采样比例1</span></div><div class="line">  sleuth:</div><div class="line">    sampler:</div><div class="line">      rate: 1  </div><div class="line">      </div><div class="line"><span class="comment"># zipkin 服务地址</span></div><div class="line">spring.zipkin.base-url=http://localhost:9411/</div><div class="line"><span class="comment"># 采用比例</span></div><div class="line">spring.sleuth.sampler.rate=1</div></pre></td></tr></table></figure>
<ol>
<li>启动zipkin。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">jar包下载：curl -sSL https://zipkin.io/quickstart.sh | bash -s</div><div class="line">我放到了目录：D:\01_code\03_springbasic\spring-cloud</div><div class="line">java -jar zipkin.jar</div><div class="line">或者docker：</div><div class="line">docker run -d -p 9411:9411 openzipkin/zipkin</div></pre></td></tr></table></figure>
<ol>
<li>验证</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 浏览器访问</span></div><div class="line">http://localhost/ribbon-consumer/test/user/alive</div><div class="line"><span class="meta">#</span><span class="bash"> 后台日志</span></div><div class="line">[zuul-server,ba8d3dcdf72e8a07,ba8d3dcdf72e8a07,true]</div><div class="line">[ribbon-consumer,ba8d3dcdf72e8a07,14b7b2c2a541aa03,true]</div><div class="line"><span class="meta">#</span><span class="bash"> zipkin</span></div><div class="line">zuul-server -&gt; ribbon-consumer -&gt; hello-service</div></pre></td></tr></table></figure>
<h2 id="4、SpringCloud-Admin-健康检查"><a href="#4、SpringCloud-Admin-健康检查" class="headerlink" title="4、SpringCloud Admin 健康检查"></a>4、SpringCloud Admin 健康检查</h2><h3 id="4-1-Admin-服务搭建"><a href="#4-1-Admin-服务搭建" class="headerlink" title="4.1 Admin 服务搭建"></a>4.1 Admin 服务搭建</h3><p>pom 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Admin 服务 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- Admin 界面 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>启动类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@EnableAdminServer</div></pre></td></tr></table></figure>
<h3 id="4-2-微服务端"><a href="#4-2-微服务端" class="headerlink" title="4.2 微服务端"></a>4.2 微服务端</h3><p>pom 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Admin 服务 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">management.endpoints.web.exposure.include=*</div><div class="line">management.endpoint.health.show-details=always</div><div class="line">spring.boot.admin.client.url=http://localhost:8080</div></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:8080/</div></pre></td></tr></table></figure>
<h3 id="4-3-邮件通知"><a href="#4-3-邮件通知" class="headerlink" title="4.3 邮件通知"></a>4.3 邮件通知</h3><ol>
<li><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">spring.mail.host=smtp.qq.com</div><div class="line">spring.mail.username=1109075867</div><div class="line">spring.mail.password=edsgbgljwlxfgjga</div><div class="line">spring.mail.properties.mail.smpt.auth=<span class="literal">true</span></div><div class="line">spring.mail.properties.mail.smpt.starttls.enable=<span class="literal">true</span></div><div class="line">spring.mail.properties.mail.smpt.starttls.required=<span class="literal">true</span></div><div class="line"><span class="comment">#收件邮箱</span></div><div class="line">spring.boot.admin.notify.mail.to=1109075867@qq.com</div><div class="line"><span class="comment"># 发件邮箱</span></div><div class="line">spring.boot.admin.notify.mail.from=1109075867@qq.com</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4-4-钉钉群通知"><a href="#4-4-钉钉群通知" class="headerlink" title="4.4 钉钉群通知"></a>4.4 钉钉群通知</h3><h4 id="启动类ding"><a href="#启动类ding" class="headerlink" title="启动类ding"></a>启动类ding</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableAdminServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminServerApplication</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(AdminServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> DingDingNotifier <span class="title">dingDingNotifier</span><span class="params">(InstanceRepository repository)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DingDingNotifier(repository);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="通知类"><a href="#通知类" class="headerlink" title="通知类"></a>通知类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DingDingNotifier</span> <span class="keyword">extends</span> <span class="title">AbstractStatusChangeNotifier</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DingDingNotifier</span><span class="params">(InstanceRepository repository)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(repository);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">doNotify</span><span class="params">(InstanceEvent event, Instance instance)</span> </span>&#123;</div><div class="line">        String serviceName = instance.getRegistration().getName();</div><div class="line">        String serviceUrl = instance.getRegistration().getServiceUrl();</div><div class="line">        String status = instance.getStatusInfo().getStatus();</div><div class="line">        Map&lt;String, Object&gt; details = instance.getStatusInfo().getDetails();</div><div class="line">        StringBuilder str = <span class="keyword">new</span> StringBuilder();</div><div class="line">        str.append(<span class="string">"服务预警 : 【"</span> + serviceName + <span class="string">"】"</span>);</div><div class="line">        str.append(<span class="string">"【服务地址】"</span> + serviceUrl);</div><div class="line">        str.append(<span class="string">"【状态】"</span> + status);</div><div class="line">        str.append(<span class="string">"【详情】"</span> + JSONObject.toJSONString(details));</div><div class="line">        <span class="keyword">return</span> Mono.fromRunnable(() -&gt; &#123;</div><div class="line">            DingDingMessageUtil.sendTextMessage(str.toString());</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="发送工具类"><a href="#发送工具类" class="headerlink" title="发送工具类"></a>发送工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DingDingMessageUtil</span> </span>&#123;</div><div class="line">	<span class="comment">// 群设置-&gt;只能群助手-&gt;添加机器人-&gt;Token</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String access_token = <span class="string">"Token"</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendTextMessage</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Message message = <span class="keyword">new</span> Message();</div><div class="line">            message.setMsgtype(<span class="string">"text"</span>);</div><div class="line">            message.setText(<span class="keyword">new</span> MessageInfo(msg));</div><div class="line">            URL url = <span class="keyword">new</span> URL(<span class="string">"https://oapi.dingtalk.com/robot/send?access_token="</span> + access_token);</div><div class="line">            <span class="comment">// 建立 http 连接</span></div><div class="line">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</div><div class="line">            conn.setDoOutput(<span class="keyword">true</span>);</div><div class="line">            conn.setDoInput(<span class="keyword">true</span>);</div><div class="line">            conn.setUseCaches(<span class="keyword">false</span>);</div><div class="line">            conn.setRequestMethod(<span class="string">"POST"</span>);</div><div class="line">            conn.setRequestProperty(<span class="string">"Charset"</span>, <span class="string">"UTF-8"</span>);</div><div class="line">            conn.setRequestProperty(<span class="string">"Content-Type"</span>, <span class="string">"application/Json; charset=UTF-8"</span>);</div><div class="line">            conn.connect();</div><div class="line">            OutputStream out = conn.getOutputStream();</div><div class="line">            String textMessage = JSONObject.toJSONString(message);</div><div class="line">            <span class="keyword">byte</span>[] data = textMessage.getBytes();</div><div class="line">            out.write(data);</div><div class="line">            out.flush();</div><div class="line">            out.close();</div><div class="line">            InputStream in = conn.getInputStream();</div><div class="line">            <span class="keyword">byte</span>[] data1 = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</div><div class="line">            in.read(data1);</div><div class="line">            System.out.println(<span class="keyword">new</span> String(data1));</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="消息类"><a href="#消息类" class="headerlink" title="消息类"></a>消息类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String msgtype;</div><div class="line">    <span class="keyword">private</span> MessageInfo text;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsgtype</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> msgtype;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsgtype</span><span class="params">(String msgtype)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.msgtype = msgtype;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> MessageInfo <span class="title">getText</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> text;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(MessageInfo text)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.text = text;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageInfo</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String content;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageInfo</span><span class="params">(String content)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.content = content;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> content;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.content = content;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="微信通知"><a href="#微信通知" class="headerlink" title="微信通知"></a>微信通知</h3><p>服务号 模板消息</p>
</div><div class="tags"><a href="/tags/SpringCloud/">SpringCloud</a></div><div class="post-nav"><a class="pre" href="/2020-10-04-Spring Cloud/分布式会话管理(1).html">分布式会话管理(一)</a><a class="next" href="/2020-10-03-Spring Cloud/SpringCloud(4)-Hystrix.html">SpringCloud学习(六)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/加解密技术/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/吉他/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心情/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/无关技术/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息队列/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/疯狂-Java-讲义/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计划/">计划</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/计划/" style="font-size: 15px;">计划</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/吉他/" style="font-size: 15px;">吉他</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a> <a href="/tags/无关技术/" style="font-size: 15px;">无关技术</a> <a href="/tags/疯狂-Java-讲义/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>