<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title> | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">悟空</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta">Oct 5, 2020</div><div class="post-content"><h2 id="1、密码存储"><a href="#1、密码存储" class="headerlink" title="1、密码存储"></a>1、密码存储</h2><h3 id="1-1-常见密文存储的几种方式："><a href="#1-1-常见密文存储的几种方式：" class="headerlink" title="1.1 常见密文存储的几种方式："></a>1.1 常见密文存储的几种方式：</h3><p>摘要算法特点：快、不可逆、相同的源加密结果一样</p>
<ul>
<li>明文</li>
<li>hash(明文)</li>
<li>hash(明文 + 盐)</li>
</ul>
<p>盐的几种实现：</p>
<ul>
<li><p>统一的盐。密码丢失后，很可能猜到盐是啥。</p>
</li>
<li><p>用户名 手机号等 每个账户不一样。还是有一定规律，并且这些加盐的字段不能变。</p>
</li>
<li>随机盐（保存数据库）</li>
<li>随机盐（从密码取），把随机数直接放进 hash 值中</li>
</ul>
<h3 id="1-2-常见批结方式"><a href="#1-2-常见批结方式" class="headerlink" title="1.2 常见批结方式"></a>1.2 常见批结方式</h3><p><strong>暴力破解/字典/彩虹表</strong></p>
<h3 id="1-3-防止破解"><a href="#1-3-防止破解" class="headerlink" title="1.3 防止破解"></a>1.3 防止破解</h3><p>没有绝对安全的网络，即使拿不到密码 也可以发送重放攻击</p>
<ul>
<li>多次加盐取 hash</li>
<li>使用更复杂的单向加密算法比如 Bcrypt</li>
<li>使用 https</li>
<li>风控系统<ul>
<li>人机交互，二次安全校验</li>
<li>接口调用安全校验</li>
<li>异地登录等</li>
<li>大额转账</li>
</ul>
</li>
</ul>
<h3 id="Bcrypt结构"><a href="#Bcrypt结构" class="headerlink" title="Bcrypt结构"></a>Bcrypt结构</h3><p><img src="D:/01_code/05_mashibing/InternetArchitect/20 架构师三期 SpringCloud微服务架构/images/webp" alt="img"></p>
<h2 id="2、JDBC-用户存储"><a href="#2、JDBC-用户存储" class="headerlink" title="2、JDBC 用户存储"></a>2、JDBC 用户存储</h2><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spring.datasource.username=root</div><div class="line">spring.datasource.password=pass9876</div><div class="line">spring.datasource.url=jdbc:mysql://node02:3306:mq?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</div></pre></td></tr></table></figure>
<p>建表</p>
<p>Spring Security 默认情况下需要两张表，用户表和权限表，可以参考</p>
<p>org.springframework.security.core.userdetails.jdbc.users.ddl</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span>;</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`authorities`</span>;</div></pre></td></tr></table></figure>
<p>配置JDBCManager用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 基于内存存储用户</span></div><div class="line">    <span class="comment">//        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span></div><div class="line">    <span class="comment">// 基于 JDBC 村粗用户</span></div><div class="line">    JdbcUserDetailsManager manager = <span class="keyword">new</span> JdbcUserDetailsManager(dataSource);</div><div class="line">    User user = <span class="keyword">new</span> User(<span class="string">"4"</span>, <span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"4"</span>), <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, Collections.singletonList(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"4"</span>)));</div><div class="line">    manager.createUser(user);</div><div class="line">    manager.createUser(User.withUsername(<span class="string">"5"</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"5"</span>)).roles(<span class="string">"5"</span>).build());</div><div class="line">    <span class="keyword">return</span> manager;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 或者</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// 注释掉后，所有默认配置失效。配置文件中的用户名和密码不生效了</span></div><div class="line">    <span class="comment">// super.configure(auth);</span></div><div class="line">    <span class="comment">// 基于内存</span></div><div class="line">    <span class="comment">//        auth.inMemoryAuthentication()</span></div><div class="line">    <span class="comment">//            .withUser("123").password(new BCryptPasswordEncoder().encode("123")).roles("admin")</span></div><div class="line">    <span class="comment">//            .and()</span></div><div class="line">    <span class="comment">//            .withUser("321").password(new BCryptPasswordEncoder().encode("321")).roles("user")</span></div><div class="line">    <span class="comment">//        ;</span></div><div class="line">    <span class="comment">// 基于 JDBC</span></div><div class="line">    JdbcUserDetailsManager manager = auth.jdbcAuthentication().dataSource(dataSource).getUserDetailsService();</div><div class="line">    <span class="keyword">if</span> (manager.userExists(<span class="string">"alvin"</span>)) &#123;</div><div class="line">        System.out.println(<span class="string">"用户已经注册"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        manager.createUser(User.withUsername(<span class="string">"alvin"</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"pass9876"</span>)).roles(<span class="string">"admin"</span>,<span class="string">"sci"</span>).build());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-1-自定义用户登录查询"><a href="#2-1-自定义用户登录查询" class="headerlink" title="2.1 自定义用户登录查询"></a>2.1 自定义用户登录查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// 自定义 UserDetailsService 逻辑</span></div><div class="line">    auth.userDetailsService(<span class="keyword">new</span> MyUserDetailsService());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</div><div class="line">        <span class="comment">// 在这里执行查询</span></div><div class="line">        System.out.println(<span class="string">"=====&gt;开始查询数据源。。。"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> Random().nextBoolean()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(<span class="string">"用户已锁定"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"用户名或密码错误，请重试"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-自定义用户权限校验"><a href="#2-2-自定义用户权限校验" class="headerlink" title="2.2 自定义用户权限校验"></a>2.2 自定义用户权限校验</h3><p><strong>校验器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    MyUserDetailsService userDetailsService;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"====&gt;开始自定义验证。。。"</span>);</div><div class="line">        System.out.println(authentication);</div><div class="line"></div><div class="line">        <span class="comment">// 穷举密码，可以在这里做重试限制</span></div><div class="line"></div><div class="line">        String username = authentication.getPrincipal().toString();</div><div class="line">        String rawPassword = authentication.getCredentials().toString();</div><div class="line"></div><div class="line">        <span class="comment">// 查询用户信息</span></div><div class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername(username);</div><div class="line"></div><div class="line">        <span class="comment">// 密码校验</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> BCryptPasswordEncoder().matches(rawPassword, userDetails.getPassword())) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username,userDetails.getPassword(),userDetails.getAuthorities());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"用户名或密码错误。"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>配置校验器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// 自定义 UserDetailsService 逻辑</span></div><div class="line">    auth.userDetailsService(userDetailsService)</div><div class="line">        .and()</div><div class="line">        .authenticationProvider(authProvider);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3、Remember-Me"><a href="#3、Remember-Me" class="headerlink" title="3、Remember Me"></a>3、Remember Me</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http.</div><div class="line">    <span class="comment">// 哪些 地址需要登录</span></div><div class="line">    authorizeRequests()</div><div class="line">    <span class="comment">//所有请求都需要验证</span></div><div class="line">    .anyRequest().authenticated()</div><div class="line">    .and()</div><div class="line">    .formLogin()</div><div class="line">    .and()</div><div class="line">    .rememberMe()</div><div class="line">    .and()</div><div class="line">    .csrf().disable()</div></pre></td></tr></table></figure>
<p>其实是往 cookies 中添加了  remember-me ，有一个过期时间。</p>
<p>为什么不直接延长 JSESSIONID 的过期时间？</p>
<p>以为请求不一定是浏览器发起的，不一定有 session，remember-me 是基于 token 的。如果是集群，不会用 session，否则服务器压力太大。token 机制是无会话，只在首次登录</p>
<p>不管是服务器保存 session 还是 第三方保存 session 比如 redis，都是基于会话的，都是有状态的。</p>
<p>基于 token：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function">MTIzOjE2MDMwNzgyMDY2MzU6NTlhZjZjMzJmMWYyYzkwZjVlMDYwZGRjZmJhZDE5YmY    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        String rememberMe = <span class="string">"MTIzOjE2MDMwNzgyMDY2MzU6NTlhZjZjMzJmMWYyYzkwZjVlMDYwZGRjZmJhZDE5YmY"</span>;</div><div class="line">        <span class="keyword">byte</span>[] b = Base64.getDecoder().decode(rememberMe);</div><div class="line">        <span class="comment">// 用户名:过期时间:sign(用于校验签名两个值对不对)</span></div><div class="line">        <span class="comment">// 用户名+过期时间+secret=&gt;sign(secret 服务器端有，客户端没有)</span></div><div class="line">        <span class="comment">// 123:1603078206635:59af6c32f1f2c90f5e060ddcfbad19bf</span></div><div class="line">        <span class="comment">// 好处是不需要任何和数据源的校验</span></div><div class="line">        System.out.println(<span class="keyword">new</span> String(b));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="4、同一用户多地点登录"><a href="#4、同一用户多地点登录" class="headerlink" title="4、同一用户多地点登录"></a>4、同一用户多地点登录</h2><p>禁止其他终端登录。此配置和记住我有冲突。</p>
<h3 id="踢掉其他已登录的用户"><a href="#踢掉其他已登录的用户" class="headerlink" title="踢掉其他已登录的用户"></a>踢掉其他已登录的用户</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    http.authorizeRequests().anyRequest().authenticated()</div><div class="line">        .and()</div><div class="line">        .formLogin()</div><div class="line">        .and()</div><div class="line">        <span class="comment">// 测试 remember me</span></div><div class="line">        <span class="comment">//.rememberMe()</span></div><div class="line">        <span class="comment">//.and()</span></div><div class="line">        <span class="comment">// 测试多地点登录限制</span></div><div class="line">        .sessionManagement()</div><div class="line">        .maximumSessions(<span class="number">1</span>)<span class="comment">// 地点个数</span></div><div class="line">        .maxSessionsPreventsLogin(<span class="keyword">true</span>)<span class="comment">// 保护登录，即不允许被挤下去</span></div><div class="line">        .and()</div><div class="line">        .and()</div><div class="line">        .csrf()</div><div class="line">        .disable()</div><div class="line">        ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>及时清理过期session</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function">HttpSessionEventPublisher <span class="title">httpSessionEventPublisher</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionEventPublisher();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5、Spring-Security-防火前与-Sql-注入"><a href="#5、Spring-Security-防火前与-Sql-注入" class="headerlink" title="5、Spring Security 防火前与 Sql 注入"></a>5、Spring Security 防火前与 Sql 注入</h2><p>SpringSecurity 本身不支持 ip 地址黑白名单。可以使用 SpringBoot filter 拦截。但是一般应该把拦截前置，可直接在 Linux 配置防火墙或者在 Nginx 拦截。</p>
<p>SQL 注入解决：perparestatement，预编译。</p>
<p>DDOS：拒绝服务攻击。三次握手完，不发包；三次握手最后一个包不回。</p>
<h3 id="5-1-指定-ip-可以不登录"><a href="#5-1-指定-ip-可以不登录" class="headerlink" title="5.1 指定 ip 可以不登录"></a>5.1 指定 ip 可以不登录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.antMatchers(<span class="string">"/ip1"</span>).hasIpAddress(<span class="string">"127.0.0.1"</span>)</div></pre></td></tr></table></figure>
<h3 id="5-2-禁止ip访问"><a href="#5-2-禁止ip访问" class="headerlink" title="5.2 禁止ip访问"></a>5.2 禁止ip访问</h3><p>用Filter 实现、或者用HandlerInterceptor 实现</p>
<h3 id="5-3-StrictHttpFirewall"><a href="#5-3-StrictHttpFirewall" class="headerlink" title="5.3 StrictHttpFirewall"></a>5.3 StrictHttpFirewall</h3><p>spring security 默认使用StrictHttpFirewall限制用户请求</p>
<h4 id="method"><a href="#method" class="headerlink" title="method"></a>method</h4><p>缺省被允许的<code>HTTP method</code>有 [<code>DELETE</code>, <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>, <code>PATCH</code>, <code>POST</code>, <code>PUT</code>]</p>
<h4 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h4><p><strong>在其<code>requestURI</code>/<code>contextPath</code>/<code>servletPath</code>/<code>pathInfo</code>中，必须不能包含以下字符串序列之一 :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&quot;//&quot;,&quot;./&quot;,&quot;/…/&quot;,&quot;/.&quot;]</div></pre></td></tr></table></figure>
<h4 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">;或者%3b或者%3B</div><div class="line">// 禁用规则</div><div class="line">setAllowSemicolon(boolean)</div></pre></td></tr></table></figure>
<h4 id="斜杠"><a href="#斜杠" class="headerlink" title="斜杠"></a>斜杠</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">%2f`或者`%2F</div><div class="line">// 禁用规则</div><div class="line">setAllowUrlEncodedSlash(boolean)</div></pre></td></tr></table></figure>
<h4 id="反斜杠"><a href="#反斜杠" class="headerlink" title="反斜杠"></a>反斜杠</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">\或者%5c或者%5B</div><div class="line">// 禁用规则</div><div class="line">setAllowBackSlash(boolean)</div></pre></td></tr></table></figure>
<h4 id="英文句号"><a href="#英文句号" class="headerlink" title="英文句号"></a>英文句号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">%2e或者%2E</div><div class="line">// 禁用规则</div><div class="line">setAllowUrlEncodedPeriod(boolean)</div></pre></td></tr></table></figure>
<h4 id="百分号"><a href="#百分号" class="headerlink" title="百分号"></a>百分号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">%25</div><div class="line">// 禁用规则</div><div class="line">setAllowUrlEncodedPercent(boolean)</div></pre></td></tr></table></figure>
<h4 id="防火墙与sql注入"><a href="#防火墙与sql注入" class="headerlink" title="防火墙与sql注入"></a>防火墙与sql注入</h4><p>‘ ; – % 多数非法字符已经在请求的参数上被禁用</p>
<p>为啥用户名不能有特殊字符</p>
<p>preparestatement </p>
<p>awf前端拦截</p>
<h2 id="6、注销登录"><a href="#6、注销登录" class="headerlink" title="6、注销登录"></a>6、注销登录</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.and()</div><div class="line">    .logout()</div><div class="line">    .logoutUrl(<span class="string">"/out"</span>)</div></pre></td></tr></table></figure>
<h2 id="7、退出登录、登录成功-失败控制器"><a href="#7、退出登录、登录成功-失败控制器" class="headerlink" title="7、退出登录、登录成功/失败控制器"></a>7、退出登录、登录成功/失败控制器</h2><h3 id="增加退出处理器"><a href="#增加退出处理器" class="headerlink" title="增加退出处理器"></a>增加退出处理器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">.addLogoutHandler(new LogoutHandler() &#123;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line">		System.out.println(&quot;退出1&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"></div><div class="line">.addLogoutHandler(new LogoutHandler() &#123;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line">		System.out.println(&quot;退出2&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="登录成功处理器"><a href="#登录成功处理器" class="headerlink" title="登录成功处理器"></a>登录成功处理器</h3><p>不同角色 跳转到不同页面</p>
<pre><code>.successHandler(new AuthenticationSuccessHandler() {

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
            Authentication authentication) throws IOException, ServletException {
        // TODO Auto-generated method stub

        System.out.println(&quot;登录成功1&quot;);
        // 根据权限不同，跳转到不同页面
        request.getSession().getAttribute(name)
        request.getRequestDispatcher(&quot;&quot;).forward(request, response);
    }
})
</code></pre><p>其中 Authentication 参数包含了 用户权限信息</p>
<h3 id="登录失败处理器"><a href="#登录失败处理器" class="headerlink" title="登录失败处理器"></a>登录失败处理器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">.failureHandler(new AuthenticationFailureHandler() &#123;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			AuthenticationException exception) throws IOException, ServletException &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line">		exception.printStackTrace();</div><div class="line">		request.getRequestDispatcher(request.getRequestURL().toString()).forward(request, response);</div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>可以限制登录错误次数</p>
<h4 id="常见登录异常"><a href="#常见登录异常" class="headerlink" title="常见登录异常"></a>常见登录异常</h4><p><strong>LockedException</strong> 账户被锁定</p>
<p><strong>CredentialsExpiredException</strong> 密码过期</p>
<p><strong>AccountExpiredException</strong> 账户过期</p>
<p><strong>DisabledException</strong> 账户被禁用</p>
<p><strong>BadCredentialsException</strong> 密码错误</p>
<p><strong>UsernameNotFoundException</strong> 用户名错误</p>
<h2 id="8、Ant-风格路径表达式"><a href="#8、Ant-风格路径表达式" class="headerlink" title="8、Ant 风格路径表达式"></a>8、Ant 风格路径表达式</h2><table>
<thead>
<tr>
<th>通配符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>?</td>
<td>匹配任何单字符</td>
</tr>
<tr>
<td>*</td>
<td>匹配0或者任意数量的字符</td>
</tr>
<tr>
<td>**</td>
<td>匹配0或者更多的目录</td>
</tr>
</tbody>
</table>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><table>
<thead>
<tr>
<th>URL路径</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>/app/*.x</td>
<td>匹配(Matches)所有在app路径下的.x文件</td>
</tr>
<tr>
<td>/app/p?ttern</td>
<td>匹配(Matches) /app/pattern 和 /app/pXttern,但是不包括/app/pttern</td>
</tr>
<tr>
<td>/**/example</td>
<td>匹配(Matches) /app/example, /app/foo/example, 和 /example</td>
</tr>
<tr>
<td>/app/<em>*/dir/file.</em></td>
<td>匹配(Matches) /app/dir/file.jsp, /app/foo/dir/file.html,/app/foo/bar/dir/file.pdf, 和 /app/dir/file.java</td>
</tr>
<tr>
<td>/<em>*/</em>.jsp</td>
<td>匹配(Matches)任何的.jsp 文件</td>
</tr>
</tbody>
</table>
<h4 id="最长匹配原则"><a href="#最长匹配原则" class="headerlink" title="最长匹配原则"></a>最长匹配原则</h4><p>最长匹配原则(has more characters)<br>说明，URL请求 /app/dir/file.jsp，现在存在两个路径匹配模式/<em>*/</em>.jsp和/app/dir/<em>.jsp，那么会根据模式/app/dir/</em>.jsp来匹配</p>
<h4 id="匹配顺序"><a href="#匹配顺序" class="headerlink" title="匹配顺序"></a>匹配顺序</h4><p>security 像 shiro 一样，权限匹配有顺序，比如不能把 .anyRequest().authenticated() 写在其他规则前面</p>
<h2 id="9、基于角色的权限控制与继承"><a href="#9、基于角色的权限控制与继承" class="headerlink" title="9、基于角色的权限控制与继承"></a>9、基于角色的权限控制与继承</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">	http.authorizeRequests()</div><div class="line">	.antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"admin"</span>)</div><div class="line">	.antMatchers(<span class="string">"/user/**"</span>).hasRole(<span class="string">"user"</span>)</div><div class="line">  </div><div class="line"><span class="meta">@Bean</span>        </div><div class="line"><span class="function">RoleHierarchy <span class="title">roleHierarchy</span><span class="params">()</span> </span>&#123;</div><div class="line">	RoleHierarchyImpl impl = <span class="keyword">new</span> RoleHierarchyImpl();</div><div class="line">	impl.setHierarchy(<span class="string">"ROLE_admin &gt; ROLE_user"</span>);</div><div class="line">	<span class="keyword">return</span> impl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="10、细粒度方法级权限控制"><a href="#10、细粒度方法级权限控制" class="headerlink" title="10、细粒度方法级权限控制"></a>10、细粒度方法级权限控制</h2><p><strong>配置开启</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebSecurity</span></div><div class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>,securedEnabled = <span class="keyword">true</span>)</div></pre></td></tr></table></figure>
<p><strong>使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/admin/hi"</span>)</div><div class="line">    <span class="meta">@Secured</span>(<span class="string">"ROLE_admin"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hi1</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"=====&gt;来啦,老弟..."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"hi admin..."</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/hi"</span>)</div><div class="line">    <span class="comment">// 或者关系，@Secured 没法实现并且关系</span></div><div class="line">    <span class="meta">@Secured</span>(&#123;<span class="string">"ROLE_admin"</span>,<span class="string">"ROLE_user"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hi2</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"=====&gt;来啦,老弟..."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"hi user..."</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/admin/hi3"</span>)</div><div class="line">    <span class="comment">// 并且关系</span></div><div class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_admin') AND hasRole('ROLE_user')"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hi3</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"=====&gt;来啦,老弟..."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"hi admin 3..."</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/admin/hi4"</span>)</div><div class="line">    <span class="comment">// 可以写 spel 表达式，根据返回值判断是否有权限。</span></div><div class="line">    <span class="meta">@PostAuthorize</span>(<span class="string">"returnObject==1"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">hi4</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"=====&gt;来啦,老弟..."</span>);</div><div class="line">        <span class="comment">// 访问子系统，把当前用户角色带过去，让子系统校验是否有权限</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Random().nextInt(<span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>获取当前用户权限信息和 UserDetails</strong></p>
<p>自己写权限校验时可能会用到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line">	</div><div class="line">authentication.getPrincipal()</div></pre></td></tr></table></figure>
<h2 id="11、自定义前置-Filter-及图形验证码"><a href="#11、自定义前置-Filter-及图形验证码" class="headerlink" title="11、自定义前置 Filter 及图形验证码"></a>11、自定义前置 Filter 及图形验证码</h2><p>目的：防机器暴力登陆</p>
<p>人机交互/手机验证码：机器基本没法破解</p>
<p>数字图形机器识别简单一点，图片机器识别稍微麻烦一点，但是图形验证码现在基本上是不安全的了，因为机器学习算法给它点时间就能破解。</p>
<h3 id="Kaptcha"><a href="#Kaptcha" class="headerlink" title="Kaptcha"></a>Kaptcha</h3><table>
<thead>
<tr>
<th>Constant</th>
<th>描述</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>kaptcha.border</td>
<td>图片边框，合法值：yes , no</td>
<td>yes</td>
</tr>
<tr>
<td>kaptcha.border.color</td>
<td>边框颜色，合法值： r,g,b (and optional alpha) 或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.image.width</td>
<td>图片宽</td>
<td>200</td>
</tr>
<tr>
<td>kaptcha.image.height</td>
<td>图片高</td>
<td>50</td>
</tr>
<tr>
<td>kaptcha.producer.impl</td>
<td>图片实现类</td>
<td>com.google.code.kaptcha.impl.DefaultKaptcha</td>
</tr>
<tr>
<td>kaptcha.textproducer.impl</td>
<td>文本实现类</td>
<td>com.google.code.kaptcha.text.impl.DefaultTextCreator</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.string</td>
<td>文本集合，验证码值从此集合中获取</td>
<td>abcde2345678gfynmnpwx</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.length</td>
<td>验证码长度</td>
<td>5</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.names</td>
<td>字体</td>
<td>Arial, Courier</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.size</td>
<td>字体大小</td>
<td>40px.</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.color</td>
<td>字体颜色，合法值： r,g,b  或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.space</td>
<td>文字间隔</td>
<td>2</td>
</tr>
<tr>
<td>kaptcha.noise.impl</td>
<td>干扰实现类</td>
<td>com.google.code.kaptcha.impl.DefaultNoise</td>
</tr>
<tr>
<td>kaptcha.noise.color</td>
<td>干扰 颜色，合法值： r,g,b 或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.obscurificator.impl</td>
<td>图片样式：<br>水纹 com.google.code.kaptcha.impl.WaterRipple <br> 鱼眼 com.google.code.kaptcha.impl.FishEyeGimpy <br> 阴影 com.google.code.kaptcha.impl.ShadowGimpy</td>
<td>com.google.code.kaptcha.impl.WaterRipple</td>
</tr>
<tr>
<td>kaptcha.background.impl</td>
<td>背景实现类</td>
<td>com.google.code.kaptcha.impl.DefaultBackground</td>
</tr>
<tr>
<td>kaptcha.background.clear.from</td>
<td>背景颜色渐变，开始颜色</td>
<td>light grey</td>
</tr>
<tr>
<td>kaptcha.background.clear.to</td>
<td>背景颜色渐变， 结束颜色</td>
<td>white</td>
</tr>
<tr>
<td>kaptcha.word.impl</td>
<td>文字渲染器</td>
<td>com.google.code.kaptcha.text.impl.DefaultWordRenderer</td>
</tr>
<tr>
<td>kaptcha.session.key</td>
<td>session key</td>
<td>KAPTCHA_SESSION_KEY</td>
</tr>
<tr>
<td>kaptcha.session.date</td>
<td>session date</td>
<td>KAPTCHA_SESSION_DATE</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="添加一个前置Filter"><a href="#添加一个前置Filter" class="headerlink" title="添加一个前置Filter"></a>添加一个前置Filter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http.addFilterBefore(<span class="keyword">new</span> CodeFilter(), UsernamePasswordAuthenticationFilter.class);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></div><div class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"></div><div class="line">		HttpServletRequest req = (HttpServletRequest)request;</div><div class="line">		HttpServletResponse resp = (HttpServletResponse)response;</div><div class="line">		</div><div class="line">		String uri = req.getServletPath();</div><div class="line"></div><div class="line"></div><div class="line">		<span class="keyword">if</span>(uri.equals(<span class="string">"/login"</span>) &amp;&amp; req.getMethod().equalsIgnoreCase(<span class="string">"post"</span>)) &#123;</div><div class="line"></div><div class="line">		</div><div class="line">			String sessionCode = req.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY).toString();</div><div class="line">			String formCode = req.getParameter(<span class="string">"code"</span>).trim();</div><div class="line">				</div><div class="line">			<span class="keyword">if</span>(StringUtils.isEmpty(formCode)) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"验证码不能为空"</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span>(sessionCode.equalsIgnoreCase(formCode)) &#123;</div><div class="line">				</div><div class="line">				System.out.println(<span class="string">"验证通过"</span>);</div><div class="line">				</div><div class="line">			&#125;		</div><div class="line">					System.out.println(req.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY));</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"xx"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		chain.doFilter(request, response);</div><div class="line">		</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>显示验证码的Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/kaptcha"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getKaptchaImage</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       HttpSession session = request.getSession();</div><div class="line">       response.setDateHeader(<span class="string">"Expires"</span>, <span class="number">0</span>);</div><div class="line">       response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-store, no-cache, must-revalidate"</span>);</div><div class="line">       response.addHeader(<span class="string">"Cache-Control"</span>, <span class="string">"post-check=0, pre-check=0"</span>);</div><div class="line">       response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"no-cache"</span>);</div><div class="line">       response.setContentType(<span class="string">"image/jpeg"</span>);</div><div class="line">       String capText = captchaProducer.createText();</div><div class="line">       </div><div class="line">       session.setAttribute(Constants.KAPTCHA_SESSION_KEY, capText);</div><div class="line">       BufferedImage bi = captchaProducer.createImage(capText);</div><div class="line">       ServletOutputStream out = response.getOutputStream();</div><div class="line">       ImageIO.write(bi, <span class="string">"jpg"</span>, out);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           out.flush();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           out.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><strong>配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.mashibing.admin;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</div><div class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</div><div class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</div><div class="line"></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Kaconfig</span> </span>&#123;</div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> DefaultKaptcha <span class="title">getDefaultKaptcha</span><span class="params">()</span></span>&#123;</div><div class="line">        DefaultKaptcha captchaProducer = <span class="keyword">new</span> DefaultKaptcha();</div><div class="line">        Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.border"</span>, <span class="string">"yes"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.border.color"</span>, <span class="string">"105,179,90"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.font.color"</span>, <span class="string">"blue"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.image.width"</span>, <span class="string">"310"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.image.height"</span>, <span class="string">"240"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.font.size"</span>, <span class="string">"30"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.session.key"</span>, <span class="string">"code"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.char.length"</span>, <span class="string">"4"</span>);</div><div class="line">    <span class="comment">//    properties.setProperty("kaptcha.textproducer.char.string", "678");</span></div><div class="line">        properties.setProperty(<span class="string">"kaptcha.obscurificator.impl"</span>, <span class="string">"com.google.code.kaptcha.impl.ShadowGimpy"</span>);</div><div class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.font.names"</span>, <span class="string">"宋体,楷体,微软雅黑"</span>);</div><div class="line">        Config config = <span class="keyword">new</span> Config(properties);</div><div class="line">        captchaProducer.setConfig(config);</div><div class="line">        <span class="keyword">return</span> captchaProducer;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12、集群化服务之-Session-共享-SpringSession-Redis"><a href="#12、集群化服务之-Session-共享-SpringSession-Redis" class="headerlink" title="12、集群化服务之 Session 共享 SpringSession + Redis"></a>12、集群化服务之 Session 共享 SpringSession + Redis</h2></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2020-10-05-Spring Cloud/分布式会话管理(3).html"></a><a class="next" href="/2020-10-04-Spring Cloud/SpringCloud(6)-config.html">SpringCloud学习(八)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/加解密技术/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/吉他/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/心情/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/无关技术/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息队列/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/疯狂-Java-讲义/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计划/">计划</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/计划/" style="font-size: 15px;">计划</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/吉他/" style="font-size: 15px;">吉他</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a> <a href="/tags/无关技术/" style="font-size: 15px;">无关技术</a> <a href="/tags/疯狂-Java-讲义/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>