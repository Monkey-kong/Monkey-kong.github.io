<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title> | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">悟空</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta">2020-10-05</div><div class="post-content"><h2 id="1、密码存储"><a href="#1、密码存储" class="headerlink" title="1、密码存储"></a>1、密码存储</h2><h3 id="1-1-常见密文存储的几种方式："><a href="#1-1-常见密文存储的几种方式：" class="headerlink" title="1.1 常见密文存储的几种方式："></a>1.1 常见密文存储的几种方式：</h3><p>摘要算法特点：快、不可逆、相同的源加密结果一样</p>
<ul>
<li>明文</li>
<li>hash(明文)</li>
<li>hash(明文 + 盐)</li>
</ul>
<p>盐的几种实现：</p>
<ul>
<li><p>统一的盐。密码丢失后，很可能猜到盐是啥。</p>
</li>
<li><p>用户名 手机号等 每个账户不一样。还是有一定规律，并且这些加盐的字段不能变。</p>
</li>
<li><p>随机盐（保存数据库）</p>
</li>
<li><p>随机盐（从密码取），把随机数直接放进 hash 值中</p>
</li>
</ul>
<h3 id="1-2-常见批结方式"><a href="#1-2-常见批结方式" class="headerlink" title="1.2 常见批结方式"></a>1.2 常见批结方式</h3><p><strong>暴力破解/字典/彩虹表</strong></p>
<h3 id="1-3-防止破解"><a href="#1-3-防止破解" class="headerlink" title="1.3 防止破解"></a>1.3 防止破解</h3><p>没有绝对安全的网络，即使拿不到密码 也可以发送重放攻击</p>
<ul>
<li>多次加盐取 hash</li>
<li>使用更复杂的单向加密算法比如 Bcrypt</li>
<li>使用 https</li>
<li>风控系统<ul>
<li>人机交互，二次安全校验</li>
<li>接口调用安全校验</li>
<li>异地登录等</li>
<li>大额转账</li>
</ul>
</li>
</ul>
<h3 id="Bcrypt结构"><a href="#Bcrypt结构" class="headerlink" title="Bcrypt结构"></a>Bcrypt结构</h3><p>![img](D:/01_code/05_mashibing/InternetArchitect/20 架构师三期 SpringCloud微服务架构/images/webp)</p>
<h2 id="2、JDBC-用户存储"><a href="#2、JDBC-用户存储" class="headerlink" title="2、JDBC 用户存储"></a>2、JDBC 用户存储</h2><p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">pass9876</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://node02:3306:mq?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span></span><br></pre></td></tr></table></figure>

<p>建表</p>
<p>Spring Security 默认情况下需要两张表，用户表和权限表，可以参考</p>
<p>org.springframework.security.core.userdetails.jdbc.users.ddl</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`authorities`</span>;</span><br></pre></td></tr></table></figure>

<p>配置JDBCManager用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 基于内存存储用户</span></span><br><span class="line">    <span class="comment">//        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span></span><br><span class="line">    <span class="comment">// 基于 JDBC 村粗用户</span></span><br><span class="line">    JdbcUserDetailsManager manager = <span class="keyword">new</span> JdbcUserDetailsManager(dataSource);</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="string">&quot;4&quot;</span>, <span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;4&quot;</span>), <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, Collections.singletonList(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;4&quot;</span>)));</span><br><span class="line">    manager.createUser(user);</span><br><span class="line">    manager.createUser(User.withUsername(<span class="string">&quot;5&quot;</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;5&quot;</span>)).roles(<span class="string">&quot;5&quot;</span>).build());</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 注释掉后，所有默认配置失效。配置文件中的用户名和密码不生效了</span></span><br><span class="line">    <span class="comment">// super.configure(auth);</span></span><br><span class="line">    <span class="comment">// 基于内存</span></span><br><span class="line">    <span class="comment">//        auth.inMemoryAuthentication()</span></span><br><span class="line">    <span class="comment">//            .withUser(&quot;123&quot;).password(new BCryptPasswordEncoder().encode(&quot;123&quot;)).roles(&quot;admin&quot;)</span></span><br><span class="line">    <span class="comment">//            .and()</span></span><br><span class="line">    <span class="comment">//            .withUser(&quot;321&quot;).password(new BCryptPasswordEncoder().encode(&quot;321&quot;)).roles(&quot;user&quot;)</span></span><br><span class="line">    <span class="comment">//        ;</span></span><br><span class="line">    <span class="comment">// 基于 JDBC</span></span><br><span class="line">    JdbcUserDetailsManager manager = auth.jdbcAuthentication().dataSource(dataSource).getUserDetailsService();</span><br><span class="line">    <span class="keyword">if</span> (manager.userExists(<span class="string">&quot;alvin&quot;</span>)) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;用户已经注册&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">&quot;alvin&quot;</span>).password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;pass9876&quot;</span>)).roles(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;sci&quot;</span>).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-自定义用户登录查询"><a href="#2-1-自定义用户登录查询" class="headerlink" title="2.1 自定义用户登录查询"></a>2.1 自定义用户登录查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 自定义 UserDetailsService 逻辑</span></span><br><span class="line">    auth.userDetailsService(<span class="keyword">new</span> MyUserDetailsService());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 在这里执行查询</span></span><br><span class="line">        System.out.println(<span class="string">&quot;=====&gt;开始查询数据源。。。&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> Random().nextBoolean()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(<span class="string">&quot;用户已锁定&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">&quot;用户名或密码错误，请重试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-自定义用户权限校验"><a href="#2-2-自定义用户权限校验" class="headerlink" title="2.2 自定义用户权限校验"></a>2.2 自定义用户权限校验</h3><p><strong>校验器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyUserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;====&gt;开始自定义验证。。。&quot;</span>);</span><br><span class="line">        System.out.println(authentication);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 穷举密码，可以在这里做重试限制</span></span><br><span class="line"></span><br><span class="line">        String username = authentication.getPrincipal().toString();</span><br><span class="line">        String rawPassword = authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询用户信息</span></span><br><span class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 密码校验</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> BCryptPasswordEncoder().matches(rawPassword, userDetails.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username,userDetails.getPassword(),userDetails.getAuthorities());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">&quot;用户名或密码错误。&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置校验器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 自定义 UserDetailsService 逻辑</span></span><br><span class="line">    auth.userDetailsService(userDetailsService)</span><br><span class="line">        .and()</span><br><span class="line">        .authenticationProvider(authProvider);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、Remember-Me"><a href="#3、Remember-Me" class="headerlink" title="3、Remember Me"></a>3、Remember Me</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http.</span><br><span class="line">    <span class="comment">// 哪些 地址需要登录</span></span><br><span class="line">    authorizeRequests()</span><br><span class="line">    <span class="comment">//所有请求都需要验证</span></span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .and()</span><br><span class="line">    .formLogin()</span><br><span class="line">    .and()</span><br><span class="line">    .rememberMe()</span><br><span class="line">    .and()</span><br><span class="line">    .csrf().disable()</span><br></pre></td></tr></table></figure>

<p>其实是往 cookies 中添加了  remember-me ，有一个过期时间。</p>
<p>为什么不直接延长 JSESSIONID 的过期时间？</p>
<p>以为请求不一定是浏览器发起的，不一定有 session，remember-me 是基于 token 的。如果是集群，不会用 session，否则服务器压力太大。token 机制是无会话，只在首次登录</p>
<p>不管是服务器保存 session 还是 第三方保存 session 比如 redis，都是基于会话的，都是有状态的。</p>
<p>基于 token：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MTIzOjE2MDMwNzgyMDY2MzU6NTlhZjZjMzJmMWYyYzkwZjVlMDYwZGRjZmJhZDE5YmY    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String rememberMe = <span class="string">&quot;MTIzOjE2MDMwNzgyMDY2MzU6NTlhZjZjMzJmMWYyYzkwZjVlMDYwZGRjZmJhZDE5YmY&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] b = Base64.getDecoder().decode(rememberMe);</span><br><span class="line">        <span class="comment">// 用户名:过期时间:sign(用于校验签名两个值对不对)</span></span><br><span class="line">        <span class="comment">// 用户名+过期时间+secret=&gt;sign(secret 服务器端有，客户端没有)</span></span><br><span class="line">        <span class="comment">// 123:1603078206635:59af6c32f1f2c90f5e060ddcfbad19bf</span></span><br><span class="line">        <span class="comment">// 好处是不需要任何和数据源的校验</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(b));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、同一用户多地点登录"><a href="#4、同一用户多地点登录" class="headerlink" title="4、同一用户多地点登录"></a>4、同一用户多地点登录</h2><p>禁止其他终端登录。此配置和记住我有冲突。</p>
<h3 id="踢掉其他已登录的用户"><a href="#踢掉其他已登录的用户" class="headerlink" title="踢掉其他已登录的用户"></a>踢掉其他已登录的用户</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.authorizeRequests().anyRequest().authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// 测试 remember me</span></span><br><span class="line">        <span class="comment">//.rememberMe()</span></span><br><span class="line">        <span class="comment">//.and()</span></span><br><span class="line">        <span class="comment">// 测试多地点登录限制</span></span><br><span class="line">        .sessionManagement()</span><br><span class="line">        .maximumSessions(<span class="number">1</span>)<span class="comment">// 地点个数</span></span><br><span class="line">        .maxSessionsPreventsLogin(<span class="keyword">true</span>)<span class="comment">// 保护登录，即不允许被挤下去</span></span><br><span class="line">        .and()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf()</span><br><span class="line">        .disable()</span><br><span class="line">        ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>及时清理过期session</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">HttpSessionEventPublisher <span class="title">httpSessionEventPublisher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionEventPublisher();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5、Spring-Security-防火前与-Sql-注入"><a href="#5、Spring-Security-防火前与-Sql-注入" class="headerlink" title="5、Spring Security 防火前与 Sql 注入"></a>5、Spring Security 防火前与 Sql 注入</h2><p>SpringSecurity 本身不支持 ip 地址黑白名单。可以使用 SpringBoot filter 拦截。但是一般应该把拦截前置，可直接在 Linux 配置防火墙或者在 Nginx 拦截。</p>
<p>SQL 注入解决：perparestatement，预编译。</p>
<p>DDOS：拒绝服务攻击。三次握手完，不发包；三次握手最后一个包不回。</p>
<h3 id="5-1-指定-ip-可以不登录"><a href="#5-1-指定-ip-可以不登录" class="headerlink" title="5.1 指定 ip 可以不登录"></a>5.1 指定 ip 可以不登录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">&quot;/ip1&quot;</span>).hasIpAddress(<span class="string">&quot;127.0.0.1&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-禁止ip访问"><a href="#5-2-禁止ip访问" class="headerlink" title="5.2 禁止ip访问"></a>5.2 禁止ip访问</h3><p>用Filter 实现、或者用HandlerInterceptor 实现</p>
<h3 id="5-3-StrictHttpFirewall"><a href="#5-3-StrictHttpFirewall" class="headerlink" title="5.3 StrictHttpFirewall"></a>5.3 StrictHttpFirewall</h3><p>spring security 默认使用StrictHttpFirewall限制用户请求</p>
<h4 id="method"><a href="#method" class="headerlink" title="method"></a>method</h4><p>缺省被允许的<code>HTTP method</code>有 [<code>DELETE</code>, <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>, <code>PATCH</code>, <code>POST</code>, <code>PUT</code>]</p>
<h4 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h4><p><strong>在其<code>requestURI</code>/<code>contextPath</code>/<code>servletPath</code>/<code>pathInfo</code>中，必须不能包含以下字符串序列之一 :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;&#x2F;&#x2F;&quot;,&quot;.&#x2F;&quot;,&quot;&#x2F;…&#x2F;&quot;,&quot;&#x2F;.&quot;]</span><br></pre></td></tr></table></figure>

<h4 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">;或者%3b或者%3B</span><br><span class="line">&#x2F;&#x2F; 禁用规则</span><br><span class="line">setAllowSemicolon(boolean)</span><br></pre></td></tr></table></figure>

<h4 id="斜杠"><a href="#斜杠" class="headerlink" title="斜杠"></a>斜杠</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%2f&#96;或者&#96;%2F</span><br><span class="line">&#x2F;&#x2F; 禁用规则</span><br><span class="line">setAllowUrlEncodedSlash(boolean)</span><br></pre></td></tr></table></figure>

<h4 id="反斜杠"><a href="#反斜杠" class="headerlink" title="反斜杠"></a>反斜杠</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\或者%5c或者%5B</span><br><span class="line">&#x2F;&#x2F; 禁用规则</span><br><span class="line">setAllowBackSlash(boolean)</span><br></pre></td></tr></table></figure>

<h4 id="英文句号"><a href="#英文句号" class="headerlink" title="英文句号"></a>英文句号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%2e或者%2E</span><br><span class="line">&#x2F;&#x2F; 禁用规则</span><br><span class="line">setAllowUrlEncodedPeriod(boolean)</span><br></pre></td></tr></table></figure>

<h4 id="百分号"><a href="#百分号" class="headerlink" title="百分号"></a>百分号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%25</span><br><span class="line">&#x2F;&#x2F; 禁用规则</span><br><span class="line">setAllowUrlEncodedPercent(boolean)</span><br></pre></td></tr></table></figure>

<h4 id="防火墙与sql注入"><a href="#防火墙与sql注入" class="headerlink" title="防火墙与sql注入"></a>防火墙与sql注入</h4><p>‘ ; – % 多数非法字符已经在请求的参数上被禁用</p>
<p>为啥用户名不能有特殊字符</p>
<p>preparestatement </p>
<p>awf前端拦截</p>
<h2 id="6、注销登录"><a href="#6、注销登录" class="headerlink" title="6、注销登录"></a>6、注销登录</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">    .logout()</span><br><span class="line">    .logoutUrl(<span class="string">&quot;/out&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="7、退出登录、登录成功-失败控制器"><a href="#7、退出登录、登录成功-失败控制器" class="headerlink" title="7、退出登录、登录成功/失败控制器"></a>7、退出登录、登录成功/失败控制器</h2><h3 id="增加退出处理器"><a href="#增加退出处理器" class="headerlink" title="增加退出处理器"></a>增加退出处理器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.addLogoutHandler(new LogoutHandler() &#123;</span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">	public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) &#123;</span><br><span class="line">		&#x2F;&#x2F; TODO Auto-generated method stub</span><br><span class="line">		System.out.println(&quot;退出1&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.addLogoutHandler(new LogoutHandler() &#123;</span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">	public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) &#123;</span><br><span class="line">		&#x2F;&#x2F; TODO Auto-generated method stub</span><br><span class="line">		System.out.println(&quot;退出2&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="登录成功处理器"><a href="#登录成功处理器" class="headerlink" title="登录成功处理器"></a>登录成功处理器</h3><p>不同角色 跳转到不同页面</p>
<pre><code>    .successHandler(new AuthenticationSuccessHandler() &#123;

        @Override
        public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
                Authentication authentication) throws IOException, ServletException &#123;
            // TODO Auto-generated method stub

            System.out.println(&quot;登录成功1&quot;);
            // 根据权限不同，跳转到不同页面
            request.getSession().getAttribute(name)
            request.getRequestDispatcher(&quot;&quot;).forward(request, response);
        &#125;
    &#125;)</code></pre>
<p>其中 Authentication 参数包含了 用户权限信息</p>
<h3 id="登录失败处理器"><a href="#登录失败处理器" class="headerlink" title="登录失败处理器"></a>登录失败处理器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.failureHandler(new AuthenticationFailureHandler() &#123;</span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">	public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">			AuthenticationException exception) throws IOException, ServletException &#123;</span><br><span class="line">		&#x2F;&#x2F; TODO Auto-generated method stub</span><br><span class="line">		exception.printStackTrace();</span><br><span class="line">		request.getRequestDispatcher(request.getRequestURL().toString()).forward(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>可以限制登录错误次数</p>
<h4 id="常见登录异常"><a href="#常见登录异常" class="headerlink" title="常见登录异常"></a>常见登录异常</h4><p><strong>LockedException</strong> 账户被锁定</p>
<p><strong>CredentialsExpiredException</strong> 密码过期</p>
<p><strong>AccountExpiredException</strong> 账户过期</p>
<p><strong>DisabledException</strong> 账户被禁用</p>
<p><strong>BadCredentialsException</strong> 密码错误</p>
<p><strong>UsernameNotFoundException</strong> 用户名错误</p>
<h2 id="8、Ant-风格路径表达式"><a href="#8、Ant-风格路径表达式" class="headerlink" title="8、Ant 风格路径表达式"></a>8、Ant 风格路径表达式</h2><table>
<thead>
<tr>
<th>通配符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>?</td>
<td>匹配任何单字符</td>
</tr>
<tr>
<td>*</td>
<td>匹配0或者任意数量的字符</td>
</tr>
<tr>
<td>**</td>
<td>匹配0或者更多的目录</td>
</tr>
</tbody></table>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><table>
<thead>
<tr>
<th>URL路径</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>/app/*.x</td>
<td>匹配(Matches)所有在app路径下的.x文件</td>
</tr>
<tr>
<td>/app/p?ttern</td>
<td>匹配(Matches) /app/pattern 和 /app/pXttern,但是不包括/app/pttern</td>
</tr>
<tr>
<td>/**/example</td>
<td>匹配(Matches) /app/example, /app/foo/example, 和 /example</td>
</tr>
<tr>
<td>/app/*<em>/dir/file.</em></td>
<td>匹配(Matches) /app/dir/file.jsp, /app/foo/dir/file.html,/app/foo/bar/dir/file.pdf, 和 /app/dir/file.java</td>
</tr>
<tr>
<td>/*<em>/</em>.jsp</td>
<td>匹配(Matches)任何的.jsp 文件</td>
</tr>
</tbody></table>
<h4 id="最长匹配原则"><a href="#最长匹配原则" class="headerlink" title="最长匹配原则"></a>最长匹配原则</h4><p>最长匹配原则(has more characters)<br>说明，URL请求 /app/dir/file.jsp，现在存在两个路径匹配模式/*<em>/</em>.jsp和/app/dir/<em>.jsp，那么会根据模式/app/dir/</em>.jsp来匹配</p>
<h4 id="匹配顺序"><a href="#匹配顺序" class="headerlink" title="匹配顺序"></a>匹配顺序</h4><p>security 像 shiro 一样，权限匹配有顺序，比如不能把 .anyRequest().authenticated() 写在其他规则前面</p>
<h2 id="9、基于角色的权限控制与继承"><a href="#9、基于角色的权限控制与继承" class="headerlink" title="9、基于角色的权限控制与继承"></a>9、基于角色的权限控制与继承</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	http.authorizeRequests()</span><br><span class="line">	.antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">	.antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Bean</span>        </span><br><span class="line"><span class="function">RoleHierarchy <span class="title">roleHierarchy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	RoleHierarchyImpl impl = <span class="keyword">new</span> RoleHierarchyImpl();</span><br><span class="line">	impl.setHierarchy(<span class="string">&quot;ROLE_admin &gt; ROLE_user&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10、细粒度方法级权限控制"><a href="#10、细粒度方法级权限控制" class="headerlink" title="10、细粒度方法级权限控制"></a>10、细粒度方法级权限控制</h2><p><strong>配置开启</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true,securedEnabled = true)</span></span><br></pre></td></tr></table></figure>

<p><strong>使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hi&quot;)</span></span><br><span class="line">    <span class="meta">@Secured(&quot;ROLE_admin&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hi1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=====&gt;来啦,老弟...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hi admin...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/hi&quot;)</span></span><br><span class="line">    <span class="comment">// 或者关系，@Secured 没法实现并且关系</span></span><br><span class="line">    <span class="meta">@Secured(&#123;&quot;ROLE_admin&quot;,&quot;ROLE_user&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hi2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=====&gt;来啦,老弟...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hi user...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hi3&quot;)</span></span><br><span class="line">    <span class="comment">// 并且关系</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_admin&#x27;) AND hasRole(&#x27;ROLE_user&#x27;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hi3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=====&gt;来啦,老弟...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hi admin 3...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hi4&quot;)</span></span><br><span class="line">    <span class="comment">// 可以写 spel 表达式，根据返回值判断是否有权限。</span></span><br><span class="line">    <span class="meta">@PostAuthorize(&quot;returnObject==1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">hi4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=====&gt;来啦,老弟...&quot;</span>);</span><br><span class="line">        <span class="comment">// 访问子系统，把当前用户角色带过去，让子系统校验是否有权限</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Random().nextInt(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>获取当前用户权限信息和 UserDetails</strong></p>
<p>自己写权限校验时可能会用到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">	</span><br><span class="line">authentication.getPrincipal()</span><br></pre></td></tr></table></figure>

<h2 id="11、自定义前置-Filter-及图形验证码"><a href="#11、自定义前置-Filter-及图形验证码" class="headerlink" title="11、自定义前置 Filter 及图形验证码"></a>11、自定义前置 Filter 及图形验证码</h2><p>目的：防机器暴力登陆</p>
<p>人机交互/手机验证码：机器基本没法破解</p>
<p>数字图形机器识别简单一点，图片机器识别稍微麻烦一点，但是图形验证码现在基本上是不安全的了，因为机器学习算法给它点时间就能破解。</p>
<h3 id="Kaptcha"><a href="#Kaptcha" class="headerlink" title="Kaptcha"></a>Kaptcha</h3><table>
<thead>
<tr>
<th>Constant</th>
<th>描述</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>kaptcha.border</td>
<td>图片边框，合法值：yes , no</td>
<td>yes</td>
</tr>
<tr>
<td>kaptcha.border.color</td>
<td>边框颜色，合法值： r,g,b (and optional alpha) 或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.image.width</td>
<td>图片宽</td>
<td>200</td>
</tr>
<tr>
<td>kaptcha.image.height</td>
<td>图片高</td>
<td>50</td>
</tr>
<tr>
<td>kaptcha.producer.impl</td>
<td>图片实现类</td>
<td>com.google.code.kaptcha.impl.DefaultKaptcha</td>
</tr>
<tr>
<td>kaptcha.textproducer.impl</td>
<td>文本实现类</td>
<td>com.google.code.kaptcha.text.impl.DefaultTextCreator</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.string</td>
<td>文本集合，验证码值从此集合中获取</td>
<td>abcde2345678gfynmnpwx</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.length</td>
<td>验证码长度</td>
<td>5</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.names</td>
<td>字体</td>
<td>Arial, Courier</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.size</td>
<td>字体大小</td>
<td>40px.</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.color</td>
<td>字体颜色，合法值： r,g,b  或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.space</td>
<td>文字间隔</td>
<td>2</td>
</tr>
<tr>
<td>kaptcha.noise.impl</td>
<td>干扰实现类</td>
<td>com.google.code.kaptcha.impl.DefaultNoise</td>
</tr>
<tr>
<td>kaptcha.noise.color</td>
<td>干扰 颜色，合法值： r,g,b 或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.obscurificator.impl</td>
<td>图片样式：<br />水纹 com.google.code.kaptcha.impl.WaterRipple <br /> 鱼眼 com.google.code.kaptcha.impl.FishEyeGimpy <br /> 阴影 com.google.code.kaptcha.impl.ShadowGimpy</td>
<td>com.google.code.kaptcha.impl.WaterRipple</td>
</tr>
<tr>
<td>kaptcha.background.impl</td>
<td>背景实现类</td>
<td>com.google.code.kaptcha.impl.DefaultBackground</td>
</tr>
<tr>
<td>kaptcha.background.clear.from</td>
<td>背景颜色渐变，开始颜色</td>
<td>light grey</td>
</tr>
<tr>
<td>kaptcha.background.clear.to</td>
<td>背景颜色渐变， 结束颜色</td>
<td>white</td>
</tr>
<tr>
<td>kaptcha.word.impl</td>
<td>文字渲染器</td>
<td>com.google.code.kaptcha.text.impl.DefaultWordRenderer</td>
</tr>
<tr>
<td>kaptcha.session.key</td>
<td>session key</td>
<td>KAPTCHA_SESSION_KEY</td>
</tr>
<tr>
<td>kaptcha.session.date</td>
<td>session date</td>
<td>KAPTCHA_SESSION_DATE</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="添加一个前置Filter"><a href="#添加一个前置Filter" class="headerlink" title="添加一个前置Filter"></a>添加一个前置Filter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(<span class="keyword">new</span> CodeFilter(), UsernamePasswordAuthenticationFilter.class);</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">		HttpServletRequest req = (HttpServletRequest)request;</span><br><span class="line">		HttpServletResponse resp = (HttpServletResponse)response;</span><br><span class="line">		</span><br><span class="line">		String uri = req.getServletPath();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(uri.equals(<span class="string">&quot;/login&quot;</span>) &amp;&amp; req.getMethod().equalsIgnoreCase(<span class="string">&quot;post&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">			String sessionCode = req.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY).toString();</span><br><span class="line">			String formCode = req.getParameter(<span class="string">&quot;code&quot;</span>).trim();</span><br><span class="line">				</span><br><span class="line">			<span class="keyword">if</span>(StringUtils.isEmpty(formCode)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;验证码不能为空&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(sessionCode.equalsIgnoreCase(formCode)) &#123;</span><br><span class="line">				</span><br><span class="line">				System.out.println(<span class="string">&quot;验证通过&quot;</span>);</span><br><span class="line">				</span><br><span class="line">			&#125;		</span><br><span class="line">					System.out.println(req.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY));</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">&quot;xx&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>显示验证码的Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/kaptcha&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getKaptchaImage</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       HttpSession session = request.getSession();</span><br><span class="line">       response.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line">       response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-store, no-cache, must-revalidate&quot;</span>);</span><br><span class="line">       response.addHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;post-check=0, pre-check=0&quot;</span>);</span><br><span class="line">       response.setHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">       response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">       String capText = captchaProducer.createText();</span><br><span class="line">       </span><br><span class="line">       session.setAttribute(Constants.KAPTCHA_SESSION_KEY, capText);</span><br><span class="line">       BufferedImage bi = captchaProducer.createImage(capText);</span><br><span class="line">       ServletOutputStream out = response.getOutputStream();</span><br><span class="line">       ImageIO.write(bi, <span class="string">&quot;jpg&quot;</span>, out);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           out.flush();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           out.close();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Kaconfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultKaptcha <span class="title">getDefaultKaptcha</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultKaptcha captchaProducer = <span class="keyword">new</span> DefaultKaptcha();</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border&quot;</span>, <span class="string">&quot;yes&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border.color&quot;</span>, <span class="string">&quot;105,179,90&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="string">&quot;blue&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;310&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;240&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="string">&quot;30&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.session.key&quot;</span>, <span class="string">&quot;code&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">    <span class="comment">//    properties.setProperty(&quot;kaptcha.textproducer.char.string&quot;, &quot;678&quot;);</span></span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.obscurificator.impl&quot;</span>, <span class="string">&quot;com.google.code.kaptcha.impl.ShadowGimpy&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.names&quot;</span>, <span class="string">&quot;宋体,楷体,微软雅黑&quot;</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config(properties);</span><br><span class="line">        captchaProducer.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> captchaProducer;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="12、集群化服务之-Session-共享-SpringSession-Redis"><a href="#12、集群化服务之-Session-共享-SpringSession-Redis" class="headerlink" title="12、集群化服务之 Session 共享 SpringSession + Redis"></a>12、集群化服务之 Session 共享 SpringSession + Redis</h2></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2020-10-05-Spring%20Cloud/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86(3).html"></a><a class="next" href="/2020-10-04-Spring%20Cloud/SpringCloud(6)-config.html">SpringCloud学习(八)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%8A%80%E6%9C%AF/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%89%E4%BB%96/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%83%E6%83%85/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A0%E5%85%B3%E6%8A%80%E6%9C%AF/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%96%AF%E7%8B%82-Java-%E8%AE%B2%E4%B9%89/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/%E5%BF%83%E6%83%85/" style="font-size: 15px;">心情</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/%E5%90%89%E4%BB%96/" style="font-size: 15px;">吉他</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">多线程</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a> <a href="/tags/%E6%97%A0%E5%85%B3%E6%8A%80%E6%9C%AF/" style="font-size: 15px;">无关技术</a> <a href="/tags/%E7%96%AF%E7%8B%82-Java-%E8%AE%B2%E4%B9%89/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">网络</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">前端</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>