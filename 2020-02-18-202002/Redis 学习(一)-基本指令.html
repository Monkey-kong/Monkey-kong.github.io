<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="悟空的技术博客"><title>Redis 学习(一)-概述、安装、类型、指令 | 悟空</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis 学习(一)-概述、安装、类型、指令</h1><a id="logo" href="/.">悟空</a><p class="description">悟空的技术博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Redis 学习(一)-概述、安装、类型、指令</h1><div class="post-meta">2020-02-18<span> | </span><span class="category"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Redis-%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F"><span class="toc-text">1. Redis 前世今生</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-0-%E4%B8%80%E7%82%B9%E5%B8%B8%E8%AF%86"><span class="toc-text">1.0 一点常识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%9C%80%E5%88%9D%E6%95%B0%E6%8D%AE%E6%98%AF%E5%AD%98%E5%9C%A8%E6%96%87%E4%BB%B6%E4%B8%AD"><span class="toc-text">1.1 最初数据是存在文件中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">1.2 关系型数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%85%B3%E7%B3%BB%E5%9E%8B%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%BA%E7%82%B9"><span class="toc-text">1.3 关系型内存数据库缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-key-value-%E5%9E%8B%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93-Redis"><span class="toc-text">1.4 key-value 型内存数据库 Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Redis-%E5%92%8C-memcached-%E5%AF%B9%E6%AF%94"><span class="toc-text">1.5 Redis 和 memcached 对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%AF%B9%E6%AF%94%E5%90%84%E7%B1%BB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">1.4 对比各类数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8D%B8%E8%BD%BD-%E5%AE%89%E8%A3%85-Redis"><span class="toc-text">2. 卸载&#x2F;安装 Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85-Redis"><span class="toc-text">2.1 安装 Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%8D%B8%E8%BD%BD-Redis"><span class="toc-text">2.2 卸载 Redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%90%86%E8%A7%A3"><span class="toc-text">3. Redis 单线程理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Redis-%E4%BA%94%E7%A7%8D-value-%E7%B1%BB%E5%9E%8B"><span class="toc-text">4. Redis 五种 value 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-string"><span class="toc-text">4.1 string</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-string-%E7%B1%BB%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-text">4.1.1 string 类型应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-text">4.1.2 数值类型应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-bitmap-%E7%B1%BB%E5%BA%94%E7%94%A8"><span class="toc-text">4.1.3 bitmap 类应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-4-bitfield-%E5%91%BD%E4%BB%A4%E7%90%86%E8%A7%A3"><span class="toc-text">4.1.4 bitfield 命令理解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-list"><span class="toc-text">4.2 list</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-list-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">4.2.1 list 应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-hash"><span class="toc-text">4.3 hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-hash-%E5%BC%95%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">4.3.1 hash 引用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-set"><span class="toc-text">4.4 set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-set-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">4.4.1 set 应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-sorted-set"><span class="toc-text">4.5 sorted_set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-1-sorted-set-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">4.5.1 sorted set 使用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-2-%E5%AD%97%E5%85%B8%E8%A7%84%E5%88%99-lexicographical"><span class="toc-text">4.5.2 字典规则  lexicographical</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-3-%E8%B7%B3%E8%B7%83%E8%A1%A8"><span class="toc-text">4.5.3 跳跃表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Redis-%E9%80%9A%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="toc-text">5. Redis 通用指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-scan-%E5%91%BD%E4%BB%A4%E7%90%86%E8%A7%A3"><span class="toc-text">5.1 scan 命令理解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%AD%A6%E4%B9%A0%E5%9C%B0%E5%9D%80%E8%AE%B0%E5%BD%95"><span class="toc-text">6. 学习地址记录</span></a></li></ol></div></div><div class="post-content"><p>Redis 来由、安装、集中基本类型和指令学习笔记。</p>
<a id="more"></a>
<h2 id="1-Redis-前世今生"><a href="#1-Redis-前世今生" class="headerlink" title="1. Redis 前世今生"></a>1. Redis 前世今生</h2><h3 id="1-0-一点常识"><a href="#1-0-一点常识" class="headerlink" title="1.0 一点常识"></a>1.0 一点常识</h3><ul>
<li>磁盘寻址速度 ms 级别，带宽 G 或 M 级别</li>
<li>内存寻址速度 ns 级别，比磁盘寻址快了 10 万倍，带宽极大</li>
<li>磁盘有磁道和扇区，一扇区默认 512 Byte。</li>
</ul>
<h3 id="1-1-最初数据是存在文件中"><a href="#1-1-最初数据是存在文件中" class="headerlink" title="1.1 最初数据是存在文件中"></a>1.1 最初数据是存在文件中</h3><p>比如 linux 使用 grep、awk 来检索数据，随着文件的变大，速度会变慢。因为是<strong>全量检索</strong>，会遇到磁盘寻址和吞吐的瓶颈。数据库使用<strong>分治</strong>来解决，Redis 作为缓存，存的不是全量数据，而是热数据。</p>
<h3 id="1-2-关系型数据库"><a href="#1-2-关系型数据库" class="headerlink" title="1.2 关系型数据库"></a>1.2 关系型数据库</h3><p>数据库使用多个 datapage 存储表的数据，每个 datapage 4k （可以调整）大小，把<strong>数据分开存储</strong>，然后可以有索引来检索这些数据，索引也是存储在 datapage 中。索引使用内存里的 B+ 树来管理，B+ 树树干是在内存中，索引放在 B+ 树的叶子上，sql 语句中 where 条件只要命中索引， B+ 树就沿着树干找到索引的叶子，然后把叶子 datapage 读到内存解析，然后知道解析（放到内存中）哪些数据 datapage。</p>
<p>结构图如下：</p>
<p><img src="../../images/redis1/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%93%E6%9E%84.png"></p>
<p><strong>问题：</strong>关系型数据库建表时为什么必须给出 schema ? </p>
<p><strong>答案：</strong>因为存储数据时，倾向于行级存储。就是说即使这个表有十个字段，有一行数据只有一个字段有值，存储时也会开辟十个字段的 datapage。这样的好处是<strong>后边增删改这行数据就不用做偏移了，直接重写</strong>就行。</p>
<p><strong>问题：</strong>数据库表很大，会导致性能下降？</p>
<p><strong>答案：</strong>如果表有索引，增删改需要维护索引，性能会变慢。查询则分两种情况：1. 一个或少量查询依然会很快。 2. 并发大的时候会受到<strong>磁盘带宽</strong>的影响导致速度变慢</p>
<p>问题：什么是 4k 对齐？</p>
<p>答案：正常来说，磁盘一个扇区 512 Byte。所谓 4k 对齐就是指按照 4k 来划分小格子，索引的体量大小变小了，操作系统读取的时候，不论读取多大的数据都是按照 4k 读取。注意磁盘格子的大小不一定是 4k，这取决于上层应用。比如上层应用主要用于存储视频，音频等，4k 可能太小了，浪费了磁盘寻址时间，反而得不偿失。</p>
<p><strong>缺点：</strong></p>
<ul>
<li>数据是存在磁盘的文件里。随着文件变大，速度会变慢，因为硬盘 I/O 成为瓶颈。</li>
<li>磁盘寻址慢</li>
<li>随着数据量增大，索引成本变大</li>
</ul>
<h3 id="1-3-关系型内存数据库缺点"><a href="#1-3-关系型内存数据库缺点" class="headerlink" title="1.3 关系型内存数据库缺点"></a>1.3 关系型内存数据库缺点</h3><p>如果直接使用关系型内存数据库，速度确实快，比如 SAP 公司的 HANA 数据库就是关系型内存数据库，但是价格太贵，一般买不起。但是磁盘数据库又太慢了。</p>
<p>所以出现了折中方案：key-value 型内存数据库： <strong>memcached、Redis</strong></p>
<h3 id="1-4-key-value-型内存数据库-Redis"><a href="#1-4-key-value-型内存数据库-Redis" class="headerlink" title="1.4 key-value 型内存数据库 Redis"></a>1.4 key-value 型内存数据库 Redis</h3><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作<strong>数据库、缓存和消息中间件</strong>。 </p>
<p>Redis 支持多种类型的数据结构，如字符串、散列、列表、集合、有序集合与范围查询，bitmaps、hyperloglogs 和地理空间索引半径查询。</p>
<p>Redis 内置了复制，LUA 脚本，LRU 驱动事件，事务和不同级别的磁盘持久化，并通过 Redis 哨兵和自动分区提供高可用性。</p>
<h3 id="1-5-Redis-和-memcached-对比"><a href="#1-5-Redis-和-memcached-对比" class="headerlink" title="1.5 Redis 和 memcached 对比"></a>1.5 Redis 和 memcached 对比</h3><p>在 Redis 之前，有memcached，也是 key-value 型数据库，但是它的 value 没有类型的概念，所以更多人选择使用 Redis。</p>
<p><strong>问题：</strong> memcached 的 value 也可以用 json 来存储复杂的数据结构，为啥会选择 Redis？</p>
<p><strong>答案：</strong>因为获取数据成本不同，比如从一个 list 类型的 value 中取一个元素：</p>
<ul>
<li>memcached 需要返回 value 所有的数据到客户端，就是整个 list json 数据。会导致两个问题：1. server 端网卡 IO 限制。2. 客户端需要自己实现代码去解码 json。</li>
<li>Redis 其实类型不是很重要，<strong>它本身是二进制安全的</strong>，重要的是 Redis 中对每种类型都有自己的方法。比如根据 index、lpop 等。避免的上面的两个问题（返回需要的数据，降低 I/O 消耗；计算向数据移动，计算主要在 Redis server 端完成）。</li>
</ul>
<p><strong>问题：</strong>Redis 为什么不用 sql 查询，而是 key-value？</p>
<p><strong>答案：</strong>因为 Redis 设计的初衷不是存储全量数据，而是存储部分数据。部分数据无法维护类似关系型数据库中的<strong>约束、范式</strong>，所以还不如面向数据本身，把场景简单化。</p>
<h3 id="1-4-对比各类数据库"><a href="#1-4-对比各类数据库" class="headerlink" title="1.4 对比各类数据库"></a>1.4 对比各类数据库</h3><p>可以参考： <a href="https://db-engines.com/en/">https://db-engines.com/en/</a> </p>
<h2 id="2-卸载-安装-Redis"><a href="#2-卸载-安装-Redis" class="headerlink" title="2. 卸载/安装 Redis"></a>2. 卸载/安装 Redis</h2><h3 id="2-1-安装-Redis"><a href="#2-1-安装-Redis" class="headerlink" title="2.1 安装 Redis"></a>2.1 安装 Redis</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// 1. 检查是否已经安装 wget</span><br><span class="line">rpm -qa|grep wget</span><br><span class="line">// 2. 如果没有安装则安装 wget</span><br><span class="line">yum install wget</span><br><span class="line">// 3. 下载 redis 源码到家目录</span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">mkdir soft</span><br><span class="line"><span class="built_in">cd</span> soft</span><br><span class="line">wget http://download.redis.io/releases/redis-5.0.5.tar.gz</span><br><span class="line">// 4. 解压源码</span><br><span class="line">tar xf redis-5.0.5.tar.gz</span><br><span class="line">// 5. 阅读 README.md 文件</span><br><span class="line"><span class="built_in">cd</span> redis--5.0.5</span><br><span class="line">vi README.md</span><br><span class="line">// 6. 编译源码</span><br><span class="line">make</span><br><span class="line">// 7. 如果提示 cc:<span class="built_in">command</span> not found；否则跳过</span><br><span class="line">yum install gcc</span><br><span class="line">make distclean</span><br><span class="line">make</span><br><span class="line">// 8. 发现源码 src 目录已经生成了可执行文件</span><br><span class="line">// 9. 安装 redis 到指定目录</span><br><span class="line">make install PREFIX=/opt/alvin/redis5</span><br><span class="line">// 10. 添加 path 环境变量</span><br><span class="line">vi /etc/profile</span><br><span class="line">  <span class="built_in">export</span> REDIS_HOME=/opt/alvin/redis5</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$REDIS_HOME</span>/bin</span><br><span class="line">// 11. 刷新环境变量</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">// 12. 将 redis 安装为服务</span><br><span class="line"><span class="built_in">cd</span> utils</span><br><span class="line">// 可执行一次或者多次</span><br><span class="line">// a) 一个物理机中可以有多个 redis 实例（进程），通过端口号区分</span><br><span class="line">// b) 可执行程序就一份在目录，但是内存中未来的多个实例需要各自的配置文件，持久化目录等</span><br><span class="line">// c) redis 服务已经自动启动</span><br><span class="line">../../install_server.sh</span><br><span class="line">// 13. 查看服务状态</span><br><span class="line">service redis_6379 status</span><br><span class="line">// 14. 查看 redis 服务进程</span><br><span class="line">ps -ef|grep redis</span><br></pre></td></tr></table></figure>

<p><img src="../../images/redis1/%E5%AE%89%E8%A3%85redis1.png"></p>
<h3 id="2-2-卸载-Redis"><a href="#2-2-卸载-Redis" class="headerlink" title="2.2 卸载 Redis"></a>2.2 卸载 Redis</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 1. 检查是否已经安装 redis</span><br><span class="line">whereis redis-server</span><br><span class="line">// 2. 如果安装了，停止 redis 服务</span><br><span class="line">service redis_6379 stop</span><br><span class="line">// 3. 删除 redis 服务</span><br><span class="line">// 不删除也无影响</span><br><span class="line">// 4. 删除安装文件</span><br><span class="line">rm -rf redis5</span><br><span class="line">// 5. 删除源码</span><br><span class="line">rm -rf redis-5.0.5</span><br><span class="line">rm -rf redis-5.0.5.tar.gz</span><br></pre></td></tr></table></figure>

<p><img src="../../images/redis1/%E5%8D%B8%E8%BD%BDredis.png"></p>
<h2 id="3-Redis-单线程理解"><a href="#3-Redis-单线程理解" class="headerlink" title="3. Redis 单线程理解"></a>3. Redis 单线程理解</h2><p>一台物理机上可以安装多个 Redis 实例，Redis 服务端处理是单进程、单线程、单实例的。当并发很多的请求的时候，它是如何变得很快的？</p>
<p>I/O 多路复用模型。</p>
<h2 id="4-Redis-五种-value-类型"><a href="#4-Redis-五种-value-类型" class="headerlink" title="4. Redis 五种 value 类型"></a>4. Redis 五种 value 类型</h2><h3 id="4-1-string"><a href="#4-1-string" class="headerlink" title="4.1 string"></a>4.1 string</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">// =================通用类开始====================</span><br><span class="line">// 查看帮助</span><br><span class="line">redis-cli -<span class="built_in">help</span></span><br><span class="line">// 客服端连接 -n 表示连那个库，一共有16个库</span><br><span class="line">redis-cli -p 6379 -n 0</span><br><span class="line">// 不带raw：redis 只会识别 ascii 码，超出 ascii 直接显示 16 进制</span><br><span class="line">// 带了raw：会触发编码集的格式化。发现了当前的十六进制符合当前编码字符集的规则，就会转换</span><br><span class="line">redis-cli --raw</span><br><span class="line">// 切换库</span><br><span class="line">select 8</span><br><span class="line">// 如何学习命令</span><br><span class="line"><span class="built_in">help</span></span><br><span class="line">// 查看 value 类型</span><br><span class="line"><span class="built_in">type</span> k1</span><br><span class="line">// <span class="built_in">type</span> 还是 string，因为 <span class="built_in">set</span> 命令是 string 组的</span><br><span class="line"><span class="built_in">set</span> k1 99</span><br><span class="line">object <span class="built_in">help</span></span><br><span class="line">// 查看 value 编码 int</span><br><span class="line">object encoding k1</span><br><span class="line">// =================通用类结束====================</span><br><span class="line">// =================字符串类开始===================</span><br><span class="line">// nx（只能新增）：k1 不存在的时候才操作</span><br><span class="line"><span class="built_in">set</span> k1 ooxx nx</span><br><span class="line">// xx（只能更新）：k2 存在的时候才操作</span><br><span class="line"><span class="built_in">set</span> k2 hello xx</span><br><span class="line">setex k1 5 aaa</span><br><span class="line">psetex k1 5000 aaa</span><br><span class="line">// mset、mget 设置、获取多条</span><br><span class="line">mset k3 a k4 b</span><br><span class="line">mget k3 k4</span><br><span class="line">// msetnx(只能新增)</span><br><span class="line">msetnx k1 a k2 b</span><br><span class="line">msetnx k2 c k3 d</span><br><span class="line">// 只找到 k1、k2 说明 msetnx 是原子性的</span><br><span class="line">mget k1 k2 k3</span><br><span class="line">// append 追加</span><br><span class="line">append k1 <span class="string">&quot; world&quot;</span></span><br><span class="line">// getrange 获取索引范围内字节</span><br><span class="line">getrange k1 6 10</span><br><span class="line">// 有正向索引和反向索引</span><br><span class="line">getrange k1 6 -1</span><br><span class="line">getrange k1 0 -1</span><br><span class="line">// 覆盖指定位置开始的字符串，能覆盖多少就覆盖多少</span><br><span class="line">setrange k1 6 mashibing</span><br><span class="line">// 字符串长度</span><br><span class="line">strlen k1</span><br><span class="line">// =================字符串类结束===================</span><br><span class="line">// =================数值类开始=====================</span><br><span class="line">// 加1</span><br><span class="line">incr k1</span><br><span class="line">// 加22</span><br><span class="line">incrby k1 22</span><br><span class="line">// 减1</span><br><span class="line">decr k1</span><br><span class="line">// 减22</span><br><span class="line">decrby k1 22</span><br><span class="line">// 加0.5</span><br><span class="line">incrbyfloat k1 0.5</span><br><span class="line">// =================数值类结束=====================</span><br><span class="line">// =================bitmap类开始==================</span><br><span class="line">// 面向字节有索引，二进制位也有索引</span><br><span class="line">// offset 的 1 是指位索引的第二个位置设置为 1</span><br><span class="line">// 注意 setbit 是位级别 <span class="built_in">set</span></span><br><span class="line">// strlen为1 @</span><br><span class="line">setbit k1 1 1</span><br><span class="line">// strlen为1 A</span><br><span class="line">setbit k1 7 1</span><br><span class="line">// strlen为2 A@</span><br><span class="line">setbit k1 9 1</span><br><span class="line">getbit k1 0</span><br><span class="line">// 指定范围直接内，查询第一次出现指定位的位索引：1</span><br><span class="line">bitpos k1 1 0 0</span><br><span class="line">// 9</span><br><span class="line">bitpos k1 1 1 1</span><br><span class="line">// 1：第一个字节到第二个字节，1第一次出现1的位索引</span><br><span class="line">bitpos k1 1 0 1</span><br><span class="line">// 4：第一个字节到第二个字节1出现的次数</span><br><span class="line">bitcount k1 0 1</span><br><span class="line">// k1 k2 按位与的结果存到 andkey</span><br><span class="line">bitop and andkey k1 k2</span><br><span class="line">// 按位或</span><br><span class="line">bitop or orkey k1 k2</span><br><span class="line">// =================bitmap类结束==================</span><br></pre></td></tr></table></figure>

<h4 id="4-1-1-string-类型应用"><a href="#4-1-1-string-类型应用" class="headerlink" title="4.1.1 string 类型应用"></a>4.1.1 string 类型应用</h4><ol>
<li>分布式锁： string 类型的 setnx 的作用是“当 key 不存在时，设值并返回 1，当 key 已经存在时，不设值并返回 0”，“判断 key 是否存在”和“设值”两个操作是原子性地执行的，因此可以用 string 类型作为分布式锁，返回 1 表示获得锁，返回 0 表示没有获得锁。 </li>
<li>存储对象：对象转为 json，存入 Redis。</li>
</ol>
<h4 id="4-1-2-数值类型应用"><a href="#4-1-2-数值类型应用" class="headerlink" title="4.1.2 数值类型应用"></a>4.1.2 数值类型应用</h4><p>计数器：抢购、秒杀、点赞、评论数。<strong>规避并发下，对数据库的事务操作</strong>，完全由 reids 内存操作代替。</p>
<h4 id="4-1-3-bitmap-类应用"><a href="#4-1-3-bitmap-类应用" class="headerlink" title="4.1.3 bitmap 类应用"></a>4.1.3 bitmap 类应用</h4><ol>
<li><p>有一个用户系统，需要统计用户登录天数，且窗口（日期）随机，怎么统计？</p>
<p>使用用户 id 作为 key，value 为 bitmap，位索引表示日期，位值为 1 表示登录了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// alvin 第二天登录了</span><br><span class="line">setbit alvin 1 1</span><br><span class="line">// alvin 第八天登录了</span><br><span class="line">setbit alvin 7 1</span><br><span class="line">// alvin 第 365 天登录了</span><br><span class="line">setbit alvin 364 1</span><br><span class="line">// 仅占用 46 个字节</span><br><span class="line">strlen alvin</span><br><span class="line">// 今年最后 16 天 alvin 登录次数</span><br><span class="line">bitcount alvin -2 -1</span><br><span class="line">// 问题：最后 15 天怎么统计呢？窗口期只能是 8 的倍数？或者索引全部乘以 8，这样空间又提升了 8 倍。或者 getbit 一个一个取，这样访问量又上去了，考虑使用管道或许可行。</span><br></pre></td></tr></table></figure>
</li>
<li><p>京东 618 做活动，送礼物，大库应该备货多少？即活跃用户统计。</p>
<p>以日期作为 key，value 为 bitmap，位索引表示员工编号，位值为 1 表示登录了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 一月一日一号员工登录</span><br><span class="line">setbit 20190101 1 1</span><br><span class="line">// 一月二日一号员工登录</span><br><span class="line">setbit 20190102 1 1</span><br><span class="line">// 一月二日七号员工登录</span><br><span class="line">setbit 20190102 7 1</span><br><span class="line">// 一日、二日这两天多少人登录了？</span><br><span class="line">bitop or destkey 20190101 20190102</span><br><span class="line">bitcount destkey 0 -1</span><br><span class="line">// 问题：实际情况员工或者用户 id 不一定是 1 开始排序。</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="4-1-4-bitfield-命令理解"><a href="#4-1-4-bitfield-命令理解" class="headerlink" title="4.1.4 bitfield 命令理解"></a>4.1.4 bitfield 命令理解</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// BITFIELD key </span><br><span class="line">// [GET <span class="built_in">type</span> offset] </span><br><span class="line">// [SET <span class="built_in">type</span> offset value] </span><br><span class="line">// [INCRBY <span class="built_in">type</span> offset increment] </span><br><span class="line">// [OVERFLOW WRAP|SAT|FAIL]</span><br><span class="line"><span class="built_in">set</span> key1 a</span><br><span class="line">// 97,a ASCII 码就是 97</span><br><span class="line">bitfield key1 get i8 0</span><br><span class="line"></span><br><span class="line">// 有符号 8 位，表数范围（-128~127）</span><br><span class="line">bitfield key1 <span class="built_in">set</span> i8 0 127</span><br><span class="line">// 127</span><br><span class="line">bitfield key1 get i8 0</span><br><span class="line">// 溢出默认 WARP</span><br><span class="line">bitfield key1 <span class="built_in">set</span> i8 0 128</span><br><span class="line">// -128</span><br><span class="line">bitfield key1 get i8 0</span><br><span class="line">// 设置溢出 sat</span><br><span class="line">bitfield key1 overflow sat <span class="built_in">set</span> i8 0 128</span><br><span class="line">// 127</span><br><span class="line">bitfield key1 get i8 0</span><br><span class="line">// 设置溢出 fail</span><br><span class="line">bitfield key1 overflow fail <span class="built_in">set</span> i8 0 128</span><br><span class="line">// 127(没有变化)</span><br><span class="line">bitfield key1 get i8 0</span><br><span class="line"></span><br><span class="line">// 无符号 8 位，表数范围（0~255）</span><br><span class="line">bitfield key1 <span class="built_in">set</span> u8 0 255</span><br><span class="line">// 255</span><br><span class="line">bitfield key1 get u8 0</span><br><span class="line">// 溢出默认 WARP</span><br><span class="line">bitfield key1 <span class="built_in">set</span> u8 0 257</span><br><span class="line">// 1</span><br><span class="line">bitfield key1 get u8 0</span><br><span class="line">// 设置溢出 sat</span><br><span class="line">bitfield key1 overflow sat <span class="built_in">set</span> u8 0 257</span><br><span class="line">// 255</span><br><span class="line">bitfield key1 get u8 0</span><br><span class="line">// 设置溢出 fail</span><br><span class="line">bitfield key1 overflow fail <span class="built_in">set</span> u8 0 257</span><br><span class="line">// 255（没有变化）</span><br><span class="line">bitfield key1 get u8 0</span><br><span class="line"></span><br><span class="line">// 0110 0001</span><br><span class="line"><span class="built_in">set</span> key1 a</span><br><span class="line">// 97</span><br><span class="line">bitfield key1 get i8 0</span><br><span class="line">// 110 00010 ==&gt; -62</span><br><span class="line">bitfield key1 get i8 1</span><br></pre></td></tr></table></figure>

<h3 id="4-2-list"><a href="#4-2-list" class="headerlink" title="4.2 list"></a>4.2 list</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// 向前追加</span><br><span class="line">lpush k1 a b c d e f</span><br><span class="line">// list 存在才 push</span><br><span class="line">lpushx k1 g h</span><br><span class="line">// 向后追加</span><br><span class="line">rpush k2 a b c d e f</span><br><span class="line">// list 存在才 push</span><br><span class="line">rpushx k2 g h</span><br><span class="line">// 删除并获取第一个</span><br><span class="line">lpop k1</span><br><span class="line">// 删除并获取最后一个</span><br><span class="line">rpop k1</span><br><span class="line">// 删除 lista 最后一个元素，prepend 到 listb</span><br><span class="line">rpoplpush</span><br><span class="line">// 有正向索引和反向索引</span><br><span class="line">lrange k1 0 -1</span><br><span class="line">// 根据索引获取 list 元素</span><br><span class="line">lindex k1 2</span><br><span class="line">// 反向索引</span><br><span class="line">lindex k1 -1</span><br><span class="line">// 根据索引设置值（不可超出索引范围）</span><br><span class="line">lset k1 3 xxxxx</span><br><span class="line">lrange k1 0 -1</span><br><span class="line">// 从左向右删除两个a</span><br><span class="line">lrem k1 2 a</span><br><span class="line">// 从右向左删除两个a</span><br><span class="line">lrem k3 -2 a</span><br><span class="line">// 在元素 6 后面插入 a</span><br><span class="line">linsert k3 after 6 a</span><br><span class="line">linsert k3 before 3 a</span><br><span class="line">// 删除索引两边的元素</span><br><span class="line">ltrim k3 2 -2</span><br><span class="line">ltrim k1 1 0</span><br><span class="line">// list 长度</span><br><span class="line">llen k1</span><br><span class="line">// block 版，没拿到数据则阻塞，timeout:秒</span><br><span class="line">blpop k1 0</span><br><span class="line">brpop k1 0</span><br><span class="line">brpoplpush</span><br></pre></td></tr></table></figure>

<h4 id="4-2-1-list-应用场景"><a href="#4-2-1-list-应用场景" class="headerlink" title="4.2.1 list 应用场景"></a>4.2.1 list 应用场景</h4><ol>
<li>实现各种数据结构：栈、队列、数组、阻塞的单播队列</li>
</ol>
<p><img src="../../images/redis1/list%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF.png"></p>
<ol start="2">
<li>定时计算的排行榜：实时计算的排行榜需要由 sorted set 来实现。当然 sorted set 也可以实现定时计算的排行榜，但是 sorted set 占用内存比 list 多，数据量大时需要具体考虑如何选择。</li>
</ol>
<h3 id="4-3-hash"><a href="#4-3-hash" class="headerlink" title="4.3 hash"></a>4.3 hash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">hset alvin name lixianfu age 18 address sz</span><br><span class="line">hmset alvin </span><br><span class="line">hsetnx alvin name alvin</span><br><span class="line">hget alvin name</span><br><span class="line">hgetall alvin</span><br><span class="line">hmget alvin name age</span><br><span class="line">hkeys alvin</span><br><span class="line">hvals alvin</span><br><span class="line">hincrby alvin age 1</span><br><span class="line">hincrbyfloat alvin age 0.5</span><br><span class="line">hdel alvin name address</span><br><span class="line">hexists alvin address</span><br><span class="line">// field 个数</span><br><span class="line">hlen alvin</span><br><span class="line">// 某个field 对应的 value 长度</span><br><span class="line">hstrlen alvin name</span><br><span class="line">// 迭代，同 scan 用法一样</span><br><span class="line">hscan alvin </span><br></pre></td></tr></table></figure>

<h4 id="4-3-1-hash-引用场景"><a href="#4-3-1-hash-引用场景" class="headerlink" title="4.3.1 hash 引用场景"></a>4.3.1 hash 引用场景</h4><ol>
<li>购物车：用户 id 为 key，商品 id 为 field，商品数量为 value。</li>
<li>存储对象： hash类型的(key, field, value)的结构与对象的(对象id, 属性, 值)的结构相似，也可以用来存储对象。  string + json 也可存储对象，但是不够灵活，如果对象某个属性修改频繁，可以考虑 hash</li>
</ol>
<h3 id="4-4-set"><a href="#4-4-set" class="headerlink" title="4.4 set"></a>4.4 set</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// 新增元素</span><br><span class="line">sadd k1 alvin don calvin tyler alvin</span><br><span class="line">// 成员数量</span><br><span class="line">scard k1</span><br><span class="line">// 所有成员</span><br><span class="line">smembers k1</span><br><span class="line">// 删除成员</span><br><span class="line">srem k1 calvin</span><br><span class="line">// 判断成员是否存在</span><br><span class="line">sismember k1 alvin</span><br><span class="line">// 交集</span><br><span class="line">sadd k2 1 2 3 4 5 </span><br><span class="line">sadd k3 4 5 6 7 8 </span><br><span class="line">// 如果结果需要存入redis，需要客户端取出结果后，再 sadd </span><br><span class="line">sinter k2 k3</span><br><span class="line">// 减少了一个数据的交互过程</span><br><span class="line">sinterstore destkey k2 k3</span><br><span class="line">smembers destkey</span><br><span class="line">// 并集</span><br><span class="line">sunion k2 k3</span><br><span class="line">sunionstore destkey1 k2 k3</span><br><span class="line">smembers destkey1</span><br><span class="line">// 差集</span><br><span class="line">sdiff k2 k3</span><br><span class="line">sdiff k3 k2</span><br><span class="line">sdiffstore destkey k2 k3</span><br><span class="line">// 随机事件</span><br><span class="line">sadd k1 tom ooxx xxoo xoxo oxox xoox oxxo</span><br><span class="line">// 随机取出3个元素，元素不同。每个人最多中一次奖品</span><br><span class="line">srandmember k1 3</span><br><span class="line">// 随机取出3个元素，元素可能相同。可能一个人中两个奖品</span><br><span class="line">srandmember k1 -3</span><br><span class="line">// 取出并删除2个元素。年会抽奖（抽出去后不放回来）</span><br><span class="line">spop k1 2</span><br><span class="line">// 移动</span><br><span class="line">smove k1 k2 alvin</span><br><span class="line">// 分页查询</span><br><span class="line">sscan k1 0 count 2</span><br></pre></td></tr></table></figure>

<h4 id="4-4-1-set-应用场景"><a href="#4-4-1-set-应用场景" class="headerlink" title="4.4.1 set 应用场景"></a>4.4.1 set 应用场景</h4><ol>
<li>好友/关注/粉丝/感兴趣的人集合 <ol>
<li> sinter 命令可以获得 A 和 B 两个用户的共同好友 </li>
<li> sismember 命令可以判断A是否是B的好友 </li>
<li> scard 命令可以获取好友数量 </li>
<li> 关注时，move 命令可以将 B从 A 的粉丝集合转移到 A 的好友集合 </li>
</ol>
</li>
<li> 随机展示 </li>
<li> 黑名单/白名单： sismember 判断是否在黑名单、白名单</li>
</ol>
<h3 id="4-5-sorted-set"><a href="#4-5-sorted-set" class="headerlink" title="4.5 sorted_set"></a>4.5 sorted_set</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">// 新增元素。nx/xx ch incr</span><br><span class="line">zadd k1 8 apple 2 banana 3 orange</span><br><span class="line">// 元素数量</span><br><span class="line">zcard k1</span><br><span class="line">// 指定分值之间的元素个数</span><br><span class="line">zcount k1 10 50</span><br><span class="line">// 增加元素分值</span><br><span class="line">zincrby k1 10 apple</span><br><span class="line">// 字母排序</span><br><span class="line">zlexcount k1 - +</span><br><span class="line">// 返回并删除</span><br><span class="line">zpopmax k1 2</span><br><span class="line">zpopmin k1 2</span><br><span class="line">// 索引范围查询</span><br><span class="line">zrange k1 0 -1</span><br><span class="line">zrange k1 0 -1 withscores</span><br><span class="line">// 价格由低到高取出前两名</span><br><span class="line">zrange k1 0 1</span><br><span class="line">// 价格由高到底前两名</span><br><span class="line">zrevrange k1 0 1</span><br><span class="line">// 字母排序</span><br><span class="line">zrangebylex k1 - +</span><br><span class="line">zrevrangebylex k1 10 50</span><br><span class="line">// 分值范围查询</span><br><span class="line">zrangebyscore k1 10 50</span><br><span class="line">zrevrangebyscore k1 10 50</span><br><span class="line">// 从一个或多个<span class="built_in">set</span>中返回并删除分值最高的元素，block 命令</span><br><span class="line">bzpopmax k1 k2 0</span><br><span class="line">// 同上，返回最小</span><br><span class="line">bzpopmin k1 k2 0</span><br><span class="line">// 取出分值</span><br><span class="line">zscore k1 apple</span><br><span class="line">// 取出排名</span><br><span class="line">zrank k1 apple</span><br><span class="line">// 倒数第几名</span><br><span class="line">zrevrank k1 apple</span><br><span class="line">// 修改分值(会自动刷新顺序)</span><br><span class="line">// 实现歌曲排名</span><br><span class="line">zincrby k1 2.5 banana</span><br><span class="line">// 删除元素</span><br><span class="line">zrem k1 apple banana</span><br><span class="line">// 字母排序</span><br><span class="line">zremreangebylex k1 - +</span><br><span class="line">// 根据排名删除</span><br><span class="line">zremrangebyrank k1 1 3</span><br><span class="line">// 根据分值删除</span><br><span class="line">zremrangebyscore k1 10 50</span><br><span class="line">// 交集</span><br><span class="line">zadd k1 80 tom 60 sean 70 baby</span><br><span class="line">zadd k2 60 tom 100 sean 40 yiming</span><br><span class="line">zinterstore unkey 2 k1 k2</span><br><span class="line">zinterstore unkey1 2 k1 k2 weights 1 0.5</span><br><span class="line">zinterstore unkey2 2 k1 k2 aggregate max</span><br><span class="line">// 并集</span><br><span class="line">zadd k1 80 tom 60 sean 70 baby</span><br><span class="line">zadd k2 60 tom 100 sean 40 yiming</span><br><span class="line">zunionstore unkey 2 k1 k2</span><br><span class="line">zunionstore unkey1 2 k1 k2 weights 1 0.5</span><br><span class="line">zunionstore unkey2 2 k1 k2 aggregate max</span><br><span class="line">// 遍历</span><br><span class="line">zscan</span><br></pre></td></tr></table></figure>

<h4 id="4-5-1-sorted-set-使用场景"><a href="#4-5-1-sorted-set-使用场景" class="headerlink" title="4.5.1 sorted set 使用场景"></a>4.5.1 sorted set 使用场景</h4><p>排名、热点话题。</p>
<h4 id="4-5-2-字典规则-lexicographical"><a href="#4-5-2-字典规则-lexicographical" class="headerlink" title="4.5.2 字典规则  lexicographical"></a>4.5.2 字典规则  lexicographical</h4><p>根据字典顺序比较大小。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ZADD myzset1 0 aaa 0 b 0 c 0 d 0 e</span><br><span class="line">ZADD myzset1 0 foo 0 zap 0 zip 0 ALPHA 0 alpha</span><br><span class="line">// 和 zrange myzset 0 -1 等价</span><br><span class="line">zrangebylex myzset - +</span><br><span class="line">ZRANGEBYLEX myzset1 [alpha [omega</span><br><span class="line">ZRANGEBYLEX myzset1 [alpha [fmaga</span><br><span class="line">ZRANGEBYLEX myzset1 [alpha [f</span><br><span class="line">ZRANGEBYLEX myzset1 [alpha [fop</span><br></pre></td></tr></table></figure>

<p>使用场景</p>
<ul>
<li>电话号码排序<ul>
<li>获取所有号码：ZRANGEBYLEX phone - +</li>
<li>获取132号段：ZRANGEBYLEX phone [132 (133</li>
</ul>
</li>
<li>姓名排序<ul>
<li>获取所有人名字：ZRANGEBYLEX phone [132 (133</li>
<li> A开头的所有人 ：ZRANGEBYLEX names [A (B</li>
</ul>
</li>
</ul>
<p><strong>问题：</strong>sorted_set 排序是怎么实现的，增删改查的速度怎么样？</p>
<p><strong>答案：跳跃表</strong>实现的。平均事件复杂度：O(logN)</p>
<h4 id="4-5-3-跳跃表"><a href="#4-5-3-跳跃表" class="headerlink" title="4.5.3 跳跃表"></a>4.5.3 跳跃表</h4><p>单链表查询的事件复杂度是 O(n) 而且很难优化了。所以引入跳跃表，跳跃表是基于概率的，时间复杂度是  O(logn) 。</p>
<p><img src="../../images/redis1/%E8%B7%B3%E8%B7%83%E8%A1%A8.png"></p>
<h2 id="5-Redis-通用指令"><a href="#5-Redis-通用指令" class="headerlink" title="5. Redis 通用指令"></a>5. Redis 通用指令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// OK</span><br><span class="line">del k1 k2</span><br><span class="line">// OK 返回序列化。有何用处？</span><br><span class="line">dump k1</span><br><span class="line">// OK</span><br><span class="line">exists k1</span><br><span class="line">// OK</span><br><span class="line">expire k1 20</span><br><span class="line">// OK 到达指定时间戳过期</span><br><span class="line">expireat k1 timestamp</span><br><span class="line">// OK 设置毫秒</span><br><span class="line">pexpire k1 2000</span><br><span class="line">// </span><br><span class="line">pexpireat k1 milliseconds-timestamp</span><br><span class="line">// OK 取消过期时间</span><br><span class="line">persist k1</span><br><span class="line">// OK 查看剩余多少秒过期</span><br><span class="line">ttl k1</span><br><span class="line">// OK 查看剩余多少毫秒过期</span><br><span class="line">pttl k1</span><br><span class="line">// OK</span><br><span class="line">keys *</span><br><span class="line">// </span><br><span class="line">migrate 127.0.0.1 6379 k1 | db10 2000</span><br><span class="line">// OK</span><br><span class="line">move k1 db 10</span><br><span class="line">// OK</span><br><span class="line">object encoding/freq/idletime/refcount</span><br><span class="line">// OK</span><br><span class="line">randomkey</span><br><span class="line">// OK</span><br><span class="line">rename k1 newkey</span><br><span class="line">// OK</span><br><span class="line">renamenx k1 newkey</span><br><span class="line">// </span><br><span class="line">restore </span><br><span class="line">// OK 迭代</span><br><span class="line">scan 0</span><br><span class="line">//</span><br><span class="line">sort</span><br><span class="line">// OK 更新访问时间</span><br><span class="line">touch</span><br><span class="line">// OK</span><br><span class="line"><span class="built_in">type</span> k1</span><br><span class="line">// OK 异步删除 k1 k2</span><br><span class="line">unlink k1 k2</span><br><span class="line">// </span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<h3 id="5-1-scan-命令理解"><a href="#5-1-scan-命令理解" class="headerlink" title="5.1 scan 命令理解"></a>5.1 scan 命令理解</h3><p>SCAN 命令及其相关的 SSCAN, HSCAN 和 ZSCAN 命令都用于增量迭代一个集合元素。</p>
<p>他们都支持增量式迭代，它们每次执行都只会返回少量元素，所以这些命令可以用于生产环境，而不会出现像 KEYS 或者 SMEMBERS 命令带来的<strong>可能会阻塞服务器</strong>的问题。相对的有一个缺点，就是 scan 在迭代过程中，集合元素可能会被修改，对返回的值无法提供完全的保证。</p>
<p>scan 是基于游标的迭代器。每次迭代需要上次迭代返回的游标。游标为 0 表示一个新的迭代；服务器返回 0 时表示迭代结束。</p>
<p>问题：</p>
<ul>
<li> 同一个元素可能会被返回多次 </li>
<li> 如果一个元素是在迭代过程中被添加到数据集的， 又或者是在迭代过程中从数据集中被删除的， 那么这个元素可能会被返回， 也可能不会。 </li>
<li> SCAN增量式迭代命令并不保证每次执行都返回某个给定数量的元素,甚至可能会返回零个元素， 但只要命令返回的游标不是 0 ， 应用程序就不应该将迭代视作结束。 </li>
</ul>
<h2 id="6-学习地址记录"><a href="#6-学习地址记录" class="headerlink" title="6. 学习地址记录"></a>6. 学习地址记录</h2><ul>
<li>redis 中文： <a href="http://redis.cn/">http://redis.cn/</a> </li>
<li>redis 官网： <a href="https://redis.io/">https://redis.io/</a> </li>
<li>数据库排名： <a href="https://db-engines.com/en/">https://db-engines.com/en/</a></li>
<li>bitfield 理解：<a href="https://blog.csdn.net/qq_36535196/article/details/103819697">https://blog.csdn.net/qq_36535196/article/details/103819697</a> </li>
<li>跳跃表理解：<ul>
<li> <a href="https://blog.csdn.net/qpzkobe/article/details/80056807">https://blog.csdn.net/qpzkobe/article/details/80056807</a> </li>
<li><a href="https://redisbook.readthedocs.io/en/latest/internal-datastruct/skiplist.html">https://redisbook.readthedocs.io/en/latest/internal-datastruct/skiplist.html</a> </li>
<li> <a href="https://www.jianshu.com/p/dc252b5efca6">https://www.jianshu.com/p/dc252b5efca6</a> </li>
</ul>
</li>
</ul>
</div><div class="tags"><a href="/tags/Redis/"><i class="fa fa-tag"></i>Redis</a></div><div class="post-nav"><a class="pre" href="/2020-02-19-202002/Redis%20%E5%AD%A6%E4%B9%A0(%E4%BA%8C)-%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD.html">Redis 学习(二)-管道、发布/订阅、事务、modules、过期</a><a class="next" href="/2020-01-18-%E7%96%AF%E7%8B%82Java%E8%AE%B2%E4%B9%89/%E7%96%AF%E7%8B%82Java%E8%AE%B2%E4%B9%89C18.html">第 18 章 类加载机制与反射</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IO/">IO</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud/">Spring Cloud</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Srping-Boot/">Srping Boot</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%8A%80%E6%9C%AF/">加解密技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%89%E4%BB%96/">吉他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BF%83%E6%83%85/">心情</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A0%E5%85%B3%E6%8A%80%E6%9C%AF/">无关技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%96%AF%E7%8B%82-Java-%E8%AE%B2%E4%B9%89/">疯狂 Java 讲义</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/%E5%BF%83%E6%83%85/" style="font-size: 15px;">心情</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/SFTP/" style="font-size: 15px;">SFTP</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Samba/" style="font-size: 15px;">Samba</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/Srping-Boot/" style="font-size: 15px;">Srping Boot</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/%E5%90%89%E4%BB%96/" style="font-size: 15px;">吉他</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">多线程</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a> <a href="/tags/%E6%97%A0%E5%85%B3%E6%8A%80%E6%9C%AF/" style="font-size: 15px;">无关技术</a> <a href="/tags/%E7%96%AF%E7%8B%82-Java-%E8%AE%B2%E4%B9%89/" style="font-size: 15px;">疯狂 Java 讲义</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Observer/" style="font-size: 15px;">Observer</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/Singleton/" style="font-size: 15px;">Singleton</a> <a href="/tags/Proxy/" style="font-size: 15px;">Proxy</a> <a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/LVS/" style="font-size: 15px;">LVS</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">网络</a> <a href="/tags/Eureka/" style="font-size: 15px;">Eureka</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">前端</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.jamespan.me/" title="小鶸の道场" target="_blank">小鶸の道场</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a><ul></ul><a href="https://www.cnblogs.com/jingmoxukong/" title="静默虚空" target="_blank">静默虚空</a><ul></ul><a href="https://blog.hushhw.cn/" title="hushhw" target="_blank">hushhw</a><ul></ul><a href="https://hasaik.com/" title="hasaik" target="_blank">hasaik</a><ul></ul><a href="https://www.imalan.cn/" title="三无计划" target="_blank">三无计划</a><ul></ul><a href="https://i-meto.com/" title="meto" target="_blank">meto</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">悟空.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>